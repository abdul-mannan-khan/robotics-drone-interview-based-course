<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week 9: EGO-Planner &amp; Trajectory Optimization</title>
<script>
MathJax = {
    tex: { inlineMath: [['\\(', '\\)']], displayMath: [['\\[', '\\]']] },
    svg: { fontCache: 'global' }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
<style>
@page { size: A4; margin: 2cm; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
.page { width: 21cm; min-height: 29.7cm; padding: 2cm; margin: 20px auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
.header h1 { font-size: 2.5em; margin-bottom: 10px; }
.header p { font-size: 1.2em; opacity: 0.9; }
h2 { color: #667eea; border-bottom: 3px solid #764ba2; padding-bottom: 10px; margin: 30px 0 20px 0; font-size: 1.8em; }
h3 { color: #764ba2; margin: 25px 0 15px 0; font-size: 1.4em; }
h4 { color: #667eea; margin: 20px 0 10px 0; font-size: 1.2em; }
.info-box { background: #e8f4f8; border-left: 5px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 5px; }
.warning-box { background: #fff4e6; border-left: 5px solid #ff9800; padding: 20px; margin: 20px 0; border-radius: 5px; }
.activity-box { background: #f0f8ff; border: 3px solid #4CAF50; padding: 25px; margin: 30px 0; border-radius: 10px; }
.activity-box h3 { color: #4CAF50; margin-top: 0; }
.image-container { text-align: center; margin: 30px 0; }
.image-container img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.image-caption { font-style: italic; color: #666; margin-top: 10px; font-size: 0.9em; }
ul, ol { margin: 15px 0 15px 30px; }
li { margin: 8px 0; }
.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
.two-column > * { min-width: 0; overflow: hidden; }
.three-column { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
.three-column > * { min-width: 0; overflow: hidden; }
.checklist { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
.checklist li { list-style: none; padding: 8px 0; }
.checklist li:before { content: "\2713 "; color: #4CAF50; font-weight: bold; margin-right: 10px; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; table-layout: fixed; word-wrap: break-word; }
th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
th { background: #667eea; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
td code { word-break: break-all; }
.diagram { border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin: 20px 0; background: white; }
.flow-step { background: #667eea; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: bold; }
.arrow { text-align: center; font-size: 2em; color: #764ba2; margin: 5px 0; }
.tip { background: #fffbea; border-left: 5px solid #ffd700; padding: 15px; margin: 15px 0; border-radius: 5px; }
.tip:before { content: "\1F4A1 TIP: "; font-weight: bold; color: #ff9800; }
code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; word-break: break-all; }
pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; max-width: 100%; white-space: pre-wrap; word-wrap: break-word; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.5; }
.example-box { background: #f0fff0; border: 2px dashed #4CAF50; padding: 20px; margin: 20px 0; border-radius: 8px; }
.math { padding: 15px; margin: 15px 0; border-radius: 5px; overflow-x: auto; max-width: 100%; }
.sensor-card { background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; text-align: center; }
.sensor-card h4 { color: #667eea; margin-bottom: 10px; }
img { max-width: 100%; height: auto; }
svg { max-width: 100%; height: auto; }
</style>
</head>
<body>

<!-- PAGE 1 -->
<div class="page">
<div class="header">
<h1>EGO-Planner &amp; Trajectory Optimization</h1>
<p>Week 9 -- Robotics &amp; Drone Engineering Robotics &amp; Drone Engineering M.Sc.</p>
<p>Dr. Abdul Manan Khan -- Open Robotics Course</p>
</div>

<div class="image-container">
<svg viewBox="0 0 800 340" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<defs>
<linearGradient id="sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#1a1a4e"/><stop offset="100%" stop-color="#3a3a8e"/></linearGradient>
<linearGradient id="obs" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ff6b6b"/><stop offset="100%" stop-color="#c0392b"/></linearGradient>
</defs>
<rect width="800" height="340" rx="12" fill="url(#sky)"/>
<!-- obstacles -->
<rect x="180" y="80" width="60" height="180" rx="8" fill="url(#obs)" opacity="0.8"/>
<rect x="350" y="50" width="50" height="220" rx="8" fill="url(#obs)" opacity="0.8"/>
<rect x="520" y="100" width="70" height="160" rx="8" fill="url(#obs)" opacity="0.8"/>
<!-- trajectory -->
<path d="M60,170 C120,170 150,100 210,60 C270,20 310,140 380,130 C450,120 480,230 560,200 C620,180 680,150 750,160" fill="none" stroke="#00e676" stroke-width="4" stroke-dasharray="12,6"/>
<!-- control points -->
<circle cx="60" cy="170" r="6" fill="#ffd700"/><circle cx="210" cy="60" r="6" fill="#ffd700"/>
<circle cx="380" cy="130" r="6" fill="#ffd700"/><circle cx="560" cy="200" r="6" fill="#ffd700"/>
<circle cx="750" cy="160" r="6" fill="#ffd700"/>
<!-- drone -->
<g transform="translate(60,150)">
<rect x="-18" y="-5" width="36" height="10" rx="3" fill="#e0e0e0"/>
<line x1="-22" y1="-5" x2="-30" y2="-14" stroke="#aaa" stroke-width="2"/>
<line x1="22" y1="-5" x2="30" y2="-14" stroke="#aaa" stroke-width="2"/>
<circle cx="-30" cy="-16" r="8" fill="none" stroke="#00e676" stroke-width="2"/>
<circle cx="30" cy="-16" r="8" fill="none" stroke="#00e676" stroke-width="2"/>
</g>
<text x="400" y="310" text-anchor="middle" fill="white" font-size="18" font-family="Segoe UI">Real-time ESDF-free Trajectory Optimization for Agile Quadrotors</text>
<text x="400" y="335" text-anchor="middle" fill="#aaa" font-size="12" font-family="Segoe UI">ZJU FAST Lab -- EGO-Planner Pipeline</text>
</svg>
<p class="image-caption">Figure 1: EGO-Planner navigates a drone through obstacles using optimized B-spline trajectories without building an ESDF map.</p>
</div>

<div class="info-box">
<strong>Module:</strong> - Robotics &amp; Drone Engineering | <strong>Week:</strong> 9 of 12<br>
<strong>Prerequisites:</strong> Weeks 1-8 (ROS 2, motion planning fundamentals, PX4 basics)<br>
<strong>Lab:</strong> EGO-Planner simulation with obstacle-rich environments
</div>

<h3>About This Week</h3>
<p>This lecture introduces <strong>EGO-Planner</strong>, a state-of-the-art trajectory optimization framework developed by the <strong>FAST Lab at Zhejiang University (ZJU)</strong>. Unlike traditional planners that require expensive Euclidean Signed Distance Fields, EGO-Planner achieves real-time performance by directly penalising collisions on B-spline control points. We will study the mathematical foundations, the optimisation pipeline, and multi-drone extensions (EGO-Swarm).</p>
</div>

<!-- PAGE 2 -->
<div class="page">
<h2>Learning Objectives</h2>

<div class="two-column">
<div>
<h4>Knowledge &amp; Understanding</h4>
<ol>
<li>Explain the difference between path planning and trajectory optimization</li>
<li>Describe the mathematical formulation of B-spline curves for drone trajectories</li>
<li>Articulate why ESDF-free collision checking is advantageous</li>
<li>Discuss the EGO-Planner cost function and its three components</li>
<li>Outline the EGO-Swarm decentralised multi-drone architecture</li>
</ol>
</div>
<div>
<h4>Practical Skills</h4>
<ol>
<li>Configure and launch EGO-Planner in a ROS 2 simulation</li>
<li>Tune optimisation weights for different flight scenarios</li>
<li>Analyse trajectory smoothness, collision clearance, and dynamic feasibility</li>
<li>Extend EGO-Planner for multi-drone coordination</li>
<li>Benchmark planning times and trajectory quality</li>
</ol>
</div>
</div>

<h3>Why Trajectory Optimisation Matters for Drones</h3>

<div class="image-container">
<svg viewBox="0 0 760 220" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="760" height="220" rx="10" fill="#f8f9ff"/>
<rect x="20" y="30" width="220" height="160" rx="8" fill="#fff" stroke="#667eea" stroke-width="2"/>
<text x="130" y="60" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Path Planning</text>
<text x="130" y="90" text-anchor="middle" fill="#555" font-size="12">Geometric only</text>
<text x="130" y="110" text-anchor="middle" fill="#555" font-size="12">No time, no dynamics</text>
<text x="130" y="130" text-anchor="middle" fill="#555" font-size="12">Piecewise-linear</text>
<text x="130" y="155" text-anchor="middle" fill="#c0392b" font-size="12">Not flyable as-is</text>

<text x="280" y="115" text-anchor="middle" fill="#764ba2" font-size="28" font-weight="bold">&rarr;</text>

<rect x="310" y="30" width="220" height="160" rx="8" fill="#fff" stroke="#764ba2" stroke-width="2"/>
<text x="420" y="60" text-anchor="middle" fill="#764ba2" font-weight="bold" font-size="14">Trajectory Optimisation</text>
<text x="420" y="90" text-anchor="middle" fill="#555" font-size="12">Smooth (C2+)</text>
<text x="420" y="110" text-anchor="middle" fill="#555" font-size="12">Time-parameterised</text>
<text x="420" y="130" text-anchor="middle" fill="#555" font-size="12">Dynamically feasible</text>
<text x="420" y="155" text-anchor="middle" fill="#27ae60" font-size="12">Directly executable</text>

<text x="570" y="115" text-anchor="middle" fill="#764ba2" font-size="28" font-weight="bold">&rarr;</text>

<rect x="600" y="30" width="140" height="160" rx="8" fill="#fff" stroke="#4CAF50" stroke-width="2"/>
<text x="670" y="60" text-anchor="middle" fill="#4CAF50" font-weight="bold" font-size="14">Agile Flight</text>
<text x="670" y="90" text-anchor="middle" fill="#555" font-size="12">5-10 m/s</text>
<text x="670" y="110" text-anchor="middle" fill="#555" font-size="12">Real-time replan</text>
<text x="670" y="130" text-anchor="middle" fill="#555" font-size="12">Obstacle-dense</text>
<text x="670" y="155" text-anchor="middle" fill="#555" font-size="12">Multi-drone</text>
</svg>
<p class="image-caption">Figure 2: Evolution from geometric path planning to real-time trajectory optimisation for agile drone flight.</p>
</div>

<p>Quadrotors are <strong>differentially flat</strong> systems: their full state can be recovered from a smooth position trajectory and yaw angle. This means that if we can produce a sufficiently smooth, dynamically feasible trajectory in position space, the attitude commands follow automatically. Trajectory optimisation exploits this by searching directly in the space of smooth curves.</p>

<div class="info-box">
<strong>Real-Time Requirement:</strong> In cluttered environments at 5 m/s, a drone covers 1 metre in 200 ms. The planner must replan in under 5-10 ms to stay reactive -- EGO-Planner achieves &lt;1 ms average planning time on embedded hardware.
</div>

<h3>ZJU FAST Lab Contributions</h3>
<div class="image-container">
<svg viewBox="0 0 700 140" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="140" rx="10" fill="#f0f0ff"/>
<rect x="20" y="25" width="140" height="90" rx="8" fill="#667eea"/><text x="90" y="65" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Fast-Planner</text><text x="90" y="85" text-anchor="middle" fill="#ddd" font-size="11">2019 -- ESDF-based</text>
<rect x="190" y="25" width="140" height="90" rx="8" fill="#764ba2"/><text x="260" y="65" text-anchor="middle" fill="white" font-size="13" font-weight="bold">EGO-Planner</text><text x="260" y="85" text-anchor="middle" fill="#ddd" font-size="11">2020 -- ESDF-free</text>
<rect x="360" y="25" width="140" height="90" rx="8" fill="#4CAF50"/><text x="430" y="65" text-anchor="middle" fill="white" font-size="13" font-weight="bold">EGO-Swarm</text><text x="430" y="85" text-anchor="middle" fill="#ddd" font-size="11">2021 -- Multi-drone</text>
<rect x="530" y="25" width="150" height="90" rx="8" fill="#ff9800"/><text x="605" y="65" text-anchor="middle" fill="white" font-size="13" font-weight="bold">EGO-Planner v2</text><text x="605" y="85" text-anchor="middle" fill="#ddd" font-size="11">2022 -- Full SE(3)</text>
</svg>
<p class="image-caption">Figure 3: Timeline of ZJU FAST Lab trajectory planning frameworks.</p>
</div>
</div>

<!-- PAGE 3 -->
<div class="page">
<h2>From Path Planning to Trajectory Optimisation</h2>

<h3>Path vs. Trajectory</h3>
<p>A <strong>path</strong> is a purely geometric object -- a set of positions in space with no notion of time. A <strong>trajectory</strong> assigns time to each point along the path, yielding velocity, acceleration, and higher derivatives. For a quadrotor, only trajectories can be executed because the controller needs smooth references.</p>

<div class="image-container">
<svg viewBox="0 0 750 280" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="280" rx="10" fill="#fafafa"/>
<!-- Waypoints -->
<text x="125" y="25" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Waypoints</text>
<circle cx="50" cy="140" r="8" fill="#667eea"/><circle cx="100" cy="80" r="8" fill="#667eea"/>
<circle cx="160" cy="120" r="8" fill="#667eea"/><circle cx="200" cy="60" r="8" fill="#667eea"/>
<text x="50" y="170" text-anchor="middle" fill="#888" font-size="10">w0</text>
<text x="100" y="105" text-anchor="middle" fill="#888" font-size="10">w1</text>
<text x="160" y="145" text-anchor="middle" fill="#888" font-size="10">w2</text>
<text x="200" y="85" text-anchor="middle" fill="#888" font-size="10">w3</text>

<text x="260" y="110" text-anchor="middle" fill="#764ba2" font-size="24" font-weight="bold">&rarr;</text>

<!-- Piecewise path -->
<text x="380" y="25" text-anchor="middle" fill="#764ba2" font-weight="bold" font-size="14">Piecewise Path</text>
<polyline points="305,140 355,80 415,120 455,60" fill="none" stroke="#764ba2" stroke-width="3"/>
<circle cx="305" cy="140" r="5" fill="#764ba2"/><circle cx="355" cy="80" r="5" fill="#764ba2"/>
<circle cx="415" cy="120" r="5" fill="#764ba2"/><circle cx="455" cy="60" r="5" fill="#764ba2"/>
<text x="385" y="165" text-anchor="middle" fill="#c0392b" font-size="11">Sharp corners = infinite acceleration!</text>

<text x="510" y="110" text-anchor="middle" fill="#764ba2" font-size="24" font-weight="bold">&rarr;</text>

<!-- Smooth trajectory -->
<text x="640" y="25" text-anchor="middle" fill="#4CAF50" font-weight="bold" font-size="14">Smooth Trajectory</text>
<path d="M555,140 C585,100 600,70 630,80 C660,90 680,110 710,60" fill="none" stroke="#4CAF50" stroke-width="3"/>
<circle cx="555" cy="140" r="5" fill="#4CAF50"/><circle cx="710" cy="60" r="5" fill="#4CAF50"/>
<text x="640" y="165" text-anchor="middle" fill="#27ae60" font-size="11">Continuous velocity &amp; acceleration</text>

<!-- Lower diagrams: velocity profiles -->
<text x="125" y="210" text-anchor="middle" fill="#888" font-size="12">No velocity info</text>
<line x1="40" y1="220" x2="210" y2="220" stroke="#ddd" stroke-width="1"/>

<text x="380" y="210" text-anchor="middle" fill="#888" font-size="12">Velocity profile</text>
<polyline points="305,260 330,230 354,260 380,230 415,260 455,230" fill="none" stroke="#c0392b" stroke-width="2"/>
<text x="380" y="275" text-anchor="middle" fill="#c0392b" font-size="10">Discontinuous!</text>

<text x="640" y="210" text-anchor="middle" fill="#888" font-size="12">Velocity profile</text>
<path d="M555,255 C585,230 620,240 650,225 C680,235 700,240 710,230" fill="none" stroke="#27ae60" stroke-width="2"/>
<text x="640" y="275" text-anchor="middle" fill="#27ae60" font-size="10">Smooth &amp; bounded</text>
</svg>
<p class="image-caption">Figure 4: Progression from discrete waypoints to a piecewise path to a smooth, dynamically feasible trajectory.</p>
</div>

<h3>Why Smooth Trajectories Matter for Quadrotors</h3>
<div class="two-column">
<div>
<h4>Differential Flatness</h4>
<p>A quadrotor's state (position, velocity, attitude, angular rate) can be fully determined from four flat outputs:</p>
<div class="math">\[ \sigma = [x, y, z, \psi]^T \]</div>
<p>where \(\psi\) is yaw. If \(\sigma(t)\) is \(C^4\) smooth, the full state trajectory and inputs (rotor speeds) are well-defined. This is why trajectory smoothness is not just aesthetic -- it is a <strong>physical necessity</strong>.</p>
</div>
<div>
<h4>Dynamic Feasibility</h4>
<p>The trajectory must satisfy the drone's physical limits:</p>
<ul>
<li><strong>Velocity:</strong> \(\|\dot{\mathbf{p}}(t)\| \le v_{max}\)</li>
<li><strong>Acceleration:</strong> \(\|\ddot{\mathbf{p}}(t)\| \le a_{max}\)</li>
<li><strong>Jerk:</strong> \(\|\dddot{\mathbf{p}}(t)\| \le j_{max}\)</li>
<li><strong>Snap:</strong> bounded for motor feasibility</li>
</ul>
<p>Violating these causes tracking errors, instability, or motor saturation.</p>
</div>
</div>

<div class="info-box">
<strong>Key Insight:</strong> Trajectory optimisation unifies three goals into one mathematical framework -- (1) obstacle avoidance, (2) smoothness, and (3) dynamic feasibility -- all solved simultaneously via gradient-based optimisation on B-spline control points.
</div>
</div>

<!-- PAGE 4 -->
<div class="page">
<h2>B-Spline Fundamentals</h2>

<h3>Definition</h3>
<p>A <strong>B-spline curve</strong> of degree \(p\) with \(n+1\) control points \(\mathbf{Q}_0, \ldots, \mathbf{Q}_n\) and knot vector \(\mathbf{t} = [t_0, t_1, \ldots, t_{n+p+1}]\) is defined as:</p>

<div class="math">
\[ \mathbf{p}(t) = \sum_{i=0}^{n} N_{i,p}(t) \, \mathbf{Q}_i \]
</div>

<p>where \(N_{i,p}(t)\) are the <strong>B-spline basis functions</strong> defined recursively:</p>

<div class="math">
\[ N_{i,0}(t) = \begin{cases} 1 & \text{if } t_i \le t < t_{i+1} \\ 0 & \text{otherwise} \end{cases} \]
\[ N_{i,p}(t) = \frac{t - t_i}{t_{i+p} - t_i} N_{i,p-1}(t) + \frac{t_{i+p+1} - t}{t_{i+p+1} - t_{i+1}} N_{i+1,p-1}(t) \]
</div>

<h3>Basis Functions and Control Points</h3>
<div class="image-container">
<svg viewBox="0 0 750 300" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="300" rx="10" fill="#fafafa"/>
<!-- Left: basis functions -->
<text x="190" y="25" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Cubic B-Spline Basis Functions</text>
<line x1="40" y1="250" x2="360" y2="250" stroke="#333" stroke-width="2"/>
<line x1="40" y1="50" x2="40" y2="250" stroke="#333" stroke-width="2"/>
<text x="200" y="275" text-anchor="middle" fill="#555" font-size="12">Parameter t</text>
<text x="25" y="150" text-anchor="middle" fill="#555" font-size="12" transform="rotate(-90,25,150)">N(t)</text>
<!-- Basis function curves (simplified bell shapes) -->
<path d="M40,250 C60,250 70,80 120,80 C170,80 180,250 200,250" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
<path d="M100,250 C120,250 130,100 180,100 C230,100 240,250 260,250" fill="none" stroke="#3498db" stroke-width="2.5"/>
<path d="M160,250 C180,250 190,120 240,120 C290,120 300,250 320,250" fill="none" stroke="#2ecc71" stroke-width="2.5"/>
<path d="M220,250 C240,250 250,90 300,90 C350,90 350,250 360,250" fill="none" stroke="#f39c12" stroke-width="2.5"/>
<text x="120" y="70" fill="#e74c3c" font-size="11">N0,3</text>
<text x="180" y="90" fill="#3498db" font-size="11">N1,3</text>
<text x="240" y="110" fill="#2ecc71" font-size="11">N2,3</text>
<text x="300" y="80" fill="#f39c12" font-size="11">N3,3</text>

<!-- Right: control polygon and curve -->
<text x="570" y="25" text-anchor="middle" fill="#764ba2" font-weight="bold" font-size="14">Control Points &amp; Curve</text>
<polyline points="410,200 470,60 550,100 620,50 700,180" fill="none" stroke="#aaa" stroke-width="1.5" stroke-dasharray="6,4"/>
<circle cx="410" cy="200" r="7" fill="#667eea"/><text x="395" y="220" fill="#667eea" font-size="11">Q0</text>
<circle cx="470" cy="60" r="7" fill="#667eea"/><text x="455" y="50" fill="#667eea" font-size="11">Q1</text>
<circle cx="550" cy="100" r="7" fill="#667eea"/><text x="535" y="90" fill="#667eea" font-size="11">Q2</text>
<circle cx="620" cy="50" r="7" fill="#667eea"/><text x="605" y="40" fill="#667eea" font-size="11">Q3</text>
<circle cx="700" cy="180" r="7" fill="#667eea"/><text x="685" y="200" fill="#667eea" font-size="11">Q4</text>
<path d="M425,175 C450,100 480,75 510,85 C540,95 570,80 600,70 C640,55 670,100 690,170" fill="none" stroke="#764ba2" stroke-width="3"/>
<text x="570" y="285" text-anchor="middle" fill="#888" font-size="11">The curve is attracted to but does not pass through interior control points</text>
</svg>
<p class="image-caption">Figure 5: (Left) Cubic B-spline basis functions with local support. (Right) Control polygon and resulting smooth curve.</p>
</div>

<h3>Knot Vectors</h3>
<p>The <strong>knot vector</strong> \(\mathbf{t}\) determines where each basis function is active. For a <strong>uniform</strong> B-spline, knots are equally spaced: \(t_i = t_0 + i \cdot \Delta t\). This simplifies computation dramatically, which is why EGO-Planner uses uniform B-splines.</p>

<div class="info-box">
<strong>Degree Choice:</strong> EGO-Planner uses degree \(p = 3\) (cubic) B-splines. This guarantees \(C^2\) continuity (continuous acceleration), which suffices for quadrotor control since the snap (4th derivative) only needs to be bounded, not continuous.
</div>
</div>

<!-- PAGE 5 -->
<div class="page">
<h2>B-Spline Properties for Trajectory Planning</h2>

<h3>Key Properties</h3>
<div class="two-column">
<div class="sensor-card">
<h4>Local Support</h4>
<p>Each basis function \(N_{i,p}(t)\) is nonzero only on the interval \([t_i, t_{i+p+1})\). Moving control point \(\mathbf{Q}_i\) only affects the curve locally.</p>
<p><strong>Benefit:</strong> Local obstacle avoidance modifications do not disturb distant parts of the trajectory.</p>
</div>
<div class="sensor-card">
<h4>Convex Hull Property</h4>
<p>On any knot span \([t_j, t_{j+1})\), the curve lies within the convex hull of the \(p+1\) relevant control points.</p>
<p><strong>Benefit:</strong> If nearby control points are collision-free, the curve segment is guaranteed collision-free.</p>
</div>
</div>

<div class="two-column">
<div class="sensor-card">
<h4>Derivative Computation</h4>
<p>The \(k\)-th derivative of a B-spline of degree \(p\) is itself a B-spline of degree \(p-k\) with new control points derived from differences of original control points.</p>
<div class="math">\[ \mathbf{V}_i = \frac{p}{t_{i+p+1} - t_{i+1}}(\mathbf{Q}_{i+1} - \mathbf{Q}_i) \]</div>
</div>
<div class="sensor-card">
<h4>Continuity Guarantees</h4>
<p>A degree-\(p\) B-spline with simple knots is automatically \(C^{p-1}\) continuous. For cubic (\(p=3\)): \(C^2\) continuity everywhere.</p>
<p><strong>Benefit:</strong> Continuous acceleration without extra constraints.</p>
</div>
</div>

<h3>Why B-Splines Are Ideal for Drone Trajectories</h3>

<div class="image-container">
<svg viewBox="0 0 700 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="200" rx="10" fill="#f8f8ff"/>
<rect x="20" y="20" width="200" height="160" rx="10" fill="#667eea" opacity="0.1" stroke="#667eea" stroke-width="2"/>
<text x="120" y="50" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="13">Polynomial Trajectories</text>
<text x="120" y="80" text-anchor="middle" fill="#555" font-size="11">Global support</text>
<text x="120" y="100" text-anchor="middle" fill="#555" font-size="11">Runge's phenomenon</text>
<text x="120" y="120" text-anchor="middle" fill="#555" font-size="11">Costly re-optimisation</text>
<text x="120" y="145" text-anchor="middle" fill="#c0392b" font-size="11">Not great for replanning</text>

<rect x="250" y="20" width="200" height="160" rx="10" fill="#764ba2" opacity="0.1" stroke="#764ba2" stroke-width="2"/>
<text x="350" y="50" text-anchor="middle" fill="#764ba2" font-weight="bold" font-size="13">Piecewise Polynomials</text>
<text x="350" y="80" text-anchor="middle" fill="#555" font-size="11">Local segments</text>
<text x="350" y="100" text-anchor="middle" fill="#555" font-size="11">Continuity constraints</text>
<text x="350" y="120" text-anchor="middle" fill="#555" font-size="11">Many variables</text>
<text x="350" y="145" text-anchor="middle" fill="#f39c12" font-size="11">Good, but complex</text>

<rect x="480" y="20" width="200" height="160" rx="10" fill="#4CAF50" opacity="0.1" stroke="#4CAF50" stroke-width="2"/>
<text x="580" y="50" text-anchor="middle" fill="#4CAF50" font-weight="bold" font-size="13">B-Splines</text>
<text x="580" y="80" text-anchor="middle" fill="#555" font-size="11">Local support built-in</text>
<text x="580" y="100" text-anchor="middle" fill="#555" font-size="11">Automatic continuity</text>
<text x="580" y="120" text-anchor="middle" fill="#555" font-size="11">Convex hull safety</text>
<text x="580" y="145" text-anchor="middle" fill="#27ae60" font-size="12" font-weight="bold">Best for real-time!</text>
</svg>
<p class="image-caption">Figure 6: Comparison of trajectory representations -- B-splines combine the best of both worlds.</p>
</div>

<div class="info-box">
<strong>Summary of B-Spline Advantages for EGO-Planner:</strong>
<ul>
<li><strong>Local support</strong> &rarr; efficient local replanning in &lt;1 ms</li>
<li><strong>Convex hull</strong> &rarr; collision checking via control points only (no dense sampling)</li>
<li><strong>Derivatives from control points</strong> &rarr; velocity/acceleration limits checked analytically</li>
<li><strong>Built-in smoothness</strong> &rarr; no extra continuity constraints needed</li>
</ul>
</div>

<div class="activity-box">
<h3>Activity 1: B-Spline Intuition</h3>
<p><strong>Duration:</strong> 15 minutes | <strong>Type:</strong> Pen-and-paper + discussion</p>
<ol>
<li>Given control points \(\mathbf{Q}_0=(0,0)\), \(\mathbf{Q}_1=(1,3)\), \(\mathbf{Q}_2=(3,3)\), \(\mathbf{Q}_3=(4,0)\), sketch the approximate cubic B-spline curve.</li>
<li>If you move \(\mathbf{Q}_1\) to \((1,5)\), which portion of the curve changes? Why?</li>
<li>Can the curve ever pass outside the convex hull of all four points? Explain.</li>
<li>What is the continuity class of this curve at interior knots?</li>
</ol>
</div>
</div>

<!-- PAGE 6 -->
<div class="page">
<h2>Uniform B-Splines for Real-Time Planning</h2>

<h3>Simplified Formulation</h3>
<p>For <strong>uniform</strong> B-splines, all knot spans are equal: \(\Delta t = t_{i+1} - t_i = \text{const}\). This allows expressing each curve segment using a fixed matrix multiplication. For a cubic uniform B-spline on the \(i\)-th span with parameter \(s \in [0,1)\):</p>

<div class="math">
\[ \mathbf{p}_i(s) = \frac{1}{6} \begin{bmatrix} 1 & 4 & 1 & 0 \end{bmatrix} + s \cdot \frac{1}{6}\begin{bmatrix} -3 & 0 & 3 & 0 \end{bmatrix} + \ldots \]
</div>

<p>Or equivalently, using the cubic uniform B-spline matrix \(M_s\):</p>

<div class="math">
\[ \mathbf{p}_i(s) = \frac{1}{6} \begin{bmatrix} s^3 & s^2 & s & 1 \end{bmatrix} \underbrace{\begin{bmatrix} -1 & 3 & -3 & 1 \\ 3 & -6 & 3 & 0 \\ -3 & 0 & 3 & 0 \\ 1 & 4 & 1 & 0 \end{bmatrix}}_{M_s} \begin{bmatrix} \mathbf{Q}_{i} \\ \mathbf{Q}_{i+1} \\ \mathbf{Q}_{i+2} \\ \mathbf{Q}_{i+3} \end{bmatrix} \]
</div>

<h3>Velocity and Acceleration from Control Points</h3>
<p>The key advantage for trajectory planning is that derivatives map directly to <strong>control point differences</strong>:</p>

<div class="math">
\[ \dot{\mathbf{p}}_i(s) = \frac{1}{2\Delta t} \begin{bmatrix} s^2 & s & 1 \end{bmatrix} \begin{bmatrix} -1 & 2 & -1 \\ 2 & -4 & 2 \\ -1 & 0 & 1 \end{bmatrix} \begin{bmatrix} \mathbf{Q}_{i} - \mathbf{Q}_{i+1} \\ \mathbf{Q}_{i+1} - \mathbf{Q}_{i+2} \\ \mathbf{Q}_{i+2} - \mathbf{Q}_{i+3} \end{bmatrix} \]
</div>

<p>The velocity at any point depends only on differences \(\mathbf{Q}_{i+1} - \mathbf{Q}_i\). Similarly, acceleration depends on second differences. This means:</p>

<div class="info-box">
<strong>Convex-Hull Speed Bound:</strong> For uniform cubic B-splines, the velocity on any span is bounded by:
\[ \|\dot{\mathbf{p}}(t)\| \le \max\left(\frac{\|\mathbf{Q}_{i+1} - \mathbf{Q}_i\|}{\Delta t}\right) \]
If we ensure each control point difference satisfies the velocity limit, the entire trajectory is dynamically feasible. No dense sampling needed!
</div>

<h3>Summary: Uniform B-Spline Properties for EGO-Planner</h3>
<table>
<tr><th>Property</th><th>Formula / Description</th><th>Benefit</th></tr>
<tr><td>Segment evaluation</td><td>Fixed matrix \(M_s\), 4 control points per span</td><td>O(1) per evaluation</td></tr>
<tr><td>Velocity bound</td><td>\(\|\mathbf{Q}_{i+1}-\mathbf{Q}_i\|/\Delta t \le v_{max}\)</td><td>Analytic feasibility</td></tr>
<tr><td>Acceleration bound</td><td>\(\|\mathbf{Q}_{i+2}-2\mathbf{Q}_{i+1}+\mathbf{Q}_i\|/\Delta t^2 \le a_{max}\)</td><td>Analytic feasibility</td></tr>
<tr><td>Smoothness</td><td>\(C^2\) continuity automatic</td><td>No extra constraints</td></tr>
<tr><td>Local support</td><td>Each control point affects 4 spans</td><td>Fast local replanning</td></tr>
</table>
</div>

<!-- PAGE 7 -->
<div class="page">
<h2>Trajectory Optimisation Framework</h2>

<h3>The Unified Cost Function</h3>
<p>EGO-Planner formulates trajectory optimisation as an <strong>unconstrained minimisation</strong> over B-spline control points \(\mathbf{Q} = \{\mathbf{Q}_0, \ldots, \mathbf{Q}_n\}\):</p>

<div class="math">
\[ J(\mathbf{Q}) = J_{smooth}(\mathbf{Q}) + \lambda_c \, J_{collision}(\mathbf{Q}) + \lambda_d \, J_{dynamic}(\mathbf{Q}) \]
</div>
<p><strong>where:</strong></p>
<ul>
    <li>\( \mathbf{Q} \) — set of B-spline control points to be optimised</li>
    <li>\( J_{smooth} \) — smoothness cost penalising high-order derivatives (jerk/snap)</li>
    <li>\( J_{collision} \) — collision cost penalising proximity to obstacles</li>
    <li>\( J_{dynamic} \) — dynamic feasibility cost penalising velocity/acceleration limit violations</li>
    <li>\( \lambda_c, \lambda_d \) — weighting coefficients balancing the cost terms</li>
</ul>

<p>Each term encodes a critical requirement:</p>

<div class="three-column">
<div class="sensor-card">
<h4>Smoothness Cost \(J_s\)</h4>
<p>Minimises jerk or snap to produce smooth, energy-efficient trajectories.</p>
<p style="color:#667eea;font-weight:bold;">Smooth flight</p>
</div>
<div class="sensor-card">
<h4>Collision Cost \(J_c\)</h4>
<p>Penalises control points that are too close to obstacles. ESDF-free formulation.</p>
<p style="color:#c0392b;font-weight:bold;">Safety</p>
</div>
<div class="sensor-card">
<h4>Dynamic Cost \(J_d\)</h4>
<p>Penalises velocity and acceleration that exceed hardware limits.</p>
<p style="color:#f39c12;font-weight:bold;">Feasibility</p>
</div>
</div>

<h3>Optimisation Pipeline</h3>
<div class="image-container">
<svg viewBox="0 0 750 350" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="350" rx="10" fill="#fafafa"/>
<!-- Pipeline steps -->
<rect x="20" y="20" width="160" height="60" rx="8" fill="#667eea"/>
<text x="100" y="48" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Depth / Point Cloud</text>
<text x="100" y="65" text-anchor="middle" fill="#ddd" font-size="10">Sensor input</text>

<line x1="180" y1="50" x2="210" y2="50" stroke="#764ba2" stroke-width="2" marker-end="url(#arrowM)"/>

<rect x="210" y="20" width="160" height="60" rx="8" fill="#764ba2"/>
<text x="290" y="48" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Occupancy Grid</text>
<text x="290" y="65" text-anchor="middle" fill="#ddd" font-size="10">3D voxel map</text>

<line x1="370" y1="50" x2="400" y2="50" stroke="#764ba2" stroke-width="2"/>

<rect x="400" y="20" width="160" height="60" rx="8" fill="#4CAF50"/>
<text x="480" y="48" text-anchor="middle" fill="white" font-weight="bold" font-size="12">A* / Kinodynamic Search</text>
<text x="480" y="65" text-anchor="middle" fill="#ddd" font-size="10">Front-end path</text>

<line x1="560" y1="50" x2="590" y2="50" stroke="#764ba2" stroke-width="2"/>

<rect x="590" y="20" width="140" height="60" rx="8" fill="#ff9800"/>
<text x="660" y="48" text-anchor="middle" fill="white" font-weight="bold" font-size="12">Initial B-Spline</text>
<text x="660" y="65" text-anchor="middle" fill="#ddd" font-size="10">Fitted to path</text>

<!-- Down arrow -->
<line x1="660" y1="80" x2="660" y2="120" stroke="#764ba2" stroke-width="2"/>
<polygon points="655,120 665,120 660,130" fill="#764ba2"/>

<!-- Optimization box -->
<rect x="100" y="130" width="600" height="120" rx="12" fill="#f0f0ff" stroke="#667eea" stroke-width="2" stroke-dasharray="6,4"/>
<text x="400" y="155" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Back-End: L-BFGS Optimisation</text>

<rect x="130" y="170" width="150" height="50" rx="6" fill="#667eea" opacity="0.2" stroke="#667eea"/>
<text x="205" y="192" text-anchor="middle" fill="#333" font-size="11">Smoothness Cost</text>
<text x="205" y="210" text-anchor="middle" fill="#667eea" font-size="12" font-weight="bold">Js</text>

<rect x="310" y="170" width="150" height="50" rx="6" fill="#c0392b" opacity="0.2" stroke="#c0392b"/>
<text x="385" y="192" text-anchor="middle" fill="#333" font-size="11">Collision Cost</text>
<text x="385" y="210" text-anchor="middle" fill="#c0392b" font-size="12" font-weight="bold">Jc (ESDF-free!)</text>

<rect x="490" y="170" width="150" height="50" rx="6" fill="#f39c12" opacity="0.2" stroke="#f39c12"/>
<text x="565" y="192" text-anchor="middle" fill="#333" font-size="11">Dynamic Cost</text>
<text x="565" y="210" text-anchor="middle" fill="#f39c12" font-size="12" font-weight="bold">Jd</text>

<!-- Down arrow -->
<line x1="400" y1="250" x2="400" y2="290" stroke="#764ba2" stroke-width="2"/>
<polygon points="395,290 405,290 400,300" fill="#764ba2"/>

<rect x="280" y="300" width="200" height="40" rx="8" fill="#4CAF50"/>
<text x="380" y="325" text-anchor="middle" fill="white" font-weight="bold" font-size="13">Optimised Trajectory</text>

<defs><marker id="arrowM" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0,0 8,3 0,6" fill="#764ba2"/></marker></defs>
</svg>
<p class="image-caption">Figure 7: Complete EGO-Planner pipeline from sensor input to optimised trajectory.</p>
</div>

<div class="tip">The weights \(\lambda_c\) and \(\lambda_d\) are crucial tuning parameters. Too much collision weight makes the trajectory jerky; too much smoothness weight may cut corners near obstacles.</div>
</div>

<!-- PAGE 8 -->
<div class="page">
<h2>Smoothness Cost</h2>

<h3>Minimising Jerk for Smooth Flight</h3>
<p>The smoothness cost penalises the integral of squared jerk (or snap) along the trajectory. For uniform B-splines, this maps elegantly to <strong>control point differences</strong>. The third-order difference approximates jerk:</p>

<div class="math">
\[ J_{smooth} = \sum_{i=0}^{n-3} \left\| \mathbf{Q}_{i+3} - 3\mathbf{Q}_{i+2} + 3\mathbf{Q}_{i+1} - \mathbf{Q}_i \right\|^2 \]
</div>

<p>For minimising snap (4th derivative), we use fourth-order differences:</p>

<div class="math">
\[ J_{snap} = \sum_{i=0}^{n-4} \left\| \mathbf{Q}_{i+4} - 4\mathbf{Q}_{i+3} + 6\mathbf{Q}_{i+2} - 4\mathbf{Q}_{i+1} + \mathbf{Q}_i \right\|^2 \]
</div>

<h3>Elastic Band Analogy</h3>
<div class="image-container">
<svg viewBox="0 0 700 220" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="220" rx="10" fill="#fafafa"/>
<!-- Before optimization -->
<text x="175" y="25" text-anchor="middle" fill="#c0392b" font-weight="bold" font-size="13">Before: Rough Initial Path</text>
<polyline points="30,180 80,60 130,170 200,40 270,160 320,80" fill="none" stroke="#c0392b" stroke-width="2.5" stroke-dasharray="6,4"/>
<circle cx="30" cy="180" r="5" fill="#c0392b"/><circle cx="80" cy="60" r="5" fill="#c0392b"/>
<circle cx="130" cy="170" r="5" fill="#c0392b"/><circle cx="200" cy="40" r="5" fill="#c0392b"/>
<circle cx="270" cy="160" r="5" fill="#c0392b"/><circle cx="320" cy="80" r="5" fill="#c0392b"/>

<text x="365" y="110" text-anchor="middle" fill="#764ba2" font-size="24" font-weight="bold">&rarr;</text>

<!-- After optimization -->
<text x="540" y="25" text-anchor="middle" fill="#27ae60" font-weight="bold" font-size="13">After: Smooth Trajectory</text>
<path d="M400,150 C430,110 460,100 490,105 C520,110 550,90 580,95 C610,100 640,110 670,100" fill="none" stroke="#27ae60" stroke-width="3"/>
<circle cx="400" cy="150" r="5" fill="#27ae60"/><circle cx="460" cy="100" r="5" fill="#27ae60"/>
<circle cx="520" cy="110" r="5" fill="#27ae60"/><circle cx="580" cy="95" r="5" fill="#27ae60"/>
<circle cx="670" cy="100" r="5" fill="#27ae60"/>

<text x="350" y="200" text-anchor="middle" fill="#888" font-size="12">The smoothness cost acts like tension on an elastic band, straightening the trajectory</text>
</svg>
<p class="image-caption">Figure 8: The smoothness cost acts as elastic tension, pulling the trajectory into a smooth curve.</p>
</div>

<h3>Gradient for Optimisation</h3>
<p>The gradient of \(J_{smooth}\) with respect to each control point \(\mathbf{Q}_j\) can be computed in closed form. For the jerk cost:</p>

<div class="math">
\[ \frac{\partial J_{smooth}}{\partial \mathbf{Q}_j} = 2 \sum_{k} c_k \left( \mathbf{Q}_{j} - \text{weighted neighbours} \right) \]
</div>

<p>where the coefficients \(c_k\) come from expanding the finite-difference stencil. In practice, this is a <strong>banded matrix multiplication</strong>, making it extremely efficient for L-BFGS optimisation.</p>

<div class="info-box">
<strong>Matrix Formulation:</strong> Let \(\mathbf{q} = [\mathbf{Q}_0^T, \ldots, \mathbf{Q}_n^T]^T\). Then:
\[ J_{smooth} = \mathbf{q}^T \mathbf{A}^T \mathbf{A} \, \mathbf{q} \]
where \(\mathbf{A}\) is the finite-difference matrix. The gradient is simply \(2\mathbf{A}^T\mathbf{A}\,\mathbf{q}\), computed in \(O(n)\) time.
</div>
</div>

<!-- PAGE 9 -->
<div class="page">
<h2>ESDF vs. ESDF-Free Collision Checking</h2>

<h3>What is ESDF?</h3>
<p>An <strong>Euclidean Signed Distance Field (ESDF)</strong> is a 3D grid where each voxel stores the distance to the nearest obstacle surface (positive outside, negative inside). It enables instant distance and gradient queries but is <strong>expensive to build and maintain</strong>.</p>

<div class="image-container">
<svg viewBox="0 0 750 280" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="280" rx="10" fill="#fafafa"/>
<!-- Left: ESDF approach -->
<text x="185" y="25" text-anchor="middle" fill="#c0392b" font-weight="bold" font-size="14">ESDF-Based (Fast-Planner)</text>
<rect x="30" y="40" width="310" height="220" rx="8" fill="#fff" stroke="#c0392b" stroke-width="2"/>
<!-- Grid representation -->
<g transform="translate(40,55)">
<rect x="0" y="0" width="120" height="120" fill="#eee" stroke="#ccc"/>
<!-- Obstacle -->
<rect x="40" y="30" width="40" height="50" fill="#c0392b" opacity="0.7"/>
<!-- Distance field gradient coloring -->
<rect x="0" y="0" width="20" height="20" fill="#ffe0e0"/><rect x="20" y="0" width="20" height="20" fill="#ffcccc"/>
<rect x="0" y="20" width="20" height="20" fill="#ffcccc"/><rect x="20" y="20" width="20" height="20" fill="#ff9999"/>
<rect x="80" y="30" width="20" height="20" fill="#ff9999"/><rect x="100" y="30" width="20" height="20" fill="#ffcccc"/>
<rect x="80" y="50" width="20" height="20" fill="#ff9999"/><rect x="100" y="50" width="20" height="20" fill="#ffcccc"/>
<rect x="40" y="30" width="40" height="50" fill="#c0392b" opacity="0.8"/>
<text x="60" y="60" text-anchor="middle" fill="white" font-size="9" font-weight="bold">OBS</text>
</g>
<text x="100" y="195" text-anchor="middle" fill="#555" font-size="10">Build full distance field</text>
<text x="100" y="210" text-anchor="middle" fill="#555" font-size="10">for entire 3D volume</text>
<text x="185" y="240" text-anchor="middle" fill="#c0392b" font-size="11" font-weight="bold">Expensive: O(N) per update</text>
<text x="185" y="255" text-anchor="middle" fill="#c0392b" font-size="11">N = total voxels in map</text>

<!-- Right: ESDF-free approach -->
<text x="565" y="25" text-anchor="middle" fill="#27ae60" font-weight="bold" font-size="14">ESDF-Free (EGO-Planner)</text>
<rect x="410" y="40" width="310" height="220" rx="8" fill="#fff" stroke="#27ae60" stroke-width="2"/>
<g transform="translate(430,55)">
<rect x="40" y="30" width="40" height="50" fill="#c0392b" opacity="0.7" rx="4"/>
<text x="60" y="60" text-anchor="middle" fill="white" font-size="9" font-weight="bold">OBS</text>
<!-- Control point near obstacle -->
<circle cx="90" cy="50" r="6" fill="#667eea"/>
<text x="100" cy="45" fill="#667eea" font-size="9">Qi</text>
<!-- Arrow showing push direction -->
<line x1="85" y1="50" x2="110" y2="50" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowG)"/>
<!-- Projection point -->
<circle cx="80" cy="50" r="3" fill="#f39c12"/>
<line x1="80" y1="50" x2="90" y2="50" stroke="#f39c12" stroke-width="1.5" stroke-dasharray="3,3"/>
<text x="85" y="75" text-anchor="middle" fill="#f39c12" font-size="9">d(Qi)</text>
</g>
<text x="565" y="195" text-anchor="middle" fill="#555" font-size="10">Only check control points</text>
<text x="565" y="210" text-anchor="middle" fill="#555" font-size="10">that are near obstacles</text>
<text x="565" y="240" text-anchor="middle" fill="#27ae60" font-size="11" font-weight="bold">Cheap: O(K) per replan</text>
<text x="565" y="255" text-anchor="middle" fill="#27ae60" font-size="11">K = colliding control points</text>

<defs><marker id="arrowG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0,0 8,3 0,6" fill="#27ae60"/></marker></defs>
</svg>
<p class="image-caption">Figure 9: ESDF-based methods compute distances for every voxel; EGO-Planner only processes control points near obstacles.</p>
</div>

<h3>Comparison Table</h3>
<table>
<tr><th>Feature</th><th>ESDF-Based (Fast-Planner)</th><th>ESDF-Free (EGO-Planner)</th></tr>
<tr><td>Map representation</td><td>Full 3D distance field</td><td>Occupancy grid only</td></tr>
<tr><td>Map update cost</td><td>O(N) -- all voxels</td><td>O(M) -- observed voxels</td></tr>
<tr><td>Distance query</td><td>O(1) lookup</td><td>Ray-cast per control point</td></tr>
<tr><td>Gradient availability</td><td>Stored in field</td><td>Computed from projection</td></tr>
<tr><td>Memory</td><td>High (distance per voxel)</td><td>Low (binary occupancy)</td></tr>
<tr><td>Planning time</td><td>~3-5 ms</td><td>&lt;1 ms</td></tr>
<tr><td>Total pipeline time</td><td>~20-50 ms (map + plan)</td><td>~5-10 ms</td></tr>
</table>

<div class="warning-box">
<strong>Common Misconception:</strong> ESDF-free does not mean the planner ignores distances. EGO-Planner computes distances <em>on-demand</em> only for control points that penetrate obstacles, using efficient ray-casting on the occupancy grid. This is much cheaper than maintaining a full distance field.
</div>
</div>

<!-- PAGE 10 -->
<div class="page">
<h2>EGO-Planner Collision Avoidance</h2>

<h3>Control Point Projection</h3>
<p>When a B-spline control point \(\mathbf{Q}_i\) is inside or near an obstacle, EGO-Planner finds the closest obstacle-free point \(\mathbf{Q}_i'\) by <strong>projecting along the line connecting the previous and next control points</strong>. The collision penalty is then based on the distance between \(\mathbf{Q}_i\) and the obstacle surface along this direction.</p>

<div class="image-container">
<svg viewBox="0 0 700 260" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="260" rx="10" fill="#fafafa"/>
<!-- Obstacle -->
<ellipse cx="350" cy="130" rx="100" ry="80" fill="#c0392b" opacity="0.2" stroke="#c0392b" stroke-width="2"/>
<text x="350" y="135" text-anchor="middle" fill="#c0392b" font-weight="bold" font-size="13">Obstacle</text>

<!-- Control points -->
<circle cx="180" cy="100" r="7" fill="#667eea"/><text x="165" y="90" fill="#667eea" font-size="12" font-weight="bold">Qi-1</text>
<circle cx="340" cy="110" r="7" fill="#c0392b" stroke="#667eea" stroke-width="2"/><text x="355" y="100" fill="#c0392b" font-size="12" font-weight="bold">Qi (colliding)</text>
<circle cx="520" cy="90" r="7" fill="#667eea"/><text x="535" y="85" fill="#667eea" font-size="12" font-weight="bold">Qi+1</text>

<!-- Guide line -->
<line x1="180" y1="100" x2="520" y2="90" stroke="#aaa" stroke-width="1" stroke-dasharray="5,5"/>

<!-- Projection -->
<circle cx="440" cy="75" r="5" fill="#f39c12"/>
<text x="460" y="70" fill="#f39c12" font-size="11" font-weight="bold">surface point</text>

<!-- Push direction -->
<line x1="340" y1="110" x2="440" y2="75" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowPush)"/>
<text x="400" y="115" fill="#27ae60" font-size="11" font-weight="bold">push direction</text>

<!-- Optimized position -->
<circle cx="470" cy="65" r="7" fill="#27ae60" stroke="#667eea" stroke-width="2"/>
<text x="490" y="58" fill="#27ae60" font-size="11" font-weight="bold">Qi (optimised)</text>

<!-- Distance label -->
<text x="350" y="240" text-anchor="middle" fill="#555" font-size="12">d = distance from Qi to obstacle surface along guide direction</text>

<defs><marker id="arrowPush" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0,0 8,3 0,6" fill="#27ae60"/></marker></defs>
</svg>
<p class="image-caption">Figure 10: EGO-Planner projects colliding control points away from obstacles along the guide direction.</p>
</div>

<h3>Collision Cost Formulation</h3>
<p>For each control point \(\mathbf{Q}_i\), define \(d_i\) as the signed distance to the nearest obstacle surface (negative if inside). The collision cost with a safety margin \(d_s\) is:</p>

<div class="math">
\[ J_{collision} = \sum_{i} c(d_i), \quad c(d) = \begin{cases} (d_s - d)^3 & \text{if } d < d_s \\ 0 & \text{if } d \ge d_s \end{cases} \]
</div>

<p>The gradient with respect to \(\mathbf{Q}_i\):</p>

<div class="math">
\[ \frac{\partial J_{collision}}{\partial \mathbf{Q}_i} = -3(d_s - d_i)^2 \cdot \hat{\mathbf{n}}_i \]
</div>

<p>where \(\hat{\mathbf{n}}_i\) is the unit vector pointing from the obstacle surface to \(\mathbf{Q}_i\). This pushes the control point <strong>away from the obstacle</strong> with a force proportional to the cube of the penetration depth.</p>

<div class="info-box">
<strong>Why Cubic Penalty?</strong> The cubic function \((d_s - d)^3\) has zero value and zero first derivative at \(d = d_s\), ensuring a smooth transition. The second derivative is also zero at the boundary, preventing oscillation during L-BFGS optimisation.
</div>

<div class="activity-box">
<h3>Activity 2: Collision Cost Analysis</h3>
<p><strong>Duration:</strong> 10 minutes | <strong>Type:</strong> Calculation</p>
<ol>
<li>Given safety distance \(d_s = 0.3\) m, compute the collision cost for a control point at distance \(d = 0.1\) m from the nearest obstacle.</li>
<li>Compute the gradient magnitude at this point. In which direction does it point?</li>
<li>What happens to the cost if \(d = 0.3\) m? What about \(d = 0.5\) m?</li>
<li>Why is a cubic penalty preferred over a quadratic penalty? (Hint: think about the smoothness at the boundary.)</li>
</ol>
</div>
</div>

<!-- PAGE 11 -->
<div class="page">
<h2>Dynamic Feasibility Constraints</h2>

<h3>Velocity and Acceleration Limits</h3>
<p>For uniform cubic B-splines, velocity and acceleration are bounded by control point differences. EGO-Planner penalises violations using a similar soft-constraint approach:</p>

<div class="math">
\[ J_{dynamic} = J_{vel} + J_{acc} \]
</div>

<h4>Velocity Penalty</h4>
<p>Define the velocity proxy \(\mathbf{v}_i = \frac{\mathbf{Q}_{i+1} - \mathbf{Q}_i}{\Delta t}\). For each axis \(d \in \{x,y,z\}\):</p>

<div class="math">
\[ J_{vel} = \sum_{i} \sum_{d} \begin{cases} (v_{i,d} - v_{max})^3 & \text{if } v_{i,d} > v_{max} \\ (-v_{max} - v_{i,d})^3 & \text{if } v_{i,d} < -v_{max} \\ 0 & \text{otherwise} \end{cases} \]
</div>

<h4>Acceleration Penalty</h4>
<p>Define the acceleration proxy \(\mathbf{a}_i = \frac{\mathbf{Q}_{i+2} - 2\mathbf{Q}_{i+1} + \mathbf{Q}_i}{\Delta t^2}\). The penalty follows the same structure:</p>

<div class="math">
\[ J_{acc} = \sum_{i} \sum_{d} \begin{cases} (a_{i,d} - a_{max})^3 & \text{if } a_{i,d} > a_{max} \\ (-a_{max} - a_{i,d})^3 & \text{if } a_{i,d} < -a_{max} \\ 0 & \text{otherwise} \end{cases} \]
</div>

<h3>How Constraints Map to Control Points</h3>
<div class="image-container">
<svg viewBox="0 0 700 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="200" rx="10" fill="#fafafa"/>
<!-- Control points with velocity vectors -->
<circle cx="100" cy="100" r="8" fill="#667eea"/><text x="100" y="85" text-anchor="middle" fill="#667eea" font-size="11">Qi</text>
<circle cx="250" cy="70" r="8" fill="#667eea"/><text x="250" y="55" text-anchor="middle" fill="#667eea" font-size="11">Qi+1</text>
<circle cx="420" cy="110" r="8" fill="#667eea"/><text x="420" y="130" text-anchor="middle" fill="#667eea" font-size="11">Qi+2</text>
<circle cx="580" cy="80" r="8" fill="#667eea"/><text x="580" y="65" text-anchor="middle" fill="#667eea" font-size="11">Qi+3</text>

<!-- Velocity arrows -->
<line x1="100" y1="100" x2="250" y2="70" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrV)"/>
<text x="170" y="75" fill="#4CAF50" font-size="10" font-weight="bold">vi ~ (Qi+1 - Qi)/dt</text>

<line x1="250" y1="70" x2="420" y2="110" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrV)"/>
<text x="340" y="105" fill="#4CAF50" font-size="10" font-weight="bold">vi+1</text>

<!-- Acceleration -->
<path d="M175,140 Q250,180 335,140" fill="none" stroke="#f39c12" stroke-width="2" stroke-dasharray="4,3"/>
<text x="250" y="175" text-anchor="middle" fill="#f39c12" font-size="10" font-weight="bold">ai ~ (Qi+2 - 2Qi+1 + Qi)/dt^2</text>

<defs><marker id="arrV" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0,0 8,3 0,6" fill="#4CAF50"/></marker></defs>
</svg>
<p class="image-caption">Figure 11: Velocity and acceleration are derived from first and second differences of control points.</p>
</div>

<div class="warning-box">
<strong>Feasibility Check:</strong> After optimisation, EGO-Planner performs a final check. If any segment still violates dynamic limits, the time allocation \(\Delta t\) is locally increased (slowing down that segment) and optimisation is re-run. This guarantees the final trajectory is always feasible.
</div>

<h3>Per-Axis Decomposition</h3>
<p>Note that the dynamic constraints are checked <strong>per axis</strong> rather than on the norm. This is because quadrotor actuators have per-axis limits (thrust allocation). The per-axis check is conservative but computationally efficient and avoids nonlinear norm constraints that would complicate the optimisation.</p>
</div>

<!-- PAGE 12 -->
<div class="page">
<h2>EGO-Planner Architecture</h2>

<h3>Full Pipeline</h3>
<div class="image-container">
<svg viewBox="0 0 750 500" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="500" rx="10" fill="#fafafa"/>

<!-- Step 1 -->
<rect x="250" y="10" width="250" height="50" rx="8" fill="#667eea"/>
<text x="375" y="40" text-anchor="middle" fill="white" font-weight="bold" font-size="13">1. Front-End Path Search (A*)</text>
<polygon points="370,60 380,60 375,75" fill="#764ba2"/>

<!-- Step 2 -->
<rect x="200" y="80" width="350" height="50" rx="8" fill="#764ba2"/>
<text x="375" y="110" text-anchor="middle" fill="white" font-weight="bold" font-size="13">2. B-Spline Parameterisation &amp; Time Allocation</text>
<polygon points="370,130 380,130 375,145" fill="#764ba2"/>

<!-- Step 3: Optimization loop -->
<rect x="100" y="150" width="550" height="180" rx="12" fill="#f0f8ff" stroke="#4CAF50" stroke-width="2"/>
<text x="375" y="175" text-anchor="middle" fill="#4CAF50" font-weight="bold" font-size="14">3. Back-End Optimisation Loop</text>

<rect x="130" y="190" width="170" height="40" rx="6" fill="#667eea" opacity="0.8"/>
<text x="215" y="215" text-anchor="middle" fill="white" font-size="11">Compute Js gradient</text>

<rect x="315" y="190" width="170" height="40" rx="6" fill="#c0392b" opacity="0.8"/>
<text x="400" y="215" text-anchor="middle" fill="white" font-size="11">Compute Jc gradient</text>

<rect x="500" y="190" width="130" height="40" rx="6" fill="#f39c12" opacity="0.8"/>
<text x="565" y="215" text-anchor="middle" fill="white" font-size="11">Compute Jd gradient</text>

<rect x="220" y="250" width="310" height="35" rx="6" fill="#764ba2"/>
<text x="375" y="272" text-anchor="middle" fill="white" font-size="12">Sum gradients &rarr; L-BFGS update</text>

<text x="375" y="310" text-anchor="middle" fill="#4CAF50" font-size="11">Repeat until convergence (typically 10-30 iterations)</text>

<polygon points="370,330 380,330 375,345" fill="#764ba2"/>

<!-- Step 4 -->
<rect x="200" y="350" width="350" height="50" rx="8" fill="#ff9800"/>
<text x="375" y="380" text-anchor="middle" fill="white" font-weight="bold" font-size="13">4. Feasibility Check &amp; Time Reallocation</text>
<polygon points="370,400 380,400 375,415" fill="#764ba2"/>

<!-- Decision -->
<polygon points="375,420 450,445 375,470 300,445" fill="#fff" stroke="#764ba2" stroke-width="2"/>
<text x="375" y="449" text-anchor="middle" fill="#764ba2" font-size="11" font-weight="bold">Feasible?</text>

<!-- Yes -->
<line x1="375" y1="470" x2="375" y2="490" stroke="#27ae60" stroke-width="2"/>
<text x="395" y="485" fill="#27ae60" font-size="11" font-weight="bold">Yes</text>
<rect x="300" y="490" width="150" height="10" rx="3" fill="#27ae60"/>

<!-- No: loop back -->
<line x1="450" y1="445" x2="680" y2="445" stroke="#c0392b" stroke-width="2"/>
<line x1="680" y1="445" x2="680" y2="160" stroke="#c0392b" stroke-width="2"/>
<line x1="680" y1="160" x2="650" y2="160" stroke="#c0392b" stroke-width="2" marker-end="url(#arrBack)"/>
<text x="690" y="300" fill="#c0392b" font-size="11" font-weight="bold" transform="rotate(90,690,300)">No: adjust dt</text>

<defs><marker id="arrBack" markerWidth="8" markerHeight="6" refX="0" refY="3" orient="auto"><polygon points="8,0 0,3 8,6" fill="#c0392b"/></marker></defs>
</svg>
<p class="image-caption">Figure 12: Complete EGO-Planner architecture with optimisation loop and feasibility feedback.</p>
</div>

<h3>Module Descriptions</h3>
<div class="two-column">
<div>
<h4>Front-End: Path Search</h4>
<p>A lightweight A* or JPS (Jump Point Search) on the occupancy grid produces an initial collision-free path. This path provides a topologically correct starting point for optimisation. Planning time: ~1 ms.</p>

<h4>B-Spline Initialisation</h4>
<p>The path waypoints are fitted to a uniform B-spline using anisotropic curve fitting. The time allocation \(\Delta t\) is initially set proportional to segment length.</p>
</div>
<div>
<h4>Back-End: L-BFGS Optimisation</h4>
<p>The core of EGO-Planner. Iteratively adjusts control points to minimise the total cost \(J = J_s + \lambda_c J_c + \lambda_d J_d\). Converges in 10-30 iterations (~0.5 ms total).</p>

<h4>Feasibility Check</h4>
<p>Post-optimisation verification. If dynamic limits are violated, the offending segment's \(\Delta t\) is increased and optimisation reruns. Rarely needed after tuning.</p>
</div>
</div>
</div>

<!-- PAGE 13 -->
<div class="page">
<h2>L-BFGS Optimisation</h2>

<h3>Why L-BFGS for Trajectory Optimisation?</h3>
<p><strong>Limited-memory Broyden-Fletcher-Goldfarb-Shanno (L-BFGS)</strong> is a quasi-Newton optimisation method that approximates the inverse Hessian using the last \(m\) gradient evaluations (typically \(m = 6\text{-}10\)). It is the method of choice for EGO-Planner because:</p>

<ul>
<li><strong>No Hessian storage:</strong> Only stores \(2m\) vectors instead of the full \(n \times n\) Hessian matrix</li>
<li><strong>Super-linear convergence:</strong> Faster than gradient descent, approaching Newton's method</li>
<li><strong>Exact line search unnecessary:</strong> Wolfe conditions suffice, reducing per-iteration cost</li>
<li><strong>Well-suited for smooth costs:</strong> The B-spline cost function is smooth, which L-BFGS exploits</li>
</ul>

<h3>L-BFGS Update Rule</h3>
<p>At iteration \(k\), L-BFGS computes the search direction \(\mathbf{d}_k\) using the two-loop recursion:</p>

<div class="math">
\[ \mathbf{s}_k = \mathbf{Q}_{k+1} - \mathbf{Q}_k, \quad \mathbf{y}_k = \nabla J_{k+1} - \nabla J_k \]
\[ H_k^0 = \frac{\mathbf{s}_{k-1}^T \mathbf{y}_{k-1}}{\mathbf{y}_{k-1}^T \mathbf{y}_{k-1}} I \]
\[ \mathbf{d}_k = -H_k \nabla J_k \quad \text{(computed via two-loop recursion)} \]
</div>
<p><strong>where:</strong></p>
<ul>
    <li>\( \mathbf{s}_k \) — step vector (change in control points between iterations)</li>
    <li>\( \mathbf{y}_k \) — gradient difference between iterations</li>
    <li>\( H_k^0 \) — initial inverse Hessian approximation (scaled identity)</li>
    <li>\( H_k \) — approximate inverse Hessian built from the \(m\) most recent \(\mathbf{s}, \mathbf{y}\) pairs</li>
    <li>\( \mathbf{d}_k \) — search direction</li>
    <li>\( \alpha_k \) — step size from line search satisfying the Wolfe conditions</li>
</ul>

<h3>Comparison of Optimisation Methods</h3>
<table>
<tr><th>Method</th><th>Storage</th><th>Convergence</th><th>Per-Iteration</th><th>Suitability</th></tr>
<tr><td>Gradient Descent</td><td>O(n)</td><td>Linear</td><td>O(n)</td><td>Simple but slow</td></tr>
<tr><td>Newton's Method</td><td>O(n^2)</td><td>Quadratic</td><td>O(n^3)</td><td>Fast but too expensive</td></tr>
<tr><td>BFGS</td><td>O(n^2)</td><td>Super-linear</td><td>O(n^2)</td><td>Good for small n</td></tr>
<tr><td><strong>L-BFGS</strong></td><td><strong>O(mn)</strong></td><td><strong>Super-linear</strong></td><td><strong>O(mn)</strong></td><td><strong>Ideal for EGO-Planner</strong></td></tr>
</table>

<div class="info-box">
<strong>In Practice:</strong> For a typical trajectory with 20-50 control points in 3D (n = 60-150), L-BFGS with m = 8 converges in 10-30 iterations, taking under 0.5 ms on modern hardware. This enables replanning at &gt;100 Hz.
</div>

<div class="image-container">
<svg viewBox="0 0 700 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="200" rx="10" fill="#fafafa"/>
<text x="350" y="25" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Convergence: Gradient Descent vs L-BFGS</text>
<!-- Axes -->
<line x1="80" y1="170" x2="650" y2="170" stroke="#333" stroke-width="2"/>
<line x1="80" y1="170" x2="80" y2="40" stroke="#333" stroke-width="2"/>
<text x="365" y="195" text-anchor="middle" fill="#555" font-size="11">Iterations</text>
<text x="50" y="105" text-anchor="middle" fill="#555" font-size="11" transform="rotate(-90,50,105)">Cost J</text>
<!-- GD: slow decay -->
<path d="M80,50 C150,55 250,80 350,110 C450,135 550,155 650,162" fill="none" stroke="#c0392b" stroke-width="2.5"/>
<text x="620" y="152" fill="#c0392b" font-size="11">GD</text>
<!-- L-BFGS: fast decay -->
<path d="M80,50 C120,100 160,145 220,160 C280,165 350,167 650,168" fill="none" stroke="#27ae60" stroke-width="2.5"/>
<text x="250" y="150" fill="#27ae60" font-size="11">L-BFGS</text>
</svg>
<p class="image-caption">Figure 13: L-BFGS converges much faster than gradient descent for trajectory optimisation.</p>
</div>
</div>

<!-- PAGE 14 -->
<div class="page">
<h2>Time Allocation</h2>

<h3>Why Time Matters</h3>
<p>The knot span \(\Delta t\) directly determines the relationship between control point spacing and velocity/acceleration. A poor time allocation leads to either:</p>
<ul>
<li><strong>Too short \(\Delta t\):</strong> High velocities/accelerations, potential infeasibility</li>
<li><strong>Too long \(\Delta t\):</strong> Sluggish flight, wasted time</li>
</ul>

<h3>Initial Time Allocation: Anisotropic Curve Fitting</h3>
<p>EGO-Planner initialises \(\Delta t_i\) for each segment proportional to the distance between consecutive waypoints from the front-end path, scaled by the maximum velocity:</p>

<div class="math">
\[ \Delta t_i = \frac{\|\mathbf{w}_{i+1} - \mathbf{w}_i\|}{v_{max}} \cdot \kappa \]
</div>

<p>where \(\kappa > 1\) is a safety factor (typically 1.2-1.5) to leave room for optimisation.</p>

<h3>Time Reallocation After Optimisation</h3>
<p>If the feasibility check detects violations, the time for the offending segment is increased:</p>

<div class="math">
\[ \Delta t_i^{new} = \Delta t_i^{old} \cdot \max\left(1, \frac{\|v_i\|}{v_{max}}, \sqrt{\frac{\|a_i\|}{a_{max}}}\right) \]
</div>

<div class="image-container">
<svg viewBox="0 0 750 250" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="250" rx="10" fill="#fafafa"/>
<!-- Before -->
<text x="190" y="25" text-anchor="middle" fill="#c0392b" font-weight="bold" font-size="13">Before: Uniform Time Allocation</text>
<line x1="40" y1="80" x2="360" y2="80" stroke="#ddd" stroke-width="1"/>
<circle cx="60" cy="80" r="5" fill="#667eea"/><circle cx="120" cy="80" r="5" fill="#667eea"/>
<circle cx="180" cy="80" r="5" fill="#667eea"/><circle cx="240" cy="80" r="5" fill="#667eea"/>
<circle cx="300" cy="80" r="5" fill="#667eea"/><circle cx="360" cy="80" r="5" fill="#667eea"/>
<!-- Equal spacing markers -->
<text x="90" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="150" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="210" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="270" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="330" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<!-- Velocity profile -->
<path d="M60,160 L120,120 L180,100 L240,120 L300,160 L360,140" fill="none" stroke="#c0392b" stroke-width="2"/>
<line x1="40" y1="105" x2="370" y2="105" stroke="#c0392b" stroke-width="1" stroke-dasharray="4,4"/>
<text x="380" y="108" fill="#c0392b" font-size="10">v_max</text>
<text x="190" y="195" text-anchor="middle" fill="#c0392b" font-size="11">Segment 3 exceeds v_max!</text>

<!-- After -->
<text x="560" y="25" text-anchor="middle" fill="#27ae60" font-weight="bold" font-size="13">After: Adaptive Time Allocation</text>
<line x1="410" y1="80" x2="720" y2="80" stroke="#ddd" stroke-width="1"/>
<circle cx="420" cy="80" r="5" fill="#667eea"/><circle cx="475" cy="80" r="5" fill="#667eea"/>
<circle cx="540" cy="80" r="5" fill="#667eea"/><circle cx="620" cy="80" r="5" fill="#667eea"/>
<circle cx="680" cy="80" r="5" fill="#667eea"/><circle cx="720" cy="80" r="5" fill="#667eea"/>
<!-- Variable spacing -->
<text x="447" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="507" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="580" y="70" text-anchor="middle" fill="#27ae60" font-size="9" font-weight="bold">dt'&gt;dt</text>
<text x="650" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<text x="700" y="70" text-anchor="middle" fill="#888" font-size="9">dt</text>
<!-- Velocity profile -->
<path d="M420,160 L475,125 L540,110 L620,115 L680,140 L720,135" fill="none" stroke="#27ae60" stroke-width="2"/>
<line x1="400" y1="105" x2="730" y2="105" stroke="#27ae60" stroke-width="1" stroke-dasharray="4,4"/>
<text x="740" y="108" fill="#27ae60" font-size="10">v_max</text>
<text x="560" y="195" text-anchor="middle" fill="#27ae60" font-size="11">All segments feasible</text>
</svg>
<p class="image-caption">Figure 14: Time reallocation stretches segments that exceed dynamic limits.</p>
</div>

<div class="tip">For racing scenarios, set \(\kappa\) closer to 1.0 to push the drone toward its limits. For inspection tasks, use \(\kappa = 1.5\) or higher for more conservative, smoother flight.</div>
</div>

<!-- PAGE 15 -->
<div class="page">
<h2>EGO-Swarm: Multi-Drone Planning</h2>

<h3>Decentralised Architecture</h3>
<p><strong>EGO-Swarm</strong> extends EGO-Planner to multiple drones without a central coordinator. Each drone runs its own EGO-Planner instance and shares its planned trajectory with neighbours via broadcast. The key additions are:</p>

<ul>
<li><strong>Trajectory broadcasting:</strong> Each drone broadcasts its optimised B-spline (control points + knots) at ~10 Hz</li>
<li><strong>Inter-drone collision cost:</strong> Added to the optimisation alongside obstacle collision cost</li>
<li><strong>Topological path planning:</strong> Different drones can take different routes around the same obstacle</li>
</ul>

<div class="image-container">
<svg viewBox="0 0 750 320" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="750" height="320" rx="10" fill="#1a1a3e"/>
<!-- Drones -->
<g>
<circle cx="150" cy="100" r="25" fill="none" stroke="#00e676" stroke-width="2"/>
<text x="150" y="105" text-anchor="middle" fill="#00e676" font-size="12" font-weight="bold">D1</text>
<path d="M150,130 C180,150 220,160 280,140" fill="none" stroke="#00e676" stroke-width="2" stroke-dasharray="6,3"/>
</g>
<g>
<circle cx="600" cy="80" r="25" fill="none" stroke="#29b6f6" stroke-width="2"/>
<text x="600" y="85" text-anchor="middle" fill="#29b6f6" font-size="12" font-weight="bold">D2</text>
<path d="M600,110 C570,140 520,150 460,140" fill="none" stroke="#29b6f6" stroke-width="2" stroke-dasharray="6,3"/>
</g>
<g>
<circle cx="350" cy="250" r="25" fill="none" stroke="#ffd740" stroke-width="2"/>
<text x="350" y="255" text-anchor="middle" fill="#ffd740" font-size="12" font-weight="bold">D3</text>
<path d="M350,220 C360,190 380,160 400,140" fill="none" stroke="#ffd740" stroke-width="2" stroke-dasharray="6,3"/>
</g>

<!-- Broadcast lines -->
<line x1="175" y1="100" x2="575" y2="80" stroke="white" stroke-width="0.8" stroke-dasharray="3,5" opacity="0.4"/>
<line x1="175" y1="115" x2="330" y2="235" stroke="white" stroke-width="0.8" stroke-dasharray="3,5" opacity="0.4"/>
<line x1="575" y1="95" x2="370" y2="235" stroke="white" stroke-width="0.8" stroke-dasharray="3,5" opacity="0.4"/>

<!-- Obstacle -->
<rect x="340" y="110" width="70" height="60" rx="8" fill="#c0392b" opacity="0.6"/>
<text x="375" y="145" text-anchor="middle" fill="white" font-size="10">OBS</text>

<!-- Labels -->
<text x="375" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="16">Decentralised EGO-Swarm</text>
<text x="375" y="305" text-anchor="middle" fill="#aaa" font-size="11">Each drone broadcasts its B-spline trajectory; neighbours add inter-drone collision cost</text>
<!-- Broadcast icons -->
<text x="270" y="80" text-anchor="middle" fill="white" font-size="10" opacity="0.6">broadcast</text>
<text x="490" y="70" text-anchor="middle" fill="white" font-size="10" opacity="0.6">broadcast</text>
</svg>
<p class="image-caption">Figure 15: EGO-Swarm -- each drone plans independently and broadcasts its trajectory to neighbours.</p>
</div>

<h3>Inter-Drone Collision Avoidance</h3>
<p>For drone \(A\) with trajectory \(\mathbf{p}_A(t)\) and neighbour drone \(B\) with broadcast trajectory \(\mathbf{p}_B(t)\), the inter-drone collision cost evaluates the minimum distance at corresponding times:</p>

<div class="math">
\[ J_{inter} = \sum_{t_k} \max(0, \, d_{safe} - \|\mathbf{p}_A(t_k) - \mathbf{p}_B(t_k)\|)^3 \]
</div>

<p>Since only drone \(A\)'s control points are optimised (drone \(B\)'s trajectory is fixed from the broadcast), the gradient is straightforward to compute.</p>

<div class="activity-box">
<h3>Activity 3: Swarm Coordination Thought Experiment</h3>
<p><strong>Duration:</strong> 10 minutes | <strong>Type:</strong> Group discussion</p>
<ol>
<li>Two drones are heading toward each other in a narrow corridor. How does EGO-Swarm resolve the conflict without a central coordinator?</li>
<li>What happens if broadcast messages are delayed by 100 ms? How might this affect safety?</li>
<li>Why is decentralised planning preferred over centralised planning for drone swarms?</li>
<li>What is the maximum number of drones EGO-Swarm has been tested with? (Research the paper.)</li>
</ol>
</div>
</div>

<!-- PAGE 16 -->
<div class="page">
<h2>EGO-Planner vs. Fast-Planner vs. Others</h2>

<h3>Detailed Comparison</h3>
<table>
<tr><th>Feature</th><th>Fast-Planner</th><th>EGO-Planner</th><th>TEB Planner</th><th>CHOMP</th></tr>
<tr><td>Year</td><td>2019</td><td>2020</td><td>2012</td><td>2009</td></tr>
<tr><td>Lab / Origin</td><td>ZJU FAST Lab</td><td>ZJU FAST Lab</td><td>TU Dortmund</td><td>CMU / MRSL</td></tr>
<tr><td>ESDF Required</td><td>Yes</td><td>No</td><td>N/A (2D)</td><td>Yes</td></tr>
<tr><td>Trajectory Rep.</td><td>B-spline</td><td>Uniform B-spline</td><td>Timed elastic band</td><td>Waypoints</td></tr>
<tr><td>Planning Time</td><td>3-5 ms</td><td>&lt;1 ms</td><td>~10-50 ms</td><td>~50-200 ms</td></tr>
<tr><td>Total Pipeline</td><td>20-50 ms</td><td>5-10 ms</td><td>50-200 ms</td><td>100-500 ms</td></tr>
<tr><td>Multi-Agent</td><td>No</td><td>Yes (EGO-Swarm)</td><td>Limited</td><td>No</td></tr>
<tr><td>3D Support</td><td>Yes</td><td>Yes</td><td>Mainly 2D</td><td>Yes</td></tr>
<tr><td>Dynamic Feasibility</td><td>Soft constraint</td><td>Soft + recheck</td><td>Soft constraint</td><td>Post-process</td></tr>
<tr><td>Hardware Tested</td><td>DJI N3, PX4</td><td>PX4, custom FCU</td><td>Ground robots</td><td>Simulation</td></tr>
<tr><td>ROS Support</td><td>ROS 1</td><td>ROS 1 &amp; ROS 2</td><td>ROS 1 &amp; ROS 2</td><td>ROS 1</td></tr>
</table>

<h3>GitHub Resources</h3>
<div class="two-column">
<div class="info-box">
<h4>EGO-Planner</h4>
<p><code>github.com/ZJU-FAST-Lab/ego-planner</code></p>
<p>Original ROS 1 implementation. Well-documented, active community.</p>
</div>
<div class="info-box">
<h4>EGO-Planner-v2</h4>
<p><code>github.com/ZJU-FAST-Lab/EGO-Planner-v2</code></p>
<p>Full SE(3) planning with yaw optimisation.</p>
</div>
</div>
<div class="two-column">
<div class="info-box">
<h4>EGO-Swarm</h4>
<p><code>github.com/ZJU-FAST-Lab/ego-planner-swarm</code></p>
<p>Multi-drone extension with decentralised coordination.</p>
</div>
<div class="info-box">
<h4>Fast-Planner</h4>
<p><code>github.com/HKUST-Aerial-Robotics/Fast-Planner</code></p>
<p>Predecessor with ESDF-based approach. Good for comparison studies.</p>
</div>
</div>

<div class="image-container">
<svg viewBox="0 0 700 160" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="160" rx="10" fill="#fafafa"/>
<text x="350" y="25" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Planning Time Comparison (lower is better)</text>
<!-- Bars -->
<rect x="80" y="45" width="40" height="100" rx="4" fill="#c0392b" opacity="0.7"/>
<text x="100" y="40" text-anchor="middle" fill="#555" font-size="10">CHOMP</text>
<text x="100" y="155" text-anchor="middle" fill="#555" font-size="9">~200ms</text>

<rect x="180" y="75" width="40" height="70" rx="4" fill="#f39c12" opacity="0.7"/>
<text x="200" y="40" text-anchor="middle" fill="#555" font-size="10">TEB</text>
<text x="200" y="155" text-anchor="middle" fill="#555" font-size="9">~50ms</text>

<rect x="280" y="115" width="40" height="30" rx="4" fill="#764ba2" opacity="0.7"/>
<text x="300" y="40" text-anchor="middle" fill="#555" font-size="10">Fast-Planner</text>
<text x="300" y="155" text-anchor="middle" fill="#555" font-size="9">~25ms</text>

<rect x="380" y="135" width="40" height="10" rx="4" fill="#27ae60"/>
<text x="400" y="40" text-anchor="middle" fill="#555" font-size="10">EGO-Planner</text>
<text x="400" y="155" text-anchor="middle" fill="#27ae60" font-size="9" font-weight="bold">&lt;5ms</text>

<!-- Baseline -->
<line x1="60" y1="145" x2="450" y2="145" stroke="#ddd" stroke-width="1"/>
</svg>
<p class="image-caption">Figure 16: EGO-Planner achieves the lowest total pipeline time by eliminating ESDF construction.</p>
</div>
</div>

<!-- PAGE 17 -->
<div class="page">
<h2>Implementation &amp; ROS Integration</h2>

<h3>Package Structure</h3>
<pre>
ego_planner_ws/
  src/
    ego-planner/
      planner/
        bspline_opt/          # B-spline optimisation core
          include/
            bspline_optimizer.h
          src/
            bspline_optimizer.cpp
        path_searching/       # Front-end A* search
        plan_manage/          # High-level planner manager
          launch/
            single_drone.launch.py
            swarm.launch.py
          config/
            planner_params.yaml
        plan_env/             # Occupancy grid, sensor processing
      uav_simulator/          # Lightweight simulation environment
</pre>

<h3>Launch File (ROS 2)</h3>
<pre>
# single_drone.launch.py
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        Node(
            package='plan_manage',
            executable='ego_planner_node',
            name='ego_planner',
            output='screen',
            parameters=['config/planner_params.yaml'],
            remappings=[
                ('/odom', '/drone/odom'),
                ('/depth', '/drone/depth_camera/image_raw'),
                ('/cloud', '/drone/point_cloud'),
            ]
        ),
        Node(
            package='plan_env',
            executable='grid_map_node',
            name='grid_map',
            output='screen',
            parameters=['config/planner_params.yaml'],
        ),
    ])
</pre>

<h3>Key Configuration Parameters</h3>
<pre>
# planner_params.yaml
planner:
  max_vel: 3.0              # m/s -- maximum velocity
  max_acc: 6.0              # m/s^2 -- maximum acceleration
  max_jerk: 20.0            # m/s^3 -- maximum jerk
  planning_horizon: 7.5     # metres ahead to plan
  replan_threshold: 1.5     # replan if goal > threshold

bspline_optimizer:
  lambda_smooth: 1.0        # smoothness weight
  lambda_collision: 0.5     # collision weight
  lambda_dynamic: 0.5       # dynamic feasibility weight
  dist_safe: 0.4            # safety distance (metres)
  order: 3                  # B-spline degree (cubic)

grid_map:
  resolution: 0.1           # voxel size in metres
  map_size_x: 40.0          # map dimensions
  map_size_y: 40.0
  map_size_z: 5.0
  inflation: 0.2            # obstacle inflation radius
</pre>

<h3>Build and Run</h3>
<pre>
# Clone and build
cd ~/ego_planner_ws/src
git clone https://github.com/ZJU-FAST-Lab/ego-planner.git
cd ~/ego_planner_ws
colcon build --symlink-install

# Source and launch
source install/setup.bash
ros2 launch plan_manage single_drone.launch.py
</pre>
</div>

<!-- PAGE 18 -->
<div class="page">
<h2>Tuning EGO-Planner</h2>

<h3>Weight Tuning Strategy</h3>
<p>The three weights \(\lambda_s, \lambda_c, \lambda_d\) control the trade-off between smoothness, safety, and aggressiveness. There is no universal setting -- the right balance depends on the application.</p>

<div class="two-column">
<div>
<h4>Racing / Aggressive Flight</h4>
<ul>
<li>\(\lambda_s = 0.5\) -- allow sharper turns</li>
<li>\(\lambda_c = 0.3\) -- tighter obstacle clearance</li>
<li>\(\lambda_d = 1.0\) -- respect motor limits</li>
<li><code>max_vel: 5.0-8.0</code> m/s</li>
<li><code>max_acc: 10.0-15.0</code> m/s^2</li>
<li><code>dist_safe: 0.2-0.3</code> m</li>
</ul>
</div>
<div>
<h4>Inspection / Filming</h4>
<ul>
<li>\(\lambda_s = 2.0\) -- very smooth flight</li>
<li>\(\lambda_c = 1.0\) -- generous clearance</li>
<li>\(\lambda_d = 0.5\) -- far from limits</li>
<li><code>max_vel: 1.0-2.0</code> m/s</li>
<li><code>max_acc: 3.0-5.0</code> m/s^2</li>
<li><code>dist_safe: 0.5-1.0</code> m</li>
</ul>
</div>
</div>

<div class="image-container">
<svg viewBox="0 0 700 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
<rect width="700" height="200" rx="10" fill="#fafafa"/>
<text x="350" y="25" text-anchor="middle" fill="#667eea" font-weight="bold" font-size="14">Effect of Weight Tuning</text>
<!-- High smoothness -->
<text x="120" y="55" text-anchor="middle" fill="#667eea" font-size="12">High smoothness</text>
<path d="M30,120 C80,100 140,110 200,100 C260,90 300,110 350,120" fill="none" stroke="#667eea" stroke-width="3"/>
<rect x="130" y="80" width="40" height="60" rx="4" fill="#c0392b" opacity="0.3"/>
<text x="190" y="145" fill="#667eea" font-size="10">Smooth but may clip obstacle</text>

<!-- High collision -->
<text x="530" y="55" text-anchor="middle" fill="#c0392b" font-size="12">High collision weight</text>
<path d="M400,120 C430,120 440,60 470,60 C510,60 520,120 550,120 C580,120 590,70 620,70 C650,70 680,120 700,120" fill="none" stroke="#c0392b" stroke-width="3"/>
<rect x="460" y="80" width="40" height="60" rx="4" fill="#c0392b" opacity="0.3"/>
<rect x="600" y="70" width="30" height="50" rx="4" fill="#c0392b" opacity="0.3"/>
<text x="550" y="145" fill="#c0392b" font-size="10">Safe but jerky trajectory</text>
</svg>
<p class="image-caption">Figure 17: The trade-off between smoothness and collision avoidance weights.</p>
</div>

<div class="warning-box">
<strong>Warning: Common Pitfalls</strong>
<ul>
<li><strong>dist_safe too small:</strong> The drone may graze obstacles. Remember the convex hull property gives an <em>outer bound</em>, not exact distance. Add margin!</li>
<li><strong>max_vel too high:</strong> If the drone cannot actually achieve the commanded velocity, tracking errors accumulate and the planner's model diverges from reality.</li>
<li><strong>lambda_collision too low:</strong> The optimiser may find a smoother path that cuts through obstacle corners. Always verify in simulation first.</li>
<li><strong>Planning horizon too short:</strong> The drone may not see obstacles in time to avoid them at high speed. Rule of thumb: horizon &ge; 2 &times; v_max &times; reaction_time.</li>
</ul>
</div>

<div class="warning-box">
<strong>Hardware Considerations:</strong> On embedded computers (e.g., NVIDIA Jetson, Intel NUC), ensure the grid map resolution is not too fine. A 0.1 m resolution over a 40 m &times; 40 m &times; 5 m volume requires 8 million voxels. For constrained hardware, consider 0.15-0.2 m resolution.
</div>

<div class="activity-box">
<h3>Activity 4: Parameter Sensitivity Analysis</h3>
<p><strong>Duration:</strong> 20 minutes | <strong>Type:</strong> Simulation experiment</p>
<ol>
<li>Launch EGO-Planner in the provided simulation environment with default parameters.</li>
<li>Record the average planning time, trajectory length, and minimum obstacle clearance.</li>
<li>Double \(\lambda_c\) (collision weight) and repeat. How does the trajectory change?</li>
<li>Set \(\lambda_s = 0.1\) (very low smoothness). Observe the trajectory quality.</li>
<li>Increase <code>max_vel</code> to 8.0 m/s. Does the planner still find feasible trajectories?</li>
<li>Create a table comparing all configurations and discuss which is best for (a) racing, (b) mapping.</li>
</ol>
</div>
</div>

<!-- PAGE 19 -->
<div class="page">
<h2>Summary &amp; Key Takeaways</h2>

<div class="info-box">
<h3>Core Concepts</h3>
<ul>
<li><strong>EGO-Planner</strong> is an ESDF-free trajectory optimisation framework that achieves &lt;1 ms planning times</li>
<li><strong>B-spline representation</strong> provides local support, convex hull safety, and automatic smoothness</li>
<li>The cost function \(J = J_s + \lambda_c J_c + \lambda_d J_d\) balances smoothness, safety, and feasibility</li>
<li><strong>L-BFGS</strong> optimisation enables super-linear convergence without storing the Hessian</li>
<li><strong>EGO-Swarm</strong> extends to multi-drone planning via decentralised trajectory broadcasting</li>
</ul>
</div>

<h3>Lab Preview: 7 Tasks</h3>
<div class="checklist">
<ul>
<li>Task 1: Build and launch EGO-Planner in Gazebo with a forest environment</li>
<li>Task 2: Send goal waypoints via RViz and observe trajectory generation</li>
<li>Task 3: Visualise B-spline control points and the convex hull property</li>
<li>Task 4: Experiment with smoothness, collision, and dynamic weights</li>
<li>Task 5: Benchmark planning times with varying obstacle densities</li>
<li>Task 6: Configure and launch a 3-drone EGO-Swarm scenario</li>
<li>Task 7: Record and analyse trajectory data (velocity profiles, clearance, jerk)</li>
</ul>
</div>

<h3>Key Equations Reference Card</h3>
<div class="diagram">
<div class="two-column">
<div>
<p><strong>B-Spline Curve:</strong></p>
<div class="math">\[\mathbf{p}(t) = \sum_{i=0}^{n} N_{i,p}(t)\,\mathbf{Q}_i\]</div>

<p><strong>Total Cost:</strong></p>
<div class="math">\[J = J_s + \lambda_c J_c + \lambda_d J_d\]</div>

<p><strong>Smoothness (Jerk):</strong></p>
<div class="math">\[J_s = \sum_i \|\mathbf{Q}_{i+3} - 3\mathbf{Q}_{i+2} + 3\mathbf{Q}_{i+1} - \mathbf{Q}_i\|^2\]</div>
</div>
<div>
<p><strong>Collision Cost:</strong></p>
<div class="math">\[J_c = \sum_i \max(0,\, d_s - d_i)^3\]</div>

<p><strong>Velocity Bound:</strong></p>
<div class="math">\[\frac{\|\mathbf{Q}_{i+1} - \mathbf{Q}_i\|}{\Delta t} \le v_{max}\]</div>

<p><strong>Acceleration Bound:</strong></p>
<div class="math">\[\frac{\|\mathbf{Q}_{i+2} - 2\mathbf{Q}_{i+1} + \mathbf{Q}_i\|}{\Delta t^2} \le a_{max}\]</div>
</div>
</div>
</div>

<h3>Interview / Exam Questions</h3>
<ol>
<li><strong>ESDF-Free Advantage:</strong> Why does eliminating the ESDF reduce total planning time by 4-10x? What is the trade-off?</li>
<li><strong>B-Spline Properties:</strong> Name three properties of B-splines that make them ideal for drone trajectory optimisation. Explain each.</li>
<li><strong>Dynamic Feasibility:</strong> How does EGO-Planner ensure the optimised trajectory respects velocity and acceleration limits without hard constraints?</li>
<li><strong>EGO-Swarm Coordination:</strong> Explain the decentralised collision avoidance mechanism. What happens if two drones receive each other's trajectory simultaneously?</li>
<li><strong>L-BFGS Suitability:</strong> Why is L-BFGS preferred over Newton's method and gradient descent for this problem? Discuss complexity and convergence.</li>
<li><strong>Tuning Strategies:</strong> You are deploying a drone for (a) racing through gates and (b) bridge inspection. How would you set the optimisation weights differently? Justify your choices.</li>
</ol>

<div class="info-box">
<strong>Next Week:</strong> Week 10 -- Computer Vision for Drones. We will explore visual perception pipelines including camera models, feature detection, optical flow, and depth estimation for autonomous drone operations.
</div>
</div>

</body>
</html>