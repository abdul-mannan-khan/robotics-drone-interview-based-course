<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Week 7: PX4/ArduPilot &amp; ROS2 Integration</title>
<script>
    MathJax = {
        tex: { inlineMath: [['\\(', '\\)']], displayMath: [['\\[', '\\]']] },
        svg: { fontCache: 'global' }
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
<style>
@page { size: A4; margin: 2cm; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
.page { width: 21cm; min-height: 29.7cm; padding: 2cm; margin: 20px auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
.header h1 { font-size: 2.5em; margin-bottom: 10px; }
.header p { font-size: 1.2em; opacity: 0.9; }
h2 { color: #667eea; border-bottom: 3px solid #764ba2; padding-bottom: 10px; margin: 30px 0 20px 0; font-size: 1.8em; }
h3 { color: #764ba2; margin: 25px 0 15px 0; font-size: 1.4em; }
h4 { color: #667eea; margin: 20px 0 10px 0; font-size: 1.2em; }
.info-box { background: #e8f4f8; border-left: 5px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 5px; }
.warning-box { background: #fff4e6; border-left: 5px solid #ff9800; padding: 20px; margin: 20px 0; border-radius: 5px; }
.activity-box { background: #f0f8ff; border: 3px solid #4CAF50; padding: 25px; margin: 30px 0; border-radius: 10px; }
.activity-box h3 { color: #4CAF50; margin-top: 0; }
.image-container { text-align: center; margin: 30px 0; }
.image-container img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.image-caption { font-style: italic; color: #666; margin-top: 10px; font-size: 0.9em; }
ul, ol { margin: 15px 0 15px 30px; }
li { margin: 8px 0; }
.two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
.two-column > * { min-width: 0; overflow: hidden; }
.three-column { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
.three-column > * { min-width: 0; overflow: hidden; }
.checklist { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
.checklist li { list-style: none; padding: 8px 0; }
.checklist li:before { content: "\2713 "; color: #4CAF50; font-weight: bold; margin-right: 10px; }
table { width: 100%; border-collapse: collapse; margin: 20px 0; table-layout: fixed; word-wrap: break-word; }
th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
th { background: #667eea; color: white; }
tr:nth-child(even) { background: #f9f9f9; }
td code { word-break: break-all; }
.diagram { border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin: 20px 0; background: white; }
.flow-step { background: #667eea; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: bold; }
.arrow { text-align: center; font-size: 2em; color: #764ba2; margin: 5px 0; }
.tip { background: #fffbea; border-left: 5px solid #ffd700; padding: 15px; margin: 15px 0; border-radius: 5px; }
.tip:before { content: "\1F4A1 TIP: "; font-weight: bold; color: #ff9800; }
code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; word-break: break-all; }
pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; max-width: 100%; white-space: pre-wrap; word-wrap: break-word; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.5; }
.example-box { background: #f0fff0; border: 2px dashed #4CAF50; padding: 20px; margin: 20px 0; border-radius: 8px; }
.math { padding: 15px; margin: 15px 0; border-radius: 5px; overflow-x: auto; max-width: 100%; }
.sensor-card { background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; text-align: center; }
.sensor-card h4 { color: #667eea; margin-bottom: 10px; }
img { max-width: 100%; height: auto; }
svg { max-width: 100%; height: auto; }
</style>
</head>
<body>

<!-- PAGE 1: Title -->
<div class="page">
    <div class="header">
        <h1>PX4/ArduPilot &amp; ROS2 Integration</h1>
        <p>Week 7 - Robotics &amp; Drone Engineering Robotics &amp; Drone Engineering</p>
        <p>Dr. Abdul Manan Khan | Open Robotics Course</p>
        <p>M.Sc. Robotics &amp; Drone Engineering</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1508614589041-895b88991e3e?w=900&h=500&fit=crop" alt="Drone with flight controller in operation">
        <div class="image-caption">Figure 1.1: Modern autonomous drone systems rely on tight integration between flight controllers and companion computers running ROS2</div>
    </div>

    <div class="info-box">
        <h3>Module Overview</h3>
        <p>This week we bridge the gap between simulation and real-world autonomous flight. You will learn how PX4 and ArduPilot flight controller firmware communicates with ROS2, enabling autonomous missions, offboard control, and sensor fusion on real drone hardware.</p>
    </div>

    <div class="two-column">
        <div class="sensor-card">
            <h4>Prerequisites</h4>
            <ul style="text-align:left;">
                <li>ROS2 Humble fundamentals (Weeks 1-4)</li>
                <li>URDF &amp; Gazebo simulation (Weeks 5-6)</li>
                <li>Python / C++ basics</li>
                <li>Linux command line proficiency</li>
            </ul>
        </div>
        <div class="sensor-card">
            <h4>Software Required</h4>
            <ul style="text-align:left;">
                <li>Ubuntu 22.04 + ROS2 Humble</li>
                <li>PX4-Autopilot (v1.14+)</li>
                <li>Micro XRCE-DDS Agent</li>
                <li>QGroundControl</li>
            </ul>
        </div>
    </div>

    <div class="tip">This lecture contains hands-on activities. Ensure your simulation environment is ready before the session.</div>
</div>

<!-- PAGE 2: Learning Objectives -->
<div class="page">
    <h2>Learning Objectives</h2>

    <div class="info-box">
        <p>By the end of this lecture, you will be able to:</p>
        <ol>
            <li><strong>Explain</strong> the architecture of PX4 and ArduPilot flight controller firmware</li>
            <li><strong>Compare</strong> MAVLink-based (MAVROS) and DDS-based (micro-XRCE-DDS) ROS2 integration approaches</li>
            <li><strong>Implement</strong> offboard control nodes in ROS2 Python to command a PX4 drone</li>
            <li><strong>Configure</strong> PX4 SITL simulation with Gazebo and ROS2</li>
            <li><strong>Integrate</strong> external sensors (LiDAR, depth cameras) via ROS2 into the flight stack</li>
            <li><strong>Apply</strong> safety protocols including fail-safes, geofencing, and pre-flight checklists</li>
        </ol>
    </div>

    <h3>Why Flight Controllers Matter</h3>
    <div class="two-column">
        <div>
            <p>A flight controller is the brain of any autonomous aerial vehicle. It runs at 250-1000 Hz, stabilising the vehicle through rapid sensor fusion and motor mixing. Without it, a multirotor would be uncontrollable.</p>
            <p>The flight controller handles:</p>
            <ul>
                <li>Attitude estimation and stabilisation</li>
                <li>Position and velocity control</li>
                <li>Fail-safe management</li>
                <li>RC input processing</li>
                <li>Communication with ground stations and companion computers</li>
            </ul>
        </div>
        <div class="image-container">
            <img src="https://images.unsplash.com/photo-1473968512647-3e447244af8f?w=450&h=350&fit=crop" alt="Drone in autonomous flight">
            <div class="image-caption">Figure 2.1: Autonomous flight requires robust flight controller integration</div>
        </div>
    </div>

    <h3>From Simulation to Real Flight</h3>
    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1527977966376-1c8408f9f108?w=800&h=350&fit=crop" alt="Drone development workflow">
        <div class="image-caption">Figure 2.2: The development pipeline from simulation to autonomous flight</div>
    </div>

    <div class="diagram">
        <div class="flow-step">1. Algorithm Development in ROS2</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">2. Software-in-the-Loop (SITL) Testing</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">3. Hardware-in-the-Loop (HITL) Validation</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">4. Real-World Flight Testing</div>
    </div>
</div>

<!-- PAGE 3: Flight Controller Overview -->
<div class="page">
    <h2>Flight Controller Hardware Overview</h2>

    <h3>What is a Flight Controller?</h3>
    <p>A flight controller (FC) is a specialised embedded computer that runs real-time firmware to keep an aircraft stable and controllable. Modern FCs like the <strong>Pixhawk 6X</strong> contain multiple redundant sensors and processors.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?w=800&h=400&fit=crop" alt="Flight controller circuit board">
        <div class="image-caption">Figure 3.1: Modern flight controllers pack powerful processors and redundant sensors onto compact boards</div>
    </div>

    <h3>Pixhawk Sensor Suite</h3>
    <svg viewBox="0 0 800 400" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <rect x="250" y="120" width="300" height="160" rx="15" fill="#667eea" stroke="#764ba2" stroke-width="3"/>
        <text x="400" y="195" text-anchor="middle" fill="white" font-size="20" font-weight="bold">PIXHAWK</text>
        <text x="400" y="220" text-anchor="middle" fill="white" font-size="14">Flight Controller</text>
        <text x="400" y="245" text-anchor="middle" fill="white" font-size="12">STM32H7 / F7</text>
        <!-- IMU -->
        <rect x="30" y="20" width="140" height="70" rx="10" fill="#4CAF50"/>
        <text x="100" y="50" text-anchor="middle" fill="white" font-size="14" font-weight="bold">IMU</text>
        <text x="100" y="70" text-anchor="middle" fill="white" font-size="11">Accel + Gyro</text>
        <line x1="170" y1="55" x2="250" y2="160" stroke="#4CAF50" stroke-width="2" marker-end="url(#arrow3)"/>
        <!-- Barometer -->
        <rect x="30" y="140" width="140" height="70" rx="10" fill="#ff9800"/>
        <text x="100" y="170" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Barometer</text>
        <text x="100" y="190" text-anchor="middle" fill="white" font-size="11">MS5611</text>
        <line x1="170" y1="175" x2="250" y2="200" stroke="#ff9800" stroke-width="2"/>
        <!-- Magnetometer -->
        <rect x="30" y="260" width="140" height="70" rx="10" fill="#e91e63"/>
        <text x="100" y="290" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Magnetometer</text>
        <text x="100" y="310" text-anchor="middle" fill="white" font-size="11">IST8310</text>
        <line x1="170" y1="295" x2="250" y2="250" stroke="#e91e63" stroke-width="2"/>
        <!-- GPS -->
        <rect x="630" y="20" width="140" height="70" rx="10" fill="#2196F3"/>
        <text x="700" y="50" text-anchor="middle" fill="white" font-size="14" font-weight="bold">GPS</text>
        <text x="700" y="70" text-anchor="middle" fill="white" font-size="11">u-blox M9N</text>
        <line x1="630" y1="55" x2="550" y2="160" stroke="#2196F3" stroke-width="2"/>
        <!-- RC Receiver -->
        <rect x="630" y="140" width="140" height="70" rx="10" fill="#9C27B0"/>
        <text x="700" y="170" text-anchor="middle" fill="white" font-size="14" font-weight="bold">RC Receiver</text>
        <text x="700" y="190" text-anchor="middle" fill="white" font-size="11">SBUS / CRSF</text>
        <line x1="630" y1="175" x2="550" y2="200" stroke="#9C27B0" stroke-width="2"/>
        <!-- ESCs / Motors -->
        <rect x="630" y="260" width="140" height="70" rx="10" fill="#FF5722"/>
        <text x="700" y="290" text-anchor="middle" fill="white" font-size="14" font-weight="bold">ESCs / Motors</text>
        <text x="700" y="310" text-anchor="middle" fill="white" font-size="11">PWM / DShot</text>
        <line x1="630" y1="295" x2="550" y2="250" stroke="#FF5722" stroke-width="2"/>
        <!-- Companion Computer -->
        <rect x="250" y="330" width="300" height="55" rx="10" fill="#764ba2"/>
        <text x="400" y="362" text-anchor="middle" fill="white" font-size="14" font-weight="bold">Companion Computer (ROS2)</text>
        <line x1="400" y1="280" x2="400" y2="330" stroke="#764ba2" stroke-width="3" stroke-dasharray="8,4"/>
    </svg>
    <div class="image-caption">Figure 3.2: Pixhawk flight controller sensor and peripheral block diagram</div>

    <h3>Key Sensor Specifications</h3>
    <table>
        <tr><th>Sensor</th><th>Type</th><th>Function</th><th>Update Rate</th></tr>
        <tr><td>IMU (ICM-42688)</td><td>6-axis Accel/Gyro</td><td>Attitude estimation</td><td>1-8 kHz</td></tr>
        <tr><td>Barometer (MS5611)</td><td>Pressure sensor</td><td>Altitude estimation</td><td>100 Hz</td></tr>
        <tr><td>Magnetometer (IST8310)</td><td>3-axis compass</td><td>Heading reference</td><td>100 Hz</td></tr>
        <tr><td>GPS (u-blox M9N)</td><td>GNSS receiver</td><td>Global position</td><td>5-10 Hz</td></tr>
    </table>
</div>

<!-- PAGE 4: PX4 Architecture -->
<div class="page">
    <h2>PX4 Autopilot Architecture</h2>

    <p>PX4 is an open-source flight control firmware with a modular, layered architecture. Each module communicates through the <strong>uORB</strong> (micro Object Request Broker) publish-subscribe messaging bus.</p>

    <svg viewBox="0 0 750 520" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <!-- Title -->
        <text x="375" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">PX4 Layered Architecture</text>
        <!-- Application Layer -->
        <rect x="50" y="40" width="650" height="80" rx="10" fill="#667eea" opacity="0.9"/>
        <text x="375" y="70" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Application Layer</text>
        <text x="375" y="95" text-anchor="middle" fill="white" font-size="12">Commander | Navigator | Flight Tasks | Land Detector</text>
        <!-- Flight Control -->
        <rect x="50" y="140" width="650" height="80" rx="10" fill="#764ba2" opacity="0.9"/>
        <text x="375" y="170" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Flight Control Layer</text>
        <text x="375" y="195" text-anchor="middle" fill="white" font-size="12">Position Controller | Attitude Controller | Rate Controller</text>
        <!-- Estimator -->
        <rect x="50" y="240" width="650" height="80" rx="10" fill="#4CAF50" opacity="0.9"/>
        <text x="375" y="270" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Estimator Layer</text>
        <text x="375" y="295" text-anchor="middle" fill="white" font-size="12">EKF2 (Extended Kalman Filter) | Sensor Fusion</text>
        <!-- Mixer -->
        <rect x="50" y="340" width="310" height="70" rx="10" fill="#ff9800" opacity="0.9"/>
        <text x="205" y="370" text-anchor="middle" fill="white" font-size="15" font-weight="bold">Mixer / Actuators</text>
        <text x="205" y="390" text-anchor="middle" fill="white" font-size="11">Motor mixing, PWM output</text>
        <!-- Drivers -->
        <rect x="390" y="340" width="310" height="70" rx="10" fill="#e91e63" opacity="0.9"/>
        <text x="545" y="370" text-anchor="middle" fill="white" font-size="15" font-weight="bold">Drivers</text>
        <text x="545" y="390" text-anchor="middle" fill="white" font-size="11">IMU, Baro, Mag, GPS, RC, Telemetry</text>
        <!-- uORB Bus -->
        <rect x="50" y="430" width="650" height="50" rx="10" fill="#333" opacity="0.9"/>
        <text x="375" y="462" text-anchor="middle" fill="#ffd700" font-size="16" font-weight="bold">uORB Messaging Bus (Publish / Subscribe)</text>
        <!-- Arrows -->
        <line x1="375" y1="120" x2="375" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
        <line x1="375" y1="220" x2="375" y2="240" stroke="#333" stroke-width="2"/>
        <line x1="375" y1="320" x2="205" y2="340" stroke="#333" stroke-width="2"/>
        <line x1="375" y1="320" x2="545" y2="340" stroke="#333" stroke-width="2"/>
        <!-- Vertical bus connections -->
        <line x1="720" y1="80" x2="720" y2="430" stroke="#ffd700" stroke-width="3" stroke-dasharray="6,3"/>
        <line x1="30" y1="80" x2="30" y2="430" stroke="#ffd700" stroke-width="3" stroke-dasharray="6,3"/>
    </svg>
    <div class="image-caption">Figure 4.1: PX4 modular layered architecture with uORB messaging bus</div>

    <h3>Key PX4 Modules</h3>
    <table>
        <tr><th>Module</th><th>Function</th><th>Key uORB Topics</th></tr>
        <tr><td><code>commander</code></td><td>State machine, arming, mode switching</td><td><code>vehicle_status</code>, <code>vehicle_command</code></td></tr>
        <tr><td><code>navigator</code></td><td>Mission execution, waypoints, RTL</td><td><code>mission_result</code>, <code>position_setpoint_triplet</code></td></tr>
        <tr><td><code>ekf2</code></td><td>Extended Kalman Filter state estimation</td><td><code>vehicle_attitude</code>, <code>vehicle_local_position</code></td></tr>
        <tr><td><code>mc_pos_control</code></td><td>Multicopter position controller</td><td><code>vehicle_local_position_setpoint</code></td></tr>
        <tr><td><code>mc_att_control</code></td><td>Multicopter attitude controller</td><td><code>vehicle_attitude_setpoint</code></td></tr>
        <tr><td><code>mixer_module</code></td><td>Motor mixing and actuator output</td><td><code>actuator_outputs</code></td></tr>
    </table>

    <div class="info-box">
        <strong>Control Loop Cascade:</strong> PX4 uses a cascaded PID control architecture:
        <div class="math">
            \[ \text{Position} \xrightarrow{P} \text{Velocity} \xrightarrow{PID} \text{Attitude} \xrightarrow{P} \text{Rate} \xrightarrow{PID} \text{Motor Mixing} \]
        </div>
    </div>
</div>

<!-- PAGE 5: ArduPilot Architecture -->
<div class="page">
    <h2>ArduPilot Architecture</h2>

    <h3>ArduPilot Vehicle Types</h3>
    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1579829366248-204fe8413f31?w=800&h=350&fit=crop" alt="Different types of autonomous vehicles">
        <div class="image-caption">Figure 5.1: ArduPilot supports a wide range of autonomous vehicles</div>
    </div>

    <div class="three-column">
        <div class="sensor-card">
            <h4>ArduCopter</h4>
            <p>Multirotor drones: quad, hex, octo configurations. Most common for aerial robotics research.</p>
        </div>
        <div class="sensor-card">
            <h4>ArduPlane</h4>
            <p>Fixed-wing aircraft and VTOL hybrids. Long-range mapping and survey missions.</p>
        </div>
        <div class="sensor-card">
            <h4>ArduRover / ArduSub</h4>
            <p>Ground vehicles and underwater ROVs. Shared codebase with aerial vehicles.</p>
        </div>
    </div>

    <h3>ArduPilot Architecture</h3>
    <svg viewBox="0 0 750 380" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <text x="375" y="25" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">ArduPilot Software Architecture</text>
        <!-- Vehicle Code -->
        <rect x="200" y="40" width="350" height="60" rx="10" fill="#ff9800"/>
        <text x="375" y="75" text-anchor="middle" fill="white" font-size="15" font-weight="bold">Vehicle Code (Copter / Plane / Rover)</text>
        <!-- Libraries -->
        <rect x="50" y="130" width="200" height="55" rx="8" fill="#667eea"/>
        <text x="150" y="163" text-anchor="middle" fill="white" font-size="13" font-weight="bold">AP_AHRS (EKF)</text>
        <rect x="275" y="130" width="200" height="55" rx="8" fill="#667eea"/>
        <text x="375" y="163" text-anchor="middle" fill="white" font-size="13" font-weight="bold">AC_AttitudeControl</text>
        <rect x="500" y="130" width="200" height="55" rx="8" fill="#667eea"/>
        <text x="600" y="163" text-anchor="middle" fill="white" font-size="13" font-weight="bold">AP_Mission</text>
        <!-- HAL -->
        <rect x="50" y="220" width="650" height="55" rx="10" fill="#764ba2"/>
        <text x="375" y="253" text-anchor="middle" fill="white" font-size="15" font-weight="bold">Hardware Abstraction Layer (AP_HAL)</text>
        <!-- Board -->
        <rect x="50" y="305" width="200" height="50" rx="8" fill="#4CAF50"/>
        <text x="150" y="335" text-anchor="middle" fill="white" font-size="13" font-weight="bold">ChibiOS RTOS</text>
        <rect x="275" y="305" width="200" height="50" rx="8" fill="#4CAF50"/>
        <text x="375" y="335" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Linux (RPi, Jetson)</text>
        <rect x="500" y="305" width="200" height="50" rx="8" fill="#4CAF50"/>
        <text x="600" y="335" text-anchor="middle" fill="white" font-size="13" font-weight="bold">SITL Simulator</text>
        <!-- Connecting lines -->
        <line x1="375" y1="100" x2="150" y2="130" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="100" x2="375" y2="130" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="100" x2="600" y2="130" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="185" x2="375" y2="220" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="275" x2="150" y2="305" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="275" x2="375" y2="305" stroke="#333" stroke-width="1.5"/>
        <line x1="375" y1="275" x2="600" y2="305" stroke="#333" stroke-width="1.5"/>
    </svg>
    <div class="image-caption">Figure 5.2: ArduPilot layered architecture with HAL abstraction</div>

    <h3>PX4 vs ArduPilot Comparison</h3>
    <table>
        <tr><th>Feature</th><th>PX4</th><th>ArduPilot</th></tr>
        <tr><td>Language</td><td>C++ (modern)</td><td>C++ (traditional)</td></tr>
        <tr><td>RTOS</td><td>NuttX</td><td>ChibiOS / Linux</td></tr>
        <tr><td>Messaging</td><td>uORB</td><td>Direct function calls + HAL</td></tr>
        <tr><td>ROS2 Native</td><td>micro-XRCE-DDS</td><td>DDS (experimental) / MAVROS2</td></tr>
        <tr><td>Estimator</td><td>EKF2</td><td>EKF2 / EKF3</td></tr>
        <tr><td>Ground Station</td><td>QGroundControl</td><td>Mission Planner / QGC</td></tr>
        <tr><td>Vehicle Types</td><td>Multi, Fixed, VTOL</td><td>Copter, Plane, Rover, Sub, Blimp</td></tr>
        <tr><td>Community</td><td>Dronecode / Linux Foundation</td><td>ArduPilot Foundation</td></tr>
    </table>
</div>

<!-- PAGE 6: uORB Messaging -->
<div class="page">
    <h2>uORB Messaging System (PX4)</h2>

    <p>uORB (micro Object Request Broker) is PX4's internal publish-subscribe messaging system. It enables decoupled, asynchronous communication between firmware modules running on the flight controller.</p>

    <h3>How uORB Works</h3>
    <svg viewBox="0 0 750 300" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <text x="375" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">uORB Publish / Subscribe Pattern</text>
        <!-- Publisher -->
        <rect x="30" y="60" width="180" height="80" rx="10" fill="#4CAF50"/>
        <text x="120" y="95" text-anchor="middle" fill="white" font-size="14" font-weight="bold">EKF2</text>
        <text x="120" y="115" text-anchor="middle" fill="white" font-size="11">(Publisher)</text>
        <!-- uORB topic -->
        <rect x="270" y="50" width="210" height="100" rx="15" fill="#ffd700" stroke="#ff9800" stroke-width="2"/>
        <text x="375" y="85" text-anchor="middle" fill="#333" font-size="13" font-weight="bold">uORB Topic:</text>
        <text x="375" y="105" text-anchor="middle" fill="#333" font-size="12">vehicle_attitude</text>
        <text x="375" y="125" text-anchor="middle" fill="#666" font-size="10">{q[4], rollspeed, ...}</text>
        <!-- Subscribers -->
        <rect x="540" y="40" width="180" height="50" rx="8" fill="#667eea"/>
        <text x="630" y="72" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Attitude Controller</text>
        <rect x="540" y="100" width="180" height="50" rx="8" fill="#764ba2"/>
        <text x="630" y="132" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Logger</text>
        <!-- Arrows -->
        <line x1="210" y1="100" x2="270" y2="100" stroke="#4CAF50" stroke-width="3" marker-end="url(#a1)"/>
        <line x1="480" y1="85" x2="540" y2="65" stroke="#667eea" stroke-width="2"/>
        <line x1="480" y1="115" x2="540" y2="125" stroke="#764ba2" stroke-width="2"/>
        <!-- Second topic -->
        <rect x="270" y="190" width="210" height="80" rx="15" fill="#ffd700" stroke="#ff9800" stroke-width="2"/>
        <text x="375" y="220" text-anchor="middle" fill="#333" font-size="13" font-weight="bold">uORB Topic:</text>
        <text x="375" y="240" text-anchor="middle" fill="#333" font-size="12">vehicle_local_position</text>
        <rect x="30" y="200" width="180" height="50" rx="10" fill="#4CAF50"/>
        <text x="120" y="232" text-anchor="middle" fill="white" font-size="12" font-weight="bold">EKF2 (Publisher)</text>
        <rect x="540" y="200" width="180" height="50" rx="8" fill="#667eea"/>
        <text x="630" y="232" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Position Controller</text>
        <line x1="210" y1="225" x2="270" y2="230" stroke="#4CAF50" stroke-width="3"/>
        <line x1="480" y1="230" x2="540" y2="225" stroke="#667eea" stroke-width="2"/>
    </svg>
    <div class="image-caption">Figure 6.1: uORB publish-subscribe messaging within PX4</div>

    <h3>Important uORB Topics</h3>
    <table>
        <tr><th>Topic</th><th>Description</th><th>Key Fields</th></tr>
        <tr><td><code>vehicle_attitude</code></td><td>Current orientation quaternion</td><td><code>q[4]</code>, <code>rollspeed</code>, <code>pitchspeed</code>, <code>yawspeed</code></td></tr>
        <tr><td><code>vehicle_local_position</code></td><td>Local NED position and velocity</td><td><code>x</code>, <code>y</code>, <code>z</code>, <code>vx</code>, <code>vy</code>, <code>vz</code></td></tr>
        <tr><td><code>vehicle_global_position</code></td><td>GPS-based lat/lon/alt</td><td><code>lat</code>, <code>lon</code>, <code>alt</code></td></tr>
        <tr><td><code>vehicle_status</code></td><td>Arming state, flight mode</td><td><code>arming_state</code>, <code>nav_state</code></td></tr>
        <tr><td><code>vehicle_command</code></td><td>Commands (arm, mode, etc.)</td><td><code>command</code>, <code>param1-7</code></td></tr>
        <tr><td><code>sensor_combined</code></td><td>Fused IMU data</td><td><code>gyro_rad[3]</code>, <code>accelerometer_m_s2[3]</code></td></tr>
        <tr><td><code>battery_status</code></td><td>Battery voltage and current</td><td><code>voltage_v</code>, <code>remaining</code></td></tr>
        <tr><td><code>trajectory_setpoint</code></td><td>Position/velocity setpoint</td><td><code>position[3]</code>, <code>velocity[3]</code>, <code>yaw</code></td></tr>
    </table>

    <div class="info-box">
        <strong>Key insight:</strong> uORB topics are shared-memory, lock-free, single-writer, multi-reader. Each topic is a fixed-size C struct. When using micro-XRCE-DDS, these uORB topics are bridged directly to ROS2 DDS topics via the <code>px4_msgs</code> package.
    </div>

    <div class="math">
        <p>The EKF2 estimator fuses sensor data using the Extended Kalman Filter prediction-update cycle:</p>
        \[ \hat{x}_{k|k-1} = f(\hat{x}_{k-1|k-1}, u_k) \]
        \[ P_{k|k-1} = F_k P_{k-1|k-1} F_k^T + Q_k \]
        \[ K_k = P_{k|k-1} H_k^T (H_k P_{k|k-1} H_k^T + R_k)^{-1} \]
        \[ \hat{x}_{k|k} = \hat{x}_{k|k-1} + K_k (z_k - h(\hat{x}_{k|k-1})) \]
    </div>
    <p><strong>where:</strong></p>
    <ul>
        <li>\( \hat{x} \) — estimated state vector, \( P \) — state covariance matrix</li>
        <li>\( f(\cdot), h(\cdot) \) — nonlinear motion and measurement models</li>
        <li>\( F_k, H_k \) — Jacobians of the motion and measurement models</li>
        <li>\( Q_k \) — process noise covariance, \( R_k \) — measurement noise covariance</li>
        <li>\( K_k \) — Kalman gain, \( z_k \) — sensor measurement, \( u_k \) — control input</li>
    </ul>
</div>

<!-- PAGE 7: MAVLink Protocol -->
<div class="page">
    <h2>MAVLink Protocol</h2>

    <p>MAVLink (Micro Air Vehicle Link) is a lightweight messaging protocol for communicating with drones. It is the standard protocol used by both PX4 and ArduPilot for ground station and companion computer communication.</p>

    <h3>MAVLink v2 Message Structure</h3>
    <svg viewBox="0 0 750 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <text x="375" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">MAVLink v2 Packet Structure</text>
        <rect x="20" y="50" width="70" height="60" rx="5" fill="#e91e63"/>
        <text x="55" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">STX</text>
        <text x="55" y="95" text-anchor="middle" fill="white" font-size="9">0xFD</text>
        <rect x="95" y="50" width="70" height="60" rx="5" fill="#667eea"/>
        <text x="130" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">LEN</text>
        <text x="130" y="95" text-anchor="middle" fill="white" font-size="9">Payload len</text>
        <rect x="170" y="50" width="70" height="60" rx="5" fill="#764ba2"/>
        <text x="205" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">INC</text>
        <text x="205" y="95" text-anchor="middle" fill="white" font-size="9">Incompat</text>
        <rect x="245" y="50" width="70" height="60" rx="5" fill="#764ba2"/>
        <text x="280" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">CMP</text>
        <text x="280" y="95" text-anchor="middle" fill="white" font-size="9">Compat</text>
        <rect x="320" y="50" width="70" height="60" rx="5" fill="#4CAF50"/>
        <text x="355" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">SEQ</text>
        <text x="355" y="95" text-anchor="middle" fill="white" font-size="9">Sequence</text>
        <rect x="395" y="50" width="70" height="60" rx="5" fill="#ff9800"/>
        <text x="430" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">SYS</text>
        <text x="430" y="95" text-anchor="middle" fill="white" font-size="9">System ID</text>
        <rect x="470" y="50" width="70" height="60" rx="5" fill="#ff9800"/>
        <text x="505" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">COMP</text>
        <text x="505" y="95" text-anchor="middle" fill="white" font-size="9">Comp ID</text>
        <rect x="545" y="50" width="80" height="60" rx="5" fill="#2196F3"/>
        <text x="585" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">MSG ID</text>
        <text x="585" y="95" text-anchor="middle" fill="white" font-size="9">3 bytes</text>
        <rect x="630" y="50" width="90" height="60" rx="5" fill="#333"/>
        <text x="675" y="75" text-anchor="middle" fill="white" font-size="10" font-weight="bold">PAYLOAD</text>
        <text x="675" y="95" text-anchor="middle" fill="white" font-size="9">0-255 bytes</text>
        <rect x="200" y="140" width="170" height="40" rx="5" fill="#e91e63"/>
        <text x="285" y="165" text-anchor="middle" fill="white" font-size="11" font-weight="bold">CRC (2 bytes)</text>
        <rect x="390" y="140" width="170" height="40" rx="5" fill="#9C27B0"/>
        <text x="475" y="165" text-anchor="middle" fill="white" font-size="11" font-weight="bold">SIGNATURE (13 bytes, optional)</text>
    </svg>
    <div class="image-caption">Figure 7.1: MAVLink v2 packet structure with optional signing</div>

    <h3>Common MAVLink Messages</h3>
    <table>
        <tr><th>Message</th><th>ID</th><th>Purpose</th></tr>
        <tr><td><code>HEARTBEAT</code></td><td>#0</td><td>System alive indicator, flight mode, system type</td></tr>
        <tr><td><code>COMMAND_LONG</code></td><td>#76</td><td>Send commands (arm, takeoff, set mode)</td></tr>
        <tr><td><code>SET_POSITION_TARGET_LOCAL_NED</code></td><td>#84</td><td>Position/velocity setpoints in local frame</td></tr>
        <tr><td><code>ATTITUDE</code></td><td>#30</td><td>Current attitude (roll, pitch, yaw)</td></tr>
        <tr><td><code>LOCAL_POSITION_NED</code></td><td>#32</td><td>Local position and velocity</td></tr>
        <tr><td><code>COMMAND_ACK</code></td><td>#77</td><td>Acknowledge command execution</td></tr>
        <tr><td><code>STATUSTEXT</code></td><td>#253</td><td>Human-readable status messages</td></tr>
    </table>

    <h3>Command / Acknowledge Pattern</h3>
    <svg viewBox="0 0 700 220" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <rect x="50" y="30" width="150" height="40" rx="8" fill="#667eea"/>
        <text x="125" y="55" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Companion (ROS2)</text>
        <rect x="450" y="30" width="150" height="40" rx="8" fill="#764ba2"/>
        <text x="525" y="55" text-anchor="middle" fill="white" font-size="13" font-weight="bold">Flight Controller</text>
        <!-- Vertical lifelines -->
        <line x1="125" y1="70" x2="125" y2="210" stroke="#667eea" stroke-width="2" stroke-dasharray="5,3"/>
        <line x1="525" y1="70" x2="525" y2="210" stroke="#764ba2" stroke-width="2" stroke-dasharray="5,3"/>
        <!-- COMMAND_LONG -->
        <line x1="130" y1="100" x2="520" y2="100" stroke="#4CAF50" stroke-width="2"/>
        <polygon points="520,95 520,105 530,100" fill="#4CAF50"/>
        <text x="325" y="93" text-anchor="middle" font-size="12" fill="#333">COMMAND_LONG (MAV_CMD_COMPONENT_ARM_DISARM)</text>
        <!-- ACK -->
        <line x1="520" y1="140" x2="130" y2="140" stroke="#ff9800" stroke-width="2"/>
        <polygon points="130,135 130,145 120,140" fill="#ff9800"/>
        <text x="325" y="133" text-anchor="middle" font-size="12" fill="#333">COMMAND_ACK (result=ACCEPTED)</text>
        <!-- HEARTBEAT -->
        <line x1="520" y1="180" x2="130" y2="180" stroke="#2196F3" stroke-width="2"/>
        <polygon points="130,175 130,185 120,180" fill="#2196F3"/>
        <text x="325" y="173" text-anchor="middle" font-size="12" fill="#333">HEARTBEAT (armed=true, mode=OFFBOARD)</text>
    </svg>
    <div class="image-caption">Figure 7.2: MAVLink command/acknowledge sequence for arming</div>

    <div class="tip">MAVLink operates at 1 Hz for heartbeats by default. Offboard setpoints must be streamed at 2+ Hz or the FC will exit offboard mode.</div>
</div>

<!-- PAGE 8: MAVROS vs micro-XRCE-DDS -->
<div class="page">
    <h2>MAVROS vs micro-XRCE-DDS</h2>

    <p>There are two primary approaches to connecting a flight controller to ROS2. Understanding both is essential for choosing the right architecture for your project.</p>

    <h3>Two Integration Architectures</h3>
    <svg viewBox="0 0 750 450" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <!-- Title -->
        <text x="375" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">ROS2 Flight Controller Integration Approaches</text>
        <!-- Left: MAVROS approach -->
        <text x="190" y="55" text-anchor="middle" font-size="14" font-weight="bold" fill="#667eea">Approach A: MAVROS2</text>
        <rect x="80" y="70" width="220" height="50" rx="8" fill="#667eea"/>
        <text x="190" y="100" text-anchor="middle" fill="white" font-size="13" font-weight="bold">ROS2 Application Node</text>
        <line x1="190" y1="120" x2="190" y2="140" stroke="#333" stroke-width="2"/>
        <rect x="80" y="140" width="220" height="50" rx="8" fill="#4CAF50"/>
        <text x="190" y="170" text-anchor="middle" fill="white" font-size="13" font-weight="bold">MAVROS2 (Bridge)</text>
        <line x1="190" y1="190" x2="190" y2="210" stroke="#333" stroke-width="2"/>
        <rect x="100" y="210" width="180" height="40" rx="5" fill="#ffd700" stroke="#ff9800" stroke-width="2"/>
        <text x="190" y="235" text-anchor="middle" fill="#333" font-size="12" font-weight="bold">MAVLink Serial/UDP</text>
        <line x1="190" y1="250" x2="190" y2="270" stroke="#333" stroke-width="2"/>
        <rect x="80" y="270" width="220" height="50" rx="8" fill="#764ba2"/>
        <text x="190" y="300" text-anchor="middle" fill="white" font-size="13" font-weight="bold">PX4 / ArduPilot FC</text>
        <!-- Right: micro-XRCE-DDS approach -->
        <text x="560" y="55" text-anchor="middle" font-size="14" font-weight="bold" fill="#764ba2">Approach B: micro-XRCE-DDS</text>
        <rect x="450" y="70" width="220" height="50" rx="8" fill="#667eea"/>
        <text x="560" y="100" text-anchor="middle" fill="white" font-size="13" font-weight="bold">ROS2 Application Node</text>
        <line x1="560" y1="120" x2="560" y2="140" stroke="#333" stroke-width="2"/>
        <rect x="450" y="140" width="220" height="50" rx="8" fill="#e91e63"/>
        <text x="560" y="163" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Micro XRCE-DDS Agent</text>
        <text x="560" y="178" text-anchor="middle" fill="white" font-size="10">(DDS ↔ XRCE bridge)</text>
        <line x1="560" y1="190" x2="560" y2="210" stroke="#333" stroke-width="2"/>
        <rect x="470" y="210" width="180" height="40" rx="5" fill="#ffd700" stroke="#ff9800" stroke-width="2"/>
        <text x="560" y="235" text-anchor="middle" fill="#333" font-size="12" font-weight="bold">XRCE-DDS Serial/UDP</text>
        <line x1="560" y1="250" x2="560" y2="270" stroke="#333" stroke-width="2"/>
        <rect x="450" y="270" width="220" height="50" rx="8" fill="#764ba2"/>
        <text x="560" y="292" text-anchor="middle" fill="white" font-size="12" font-weight="bold">PX4 FC + XRCE Client</text>
        <text x="560" y="308" text-anchor="middle" fill="white" font-size="10">(uORB ↔ DDS built-in)</text>
        <!-- Labels -->
        <text x="190" y="350" text-anchor="middle" font-size="11" fill="#666">Translation layer required</text>
        <text x="560" y="350" text-anchor="middle" font-size="11" fill="#666">Native DDS - no translation</text>
        <!-- Divider -->
        <line x1="375" y1="45" x2="375" y2="370" stroke="#ddd" stroke-width="2" stroke-dasharray="8,4"/>
    </svg>
    <div class="image-caption">Figure 8.1: MAVROS2 vs micro-XRCE-DDS architecture comparison</div>

    <h3>Detailed Comparison</h3>
    <table>
        <tr><th>Feature</th><th>MAVROS2</th><th>micro-XRCE-DDS</th></tr>
        <tr><td>Protocol</td><td>MAVLink (v1/v2)</td><td>DDS-XRCE (native)</td></tr>
        <tr><td>Latency</td><td>Higher (serialise/deserialise MAVLink)</td><td>Lower (direct uORB-DDS mapping)</td></tr>
        <tr><td>Topic Access</td><td>Subset via MAVLink messages</td><td>All uORB topics available</td></tr>
        <tr><td>PX4 Support</td><td>Yes (legacy)</td><td>Yes (recommended)</td></tr>
        <tr><td>ArduPilot Support</td><td>Yes (primary method)</td><td>Experimental</td></tr>
        <tr><td>Maturity</td><td>Very mature</td><td>Rapidly evolving</td></tr>
        <tr><td>Setup Complexity</td><td>Moderate</td><td>Moderate</td></tr>
        <tr><td>Bandwidth</td><td>Limited by MAVLink rate</td><td>High (DDS QoS configurable)</td></tr>
    </table>

    <div class="info-box">
        <strong>Recommendation:</strong> For new PX4 projects, use <strong>micro-XRCE-DDS</strong> as it is the officially supported ROS2 integration path. For ArduPilot projects, <strong>MAVROS2</strong> remains the most reliable option as of 2025.
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=750&h=300&fit=crop" alt="Data communication network">
        <div class="image-caption">Figure 8.2: Communication middleware bridges the gap between flight controller and companion computer</div>
    </div>
</div>

<!-- PAGE 9: PX4-ROS2 Bridge -->
<div class="page">
    <h2>PX4-ROS2 Bridge (micro-XRCE-DDS)</h2>

    <h3>Setup Overview</h3>
    <p>The micro-XRCE-DDS bridge allows PX4's internal uORB topics to appear as native ROS2 topics. The <code>px4_msgs</code> package provides pre-built ROS2 message definitions matching every uORB topic.</p>

    <h4>Step 1: Install the Micro XRCE-DDS Agent</h4>
    <pre>git clone https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
cd Micro-XRCE-DDS-Agent
mkdir build && cd build
cmake ..
make -j$(nproc)
sudo make install
sudo ldconfig</pre>

    <h4>Step 2: Clone px4_msgs into Your Workspace</h4>
    <pre>cd ~/ros2_ws/src
git clone https://github.com/PX4/px4_msgs.git
cd ~/ros2_ws
colcon build --packages-select px4_msgs</pre>

    <h4>Step 3: Start the Agent</h4>
    <pre># For SITL (UDP):
MicroXRCEAgent udp4 -p 8888

# For hardware (serial):
MicroXRCEAgent serial --dev /dev/ttyUSB0 -b 921600</pre>

    <h3>ROS2 Topic Mapping</h3>
    <table>
        <tr><th>PX4 uORB Topic</th><th>ROS2 Topic Name</th><th>Message Type</th></tr>
        <tr><td><code>vehicle_attitude</code></td><td><code>/fmu/out/vehicle_attitude</code></td><td><code>px4_msgs/msg/VehicleAttitude</code></td></tr>
        <tr><td><code>vehicle_local_position</code></td><td><code>/fmu/out/vehicle_local_position</code></td><td><code>px4_msgs/msg/VehicleLocalPosition</code></td></tr>
        <tr><td><code>vehicle_status</code></td><td><code>/fmu/out/vehicle_status</code></td><td><code>px4_msgs/msg/VehicleStatus</code></td></tr>
        <tr><td><code>trajectory_setpoint</code></td><td><code>/fmu/in/trajectory_setpoint</code></td><td><code>px4_msgs/msg/TrajectorySetpoint</code></td></tr>
        <tr><td><code>offboard_control_mode</code></td><td><code>/fmu/in/offboard_control_mode</code></td><td><code>px4_msgs/msg/OffboardControlMode</code></td></tr>
        <tr><td><code>vehicle_command</code></td><td><code>/fmu/in/vehicle_command</code></td><td><code>px4_msgs/msg/VehicleCommand</code></td></tr>
    </table>

    <h3>Subscriber Example</h3>
    <pre>import rclpy
from rclpy.node import Node
from rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy
from px4_msgs.msg import VehicleAttitude
import math

class AttitudeListener(Node):
    def __init__(self):
        super().__init__('attitude_listener')
        qos = QoSProfile(
            reliability=ReliabilityPolicy.BEST_EFFORT,
            history=HistoryPolicy.KEEP_LAST,
            depth=1
        )
        self.sub = self.create_subscription(
            VehicleAttitude,
            '/fmu/out/vehicle_attitude',
            self.callback, qos)

    def callback(self, msg):
        # Quaternion to Euler (simplified)
        q = msg.q
        roll = math.atan2(2*(q[0]*q[1]+q[2]*q[3]),
                          1-2*(q[1]**2+q[2]**2))
        self.get_logger().info(
            f'Roll: {math.degrees(roll):.1f} deg')</pre>

    <div class="warning-box">
        <strong>QoS Mismatch Warning:</strong> PX4 publishes with <code>BEST_EFFORT</code> reliability. Your ROS2 subscribers <strong>must</strong> match this QoS setting, otherwise no messages will be received.
    </div>
</div>

<!-- PAGE 10: Offboard Control Mode -->
<div class="page">
    <h2>Offboard Control Mode</h2>

    <h3>What is Offboard Mode?</h3>
    <p>Offboard mode allows an external companion computer running ROS2 to directly command the flight controller with position, velocity, or attitude setpoints. The flight controller still runs its full control stack -- you are providing the <em>reference inputs</em>, not raw motor commands.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1506947411487-a56738571f73?w=800&h=350&fit=crop" alt="Drone hovering autonomously">
        <div class="image-caption">Figure 10.1: Offboard mode enables autonomous hovering and waypoint following</div>
    </div>

    <h3>Safety Requirements</h3>
    <div class="warning-box">
        <strong>CRITICAL SAFETY RULE:</strong> You must stream setpoints at &ge;2 Hz <strong>before</strong> switching to offboard mode. PX4 requires receiving setpoints for at least <strong>2 seconds</strong> before it will accept the mode change. If setpoints stop for &gt;0.5s during flight, PX4 will automatically exit offboard mode.
    </div>

    <h3>Setpoint Types</h3>
    <p>The <code>OffboardControlMode</code> message selects which type of setpoint is active:</p>
    <table>
        <tr><th>Field</th><th>Setpoint Type</th><th>Use Case</th></tr>
        <tr><td><code>position = true</code></td><td>Position (NED)</td><td>Go-to-waypoint, hold position</td></tr>
        <tr><td><code>velocity = true</code></td><td>Velocity (NED)</td><td>Velocity commands, obstacle avoidance</td></tr>
        <tr><td><code>acceleration = true</code></td><td>Acceleration</td><td>Force-based control</td></tr>
        <tr><td><code>attitude = true</code></td><td>Attitude (quaternion)</td><td>Acrobatic manoeuvres</td></tr>
        <tr><td><code>body_rate = true</code></td><td>Angular rates</td><td>Low-level rate control</td></tr>
    </table>

    <div class="info-box">
        <strong>NED Frame:</strong> PX4 uses North-East-Down (NED) coordinates. This means:
        <ul>
            <li>X = North, Y = East, <strong>Z = Down</strong> (negative Z = upward)</li>
            <li>Yaw = 0 points North, positive clockwise</li>
        </ul>
        <div class="math">
            \[ \text{To fly 5m above ground: } z = -5.0 \text{ (NED)} \]
        </div>
    </div>

    <h3>Offboard Mode State Machine</h3>
    <svg viewBox="0 0 700 180" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <rect x="10" y="60" width="120" height="50" rx="25" fill="#667eea"/>
        <text x="70" y="90" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Stream SPs</text>
        <line x1="130" y1="85" x2="170" y2="85" stroke="#333" stroke-width="2"/>
        <text x="150" y="75" text-anchor="middle" font-size="9" fill="#666">2s</text>
        <polygon points="165,80 165,90 175,85" fill="#333"/>
        <rect x="175" y="60" width="110" height="50" rx="25" fill="#4CAF50"/>
        <text x="230" y="90" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Arm</text>
        <line x1="285" y1="85" x2="330" y2="85" stroke="#333" stroke-width="2"/>
        <polygon points="325,80 325,90 335,85" fill="#333"/>
        <rect x="335" y="60" width="130" height="50" rx="25" fill="#ff9800"/>
        <text x="400" y="90" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Set OFFBOARD</text>
        <line x1="465" y1="85" x2="510" y2="85" stroke="#333" stroke-width="2"/>
        <polygon points="505,80 505,90 515,85" fill="#333"/>
        <rect x="515" y="60" width="120" height="50" rx="25" fill="#e91e63"/>
        <text x="575" y="90" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Execute</text>
        <!-- Continue streaming label -->
        <path d="M 575 110 Q 575 150 400 150 Q 70 150 70 110" fill="none" stroke="#764ba2" stroke-width="1.5" stroke-dasharray="5,3"/>
        <text x="325" y="168" text-anchor="middle" font-size="10" fill="#764ba2">Continue streaming setpoints at &ge; 2 Hz</text>
    </svg>
    <div class="image-caption">Figure 10.2: Required state machine for entering offboard control mode</div>

    <div class="warning-box">
        <strong>Kill Switch:</strong> Always have an RC transmitter with a kill switch or mode override channel when testing offboard code on a real drone. Never test offboard mode without the ability to instantly regain manual control.
    </div>
</div>

<!-- PAGE 11: Offboard Control Code -->
<div class="page">
    <h2>Offboard Control: Complete ROS2 Example</h2>

    <p>Below is a complete ROS2 Python node for offboard position control of a PX4 drone. It demonstrates the full workflow: streaming setpoints, arming, entering offboard mode, flying a square, and landing.</p>

    <pre>#!/usr/bin/env python3
import rclpy
from rclpy.node import Node
from rclpy.qos import QoSProfile, ReliabilityPolicy, HistoryPolicy
from px4_msgs.msg import (
    OffboardControlMode, TrajectorySetpoint,
    VehicleCommand, VehicleLocalPosition, VehicleStatus
)

class OffboardControl(Node):
    def __init__(self):
        super().__init__('offboard_control')
        qos = QoSProfile(
            reliability=ReliabilityPolicy.BEST_EFFORT,
            history=HistoryPolicy.KEEP_LAST, depth=1)

        # Publishers
        self.offboard_pub = self.create_publisher(
            OffboardControlMode,
            '/fmu/in/offboard_control_mode', 10)
        self.traj_pub = self.create_publisher(
            TrajectorySetpoint,
            '/fmu/in/trajectory_setpoint', 10)
        self.cmd_pub = self.create_publisher(
            VehicleCommand,
            '/fmu/in/vehicle_command', 10)

        # Subscribers
        self.create_subscription(VehicleLocalPosition,
            '/fmu/out/vehicle_local_position',
            self.pos_cb, qos)
        self.create_subscription(VehicleStatus,
            '/fmu/out/vehicle_status',
            self.status_cb, qos)

        # State
        self.position = [0.0, 0.0, 0.0]
        self.armed = False
        self.offboard_counter = 0
        self.waypoints = [
            [0.0, 0.0, -5.0],   # Takeoff
            [5.0, 0.0, -5.0],   # North
            [5.0, 5.0, -5.0],   # North-East
            [0.0, 5.0, -5.0],   # East
            [0.0, 0.0, -5.0],   # Return
        ]
        self.wp_idx = 0

        self.timer = self.create_timer(0.1, self.timer_cb)

    def pos_cb(self, msg):
        self.position = [msg.x, msg.y, msg.z]

    def status_cb(self, msg):
        self.armed = (msg.arming_state == 2)

    def publish_offboard_mode(self):
        msg = OffboardControlMode()
        msg.position = True
        msg.velocity = False
        msg.acceleration = False
        msg.timestamp = int(self.get_clock().now()
            .nanoseconds / 1000)
        self.offboard_pub.publish(msg)

    def publish_setpoint(self, x, y, z, yaw=0.0):
        msg = TrajectorySetpoint()
        msg.position = [x, y, z]
        msg.yaw = yaw
        msg.timestamp = int(self.get_clock().now()
            .nanoseconds / 1000)
        self.traj_pub.publish(msg)

    def send_command(self, command, p1=0.0, p2=0.0):
        msg = VehicleCommand()
        msg.command = command
        msg.param1 = p1
        msg.param2 = p2
        msg.target_system = 1
        msg.target_component = 1
        msg.source_system = 1
        msg.source_component = 1
        msg.from_external = True
        msg.timestamp = int(self.get_clock().now()
            .nanoseconds / 1000)
        self.cmd_pub.publish(msg)

    def at_waypoint(self, wp, tol=0.5):
        return all(abs(self.position[i] - wp[i]) &lt; tol
                   for i in range(3))

    def timer_cb(self):
        self.publish_offboard_mode()
        wp = self.waypoints[self.wp_idx]
        self.publish_setpoint(*wp)

        if self.offboard_counter == 20:  # After 2s
            self.send_command(176, 1.0, 6.0)  # OFFBOARD
            self.send_command(400, 1.0)  # ARM
        if self.offboard_counter &lt; 21:
            self.offboard_counter += 1

        if self.armed and self.at_waypoint(wp):
            if self.wp_idx &lt; len(self.waypoints) - 1:
                self.wp_idx += 1
                self.get_logger().info(
                    f'Waypoint {self.wp_idx} reached')
            else:
                self.send_command(21)  # LAND
</pre>

    <div class="tip">Command IDs: 176 = MAV_CMD_DO_SET_MODE, 400 = MAV_CMD_COMPONENT_ARM_DISARM, 21 = MAV_CMD_NAV_LAND.</div>
</div>

<!-- PAGE 12: ArduPilot MAVROS2 Integration -->
<div class="page">
    <h2>ArduPilot MAVROS2 Integration</h2>

    <h3>MAVROS2 Setup</h3>
    <pre># Install MAVROS2 for ROS2 Humble
sudo apt install ros-humble-mavros ros-humble-mavros-extras
# Install geographic lib datasets
sudo /opt/ros/humble/lib/mavros/install_geographiclib_datasets.sh</pre>

    <h4>Launch MAVROS2</h4>
    <pre>ros2 launch mavros apm.launch fcu_url:="udp://:14550@" gcs_url:="udp://@localhost:14551"</pre>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1558618666-fcd25c85f82e?w=800&h=350&fit=crop" alt="Autonomous drone systems">
        <div class="image-caption">Figure 12.1: MAVROS2 bridges ArduPilot to ROS2 enabling autonomous drone operations</div>
    </div>

    <h3>Key MAVROS2 Topics and Services</h3>
    <table>
        <tr><th>Topic / Service</th><th>Type</th><th>Purpose</th></tr>
        <tr><td><code>/mavros/state</code></td><td>Topic (sub)</td><td>Armed state, flight mode, connected</td></tr>
        <tr><td><code>/mavros/local_position/pose</code></td><td>Topic (sub)</td><td>Local ENU position</td></tr>
        <tr><td><code>/mavros/setpoint_position/local</code></td><td>Topic (pub)</td><td>Position setpoints</td></tr>
        <tr><td><code>/mavros/cmd/arming</code></td><td>Service</td><td>Arm/disarm vehicle</td></tr>
        <tr><td><code>/mavros/set_mode</code></td><td>Service</td><td>Change flight mode</td></tr>
        <tr><td><code>/mavros/imu/data</code></td><td>Topic (sub)</td><td>IMU data</td></tr>
    </table>

    <h3>MAVROS2 ArduPilot Offboard Example</h3>
    <pre>import rclpy
from rclpy.node import Node
from geometry_msgs.msg import PoseStamped
from mavros_msgs.srv import CommandBool, SetMode
from mavros_msgs.msg import State

class MavrosOffboard(Node):
    def __init__(self):
        super().__init__('mavros_offboard')
        self.state = State()
        self.create_subscription(State,
            '/mavros/state', self.state_cb, 10)
        self.pose_pub = self.create_publisher(
            PoseStamped,
            '/mavros/setpoint_position/local', 10)
        self.arm_client = self.create_client(
            CommandBool, '/mavros/cmd/arming')
        self.mode_client = self.create_client(
            SetMode, '/mavros/set_mode')
        self.timer = self.create_timer(0.05, self.loop)
        self.counter = 0

    def state_cb(self, msg):
        self.state = msg

    def loop(self):
        pose = PoseStamped()
        pose.header.stamp = self.get_clock().now().to_msg()
        pose.pose.position.x = 0.0
        pose.pose.position.y = 0.0
        pose.pose.position.z = 5.0  # ENU: +Z = up
        self.pose_pub.publish(pose)
        self.counter += 1

        if self.counter == 100:  # After 5s
            req = SetMode.Request()
            req.custom_mode = 'GUIDED'
            self.mode_client.call_async(req)
        if self.counter == 120:
            req = CommandBool.Request()
            req.value = True
            self.arm_client.call_async(req)</pre>

    <div class="info-box">
        <strong>Frame Difference:</strong> MAVROS uses <strong>ENU</strong> (East-North-Up) while PX4 native uses <strong>NED</strong> (North-East-Down). MAVROS handles the conversion automatically.
    </div>

    <div class="activity-box">
        <h3>Activity 1: Compare Topic Outputs</h3>
        <p><strong>Objective:</strong> Understand the difference between MAVROS and native PX4-ROS2 topic outputs.</p>
        <ol>
            <li>Launch PX4 SITL with micro-XRCE-DDS agent</li>
            <li>Run <code>ros2 topic list | grep fmu</code> to see native PX4 topics</li>
            <li>Run <code>ros2 topic echo /fmu/out/vehicle_local_position</code></li>
            <li>Note the NED frame values (negative Z = up)</li>
            <li>Now launch MAVROS and echo <code>/mavros/local_position/pose</code></li>
            <li>Compare the coordinate frames and message types</li>
        </ol>
        <p><strong>Expected result:</strong> The same position should show opposite Z signs between NED and ENU representations.</p>
    </div>
</div>

<!-- PAGE 13: Simulation Environments -->
<div class="page">
    <h2>Simulation Environments</h2>

    <p>Before flying a real drone, all code must be tested thoroughly in simulation. Both PX4 and ArduPilot support Software-In-The-Loop (SITL) simulation with multiple physics engines.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=800&h=350&fit=crop" alt="Robot simulation environment">
        <div class="image-caption">Figure 13.1: Simulation environments provide safe testing grounds for autonomous flight algorithms</div>
    </div>

    <h3>Simulation Comparison</h3>
    <table>
        <tr><th>Simulator</th><th>Physics</th><th>PX4</th><th>ArduPilot</th><th>ROS2</th><th>Best For</th></tr>
        <tr><td>Gazebo (Harmonic)</td><td>DART/ODE</td><td>Yes</td><td>Yes</td><td>Native</td><td>Full robotics simulation</td></tr>
        <tr><td>Gazebo Classic 11</td><td>ODE</td><td>Yes</td><td>Yes</td><td>Bridge</td><td>Legacy setups</td></tr>
        <tr><td>jMAVSim</td><td>Basic</td><td>Yes</td><td>No</td><td>No</td><td>Quick PX4 testing</td></tr>
        <tr><td>AirSim</td><td>Unreal Engine</td><td>Yes</td><td>Yes</td><td>Plugin</td><td>Computer vision, photorealism</td></tr>
        <tr><td>Webots</td><td>ODE</td><td>Plugin</td><td>Plugin</td><td>Native</td><td>Education, multi-robot</td></tr>
    </table>

    <h3>PX4 SITL + Gazebo Setup Commands</h3>
    <pre># Terminal 1: Start PX4 SITL with Gazebo
cd ~/PX4-Autopilot
make px4_sitl gz_x500

# Terminal 2: Start micro-XRCE-DDS agent
MicroXRCEAgent udp4 -p 8888

# Terminal 3: Verify ROS2 topics
ros2 topic list | grep /fmu

# Terminal 4: Launch QGroundControl
./QGroundControl.AppImage</pre>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=800&h=350&fit=crop" alt="Technology workspace with monitors">
        <div class="image-caption">Figure 13.2: A typical SITL development setup with multiple terminal windows and QGroundControl</div>
    </div>

    <h3>ArduPilot SITL Setup</h3>
    <pre># Terminal 1: Start ArduPilot SITL
cd ~/ardupilot
sim_vehicle.py -v ArduCopter -f gazebo-iris \
    --console --map

# Terminal 2: Launch MAVROS2
ros2 launch mavros apm.launch \
    fcu_url:="udp://127.0.0.1:14550@14555"

# Terminal 3: Verify
ros2 topic echo /mavros/state</pre>

    <div class="activity-box">
        <h3>Activity 2: Launch PX4 SITL and Echo Topics</h3>
        <p><strong>Objective:</strong> Get PX4 SITL running with ROS2 and inspect available topics.</p>
        <ol>
            <li>Start PX4 SITL: <code>make px4_sitl gz_x500</code></li>
            <li>Start DDS agent: <code>MicroXRCEAgent udp4 -p 8888</code></li>
            <li>List topics: <code>ros2 topic list</code></li>
            <li>Echo attitude: <code>ros2 topic echo /fmu/out/vehicle_attitude</code></li>
            <li>Check publishing rate: <code>ros2 topic hz /fmu/out/vehicle_attitude</code></li>
        </ol>
        <p><strong>Questions:</strong> How many topics are published? What is the attitude update rate? What QoS profile is used?</p>
    </div>
</div>

<!-- PAGE 14: PX4 SITL Setup -->
<div class="page">
    <h2>PX4 SITL Detailed Setup</h2>

    <h3>Complete Build and Run Workflow</h3>

    <h4>1. Clone and Build PX4</h4>
    <pre>git clone https://github.com/PX4/PX4-Autopilot.git \
    --recursive
cd PX4-Autopilot
bash ./Tools/setup/ubuntu.sh  # Install dependencies
make px4_sitl</pre>

    <h4>2. Build px4_msgs Workspace</h4>
    <pre>mkdir -p ~/px4_ros2_ws/src && cd ~/px4_ros2_ws/src
git clone https://github.com/PX4/px4_msgs.git
git clone https://github.com/PX4/px4_ros_com.git
cd ~/px4_ros2_ws
source /opt/ros/humble/setup.bash
colcon build</pre>

    <h4>3. ROS2 Launch File for Offboard Control</h4>
    <pre>from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        Node(
            package='px4_offboard',
            executable='offboard_control',
            name='offboard_control',
            output='screen',
            parameters=[{
                'takeoff_altitude': 5.0,
                'mission_speed': 2.0,
            }]
        ),
    ])</pre>

    <h3>QGroundControl Configuration</h3>
    <div class="two-column">
        <div>
            <p>QGroundControl (QGC) is the primary ground control station for PX4. It connects automatically to SITL via UDP port 14550.</p>
            <h4>Key QGC Features:</h4>
            <ul>
                <li>Real-time telemetry display</li>
                <li>Mission planning with waypoints</li>
                <li>Parameter configuration</li>
                <li>Firmware flashing</li>
                <li>Sensor calibration wizard</li>
                <li>Log analysis (Flight Review)</li>
            </ul>
        </div>
        <div class="image-container">
            <img src="https://images.unsplash.com/photo-1551808525-51a94da548ce?w=400&h=350&fit=crop" alt="Ground control station interface">
            <div class="image-caption">Figure 14.1: Ground control stations provide real-time monitoring and control</div>
        </div>
    </div>

    <h3>Essential PX4 Parameters for Offboard Control</h3>
    <table>
        <tr><th>Parameter</th><th>Default</th><th>Description</th></tr>
        <tr><td><code>COM_OBL_RC_ACT</code></td><td>0</td><td>RC override action in offboard loss (0=position hold)</td></tr>
        <tr><td><code>COM_OF_LOSS_T</code></td><td>1.0s</td><td>Timeout for offboard signal loss</td></tr>
        <tr><td><code>COM_RC_IN_MODE</code></td><td>0</td><td>RC input mode (set to 1 for joystick only)</td></tr>
        <tr><td><code>MPC_XY_VEL_MAX</code></td><td>12 m/s</td><td>Maximum horizontal velocity</td></tr>
        <tr><td><code>MPC_Z_VEL_MAX_UP</code></td><td>3 m/s</td><td>Maximum upward velocity</td></tr>
        <tr><td><code>UXRCE_DDS_CFG</code></td><td>0</td><td>DDS interface config (set to serial port or UDP)</td></tr>
    </table>

    <div class="info-box">
        <strong>Parameter Change:</strong> In PX4 SITL console, set parameters with: <code>param set COM_OF_LOSS_T 5.0</code>. For micro-XRCE-DDS over serial, ensure <code>UXRCE_DDS_CFG</code> is set to the correct UART port number.
    </div>
</div>

<!-- PAGE 15: Sensor Integration via ROS2 -->
<div class="page">
    <h2>Sensor Integration via ROS2</h2>

    <p>One of the biggest advantages of using ROS2 with a flight controller is the ability to integrate external sensors processed on a companion computer. This enables capabilities like obstacle avoidance, SLAM, and visual tracking.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1561557944-6e7860d1a7eb?w=800&h=350&fit=crop" alt="Advanced sensor technology">
        <div class="image-caption">Figure 15.1: External sensors connected through ROS2 extend the perception capabilities of autonomous drones</div>
    </div>

    <h3>Sensor Data Flow Architecture</h3>
    <svg viewBox="0 0 750 350" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <text x="375" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">Companion Computer Sensor Pipeline</text>
        <!-- Sensors -->
        <rect x="10" y="60" width="130" height="50" rx="8" fill="#2196F3"/>
        <text x="75" y="90" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Depth Camera</text>
        <rect x="10" y="130" width="130" height="50" rx="8" fill="#4CAF50"/>
        <text x="75" y="160" text-anchor="middle" fill="white" font-size="12" font-weight="bold">2D LiDAR</text>
        <rect x="10" y="200" width="130" height="50" rx="8" fill="#ff9800"/>
        <text x="75" y="230" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Optical Flow</text>
        <rect x="10" y="270" width="130" height="50" rx="8" fill="#e91e63"/>
        <text x="75" y="300" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Tracking Cam</text>
        <!-- ROS2 Processing -->
        <rect x="200" y="80" width="180" height="220" rx="10" fill="#667eea" opacity="0.15" stroke="#667eea" stroke-width="2"/>
        <text x="290" y="105" text-anchor="middle" font-size="13" font-weight="bold" fill="#667eea">ROS2 Companion</text>
        <rect x="215" y="120" width="150" height="35" rx="5" fill="#667eea"/>
        <text x="290" y="142" text-anchor="middle" fill="white" font-size="11">PointCloud Processing</text>
        <rect x="215" y="165" width="150" height="35" rx="5" fill="#667eea"/>
        <text x="290" y="187" text-anchor="middle" fill="white" font-size="11">Obstacle Detection</text>
        <rect x="215" y="210" width="150" height="35" rx="5" fill="#667eea"/>
        <text x="290" y="232" text-anchor="middle" fill="white" font-size="11">VIO / SLAM</text>
        <rect x="215" y="255" width="150" height="35" rx="5" fill="#667eea"/>
        <text x="290" y="277" text-anchor="middle" fill="white" font-size="11">Path Planner</text>
        <!-- PX4 -->
        <rect x="450" y="120" width="160" height="60" rx="10" fill="#764ba2"/>
        <text x="530" y="148" text-anchor="middle" fill="white" font-size="13" font-weight="bold">PX4 EKF2</text>
        <text x="530" y="168" text-anchor="middle" fill="white" font-size="10">Visual Odometry Input</text>
        <rect x="450" y="220" width="160" height="60" rx="10" fill="#764ba2"/>
        <text x="530" y="248" text-anchor="middle" fill="white" font-size="13" font-weight="bold">PX4 Navigator</text>
        <text x="530" y="268" text-anchor="middle" fill="white" font-size="10">Obstacle Avoidance</text>
        <!-- Drone -->
        <rect x="660" y="160" width="80" height="60" rx="10" fill="#4CAF50"/>
        <text x="700" y="195" text-anchor="middle" fill="white" font-size="13" font-weight="bold">DRONE</text>
        <!-- Arrows -->
        <line x1="140" y1="85" x2="215" y2="137" stroke="#2196F3" stroke-width="2"/>
        <line x1="140" y1="155" x2="215" y2="182" stroke="#4CAF50" stroke-width="2"/>
        <line x1="140" y1="225" x2="215" y2="227" stroke="#ff9800" stroke-width="2"/>
        <line x1="140" y1="295" x2="215" y2="272" stroke="#e91e63" stroke-width="2"/>
        <line x1="365" y1="150" x2="450" y2="150" stroke="#333" stroke-width="2"/>
        <line x1="365" y1="265" x2="450" y2="250" stroke="#333" stroke-width="2"/>
        <line x1="610" y1="150" x2="660" y2="185" stroke="#333" stroke-width="2"/>
        <line x1="610" y1="250" x2="660" y2="200" stroke="#333" stroke-width="2"/>
    </svg>
    <div class="image-caption">Figure 15.2: External sensor data flows through ROS2 to the PX4 flight stack</div>

    <h3>Visual Inertial Odometry (VIO) to PX4</h3>
    <p>PX4 can fuse external vision-based position estimates into EKF2 via the <code>vehicle_visual_odometry</code> uORB topic:</p>
    <pre># Remap T265 tracking camera output to PX4 VIO input
ros2 run topic_tools relay \
    /camera/odom/sample \
    /fmu/in/vehicle_visual_odometry</pre>

    <div class="info-box">
        <strong>EKF2 Parameter:</strong> Set <code>EKF2_EV_CTRL</code> to enable external vision fusion. Bit 0 = horizontal position, Bit 1 = vertical position, Bit 2 = velocity, Bit 3 = yaw.
    </div>

    <h3>Obstacle Avoidance Integration</h3>
    <p>PX4 supports the <code>obstacle_distance</code> uORB topic for range-based collision avoidance. Depth camera or LiDAR data is converted to distance sectors and published via:</p>
    <pre>from px4_msgs.msg import ObstacleDistance
import numpy as np

msg = ObstacleDistance()
msg.frame = 0  # MAV_FRAME_GLOBAL
msg.min_distance = 20    # 20cm minimum
msg.max_distance = 1500  # 15m maximum
msg.increment = 5        # 5 degree bins
# 72 distance values (360/5 = 72 sectors)
msg.distances = distances_cm.tolist()</pre>
</div>

<!-- PAGE 16: Mission Planning -->
<div class="page">
    <h2>Mission Planning</h2>

    <h3>QGroundControl Mission Planning</h3>
    <p>Missions consist of a sequence of mission items (waypoints, commands) that the flight controller executes autonomously. Missions can be planned in QGroundControl and uploaded to the vehicle via MAVLink.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1524661135-423995f22d0b?w=800&h=350&fit=crop" alt="Aerial map view for mission planning">
        <div class="image-caption">Figure 16.1: Mission planning involves defining waypoints on a map for autonomous flight paths</div>
    </div>

    <h3>MAVLink Mission Protocol</h3>
    <svg viewBox="0 0 700 280" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
        <text x="350" y="25" text-anchor="middle" font-size="15" font-weight="bold" fill="#333">Mission Upload Protocol</text>
        <rect x="40" y="45" width="140" height="35" rx="8" fill="#667eea"/>
        <text x="110" y="68" text-anchor="middle" fill="white" font-size="12" font-weight="bold">GCS / ROS2</text>
        <rect x="480" y="45" width="140" height="35" rx="8" fill="#764ba2"/>
        <text x="550" y="68" text-anchor="middle" fill="white" font-size="12" font-weight="bold">Flight Controller</text>
        <line x1="110" y1="80" x2="110" y2="270" stroke="#667eea" stroke-width="1.5" stroke-dasharray="4,3"/>
        <line x1="550" y1="80" x2="550" y2="270" stroke="#764ba2" stroke-width="1.5" stroke-dasharray="4,3"/>
        <!-- Messages -->
        <line x1="115" y1="100" x2="545" y2="100" stroke="#4CAF50" stroke-width="2"/>
        <text x="330" y="95" text-anchor="middle" font-size="11" fill="#333">MISSION_COUNT (n items)</text>
        <line x1="545" y1="130" x2="115" y2="130" stroke="#ff9800" stroke-width="2"/>
        <text x="330" y="125" text-anchor="middle" font-size="11" fill="#333">MISSION_REQUEST_INT (seq=0)</text>
        <line x1="115" y1="160" x2="545" y2="160" stroke="#4CAF50" stroke-width="2"/>
        <text x="330" y="155" text-anchor="middle" font-size="11" fill="#333">MISSION_ITEM_INT (seq=0, lat, lon, alt, cmd)</text>
        <line x1="545" y1="190" x2="115" y2="190" stroke="#ff9800" stroke-width="2"/>
        <text x="330" y="185" text-anchor="middle" font-size="11" fill="#333">MISSION_REQUEST_INT (seq=1)</text>
        <line x1="115" y1="220" x2="545" y2="220" stroke="#4CAF50" stroke-width="2"/>
        <text x="330" y="215" text-anchor="middle" font-size="11" fill="#333">MISSION_ITEM_INT (seq=1, ...)</text>
        <line x1="545" y1="250" x2="115" y2="250" stroke="#2196F3" stroke-width="2"/>
        <text x="330" y="245" text-anchor="middle" font-size="11" fill="#333">MISSION_ACK (accepted)</text>
    </svg>
    <div class="image-caption">Figure 16.2: MAVLink mission upload handshake protocol</div>

    <h3>Mission Item Structure</h3>
    <table>
        <tr><th>Field</th><th>Description</th><th>Example</th></tr>
        <tr><td><code>seq</code></td><td>Sequence number (0-based)</td><td>0, 1, 2, ...</td></tr>
        <tr><td><code>command</code></td><td>MAV_CMD (action type)</td><td>16 = NAV_WAYPOINT</td></tr>
        <tr><td><code>frame</code></td><td>Coordinate frame</td><td>6 = GLOBAL_RELATIVE_ALT</td></tr>
        <tr><td><code>param1</code></td><td>Hold time (seconds)</td><td>5.0</td></tr>
        <tr><td><code>param2</code></td><td>Acceptance radius (m)</td><td>2.0</td></tr>
        <tr><td><code>x (lat)</code></td><td>Latitude (degE7)</td><td>473977418</td></tr>
        <tr><td><code>y (lon)</code></td><td>Longitude (degE7)</td><td>85455940</td></tr>
        <tr><td><code>z (alt)</code></td><td>Altitude (metres)</td><td>25.0</td></tr>
    </table>

    <h3>Common Mission Commands</h3>
    <div class="two-column">
        <div>
            <ul>
                <li><code>MAV_CMD_NAV_WAYPOINT</code> (16) - Navigate to position</li>
                <li><code>MAV_CMD_NAV_LOITER_TIME</code> (19) - Loiter for time</li>
                <li><code>MAV_CMD_NAV_RETURN_TO_LAUNCH</code> (20) - RTL</li>
                <li><code>MAV_CMD_NAV_LAND</code> (21) - Land at location</li>
            </ul>
        </div>
        <div>
            <ul>
                <li><code>MAV_CMD_NAV_TAKEOFF</code> (22) - Takeoff</li>
                <li><code>MAV_CMD_DO_CHANGE_SPEED</code> (178) - Set speed</li>
                <li><code>MAV_CMD_DO_SET_ROI</code> (201) - Point camera</li>
                <li><code>MAV_CMD_IMAGE_START_CAPTURE</code> (2000) - Photo</li>
            </ul>
        </div>
    </div>
</div>

<!-- PAGE 17: Fail-safes & Safety -->
<div class="page">
    <h2>Fail-safes &amp; Safety</h2>

    <div class="warning-box">
        <strong>SAFETY IS PARAMOUNT:</strong> Drones are potentially dangerous machines. Proper fail-safe configuration is not optional -- it is a legal and ethical requirement. A 2kg drone at 20 m/s carries kinetic energy of:
        <div class="math">
            \[ E_k = \frac{1}{2}mv^2 = \frac{1}{2}(2)(20)^2 = 400 \text{ J} \]
        </div>
        <p>This is comparable to a bullet from a small-calibre handgun.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1556388158-158ea5ccacbd?w=800&h=300&fit=crop" alt="Safety equipment and protocols">
        <div class="image-caption">Figure 17.1: Safety protocols and fail-safe systems are critical for responsible drone operation</div>
    </div>

    <h3>PX4 Fail-safe Actions</h3>
    <table>
        <tr><th>Trigger</th><th>Parameter</th><th>Actions Available</th></tr>
        <tr><td>Low Battery</td><td><code>BAT_LOW_THR</code>, <code>COM_LOW_BAT_ACT</code></td><td>Warning, RTL, Land, Terminate</td></tr>
        <tr><td>Critical Battery</td><td><code>BAT_CRIT_THR</code></td><td>Land immediately, Terminate</td></tr>
        <tr><td>RC Signal Loss</td><td><code>COM_RC_LOSS_T</code>, <code>NAV_RCL_ACT</code></td><td>Hold, RTL, Land, Terminate</td></tr>
        <tr><td>Data Link Loss</td><td><code>COM_DL_LOSS_T</code>, <code>NAV_DLL_ACT</code></td><td>Hold, RTL, Land, Terminate</td></tr>
        <tr><td>Offboard Loss</td><td><code>COM_OF_LOSS_T</code>, <code>COM_OBL_RC_ACT</code></td><td>Position hold, RTL, Land</td></tr>
        <tr><td>Geofence Breach</td><td><code>GF_ACTION</code></td><td>Warning, Hold, RTL, Land, Terminate</td></tr>
    </table>

    <h3>Geofencing</h3>
    <div class="two-column">
        <div>
            <p>Geofencing defines virtual boundaries that the drone must stay within. PX4 supports:</p>
            <ul>
                <li><strong>Max altitude:</strong> <code>GF_MAX_HOR_DIST</code></li>
                <li><strong>Max distance:</strong> <code>GF_MAX_VER_DIST</code></li>
                <li><strong>Polygon inclusion zones</strong></li>
                <li><strong>Polygon exclusion zones</strong></li>
                <li><strong>Circular fence</strong></li>
            </ul>
        </div>
        <div>
            <svg viewBox="0 0 300 250" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
                <!-- Geofence polygon -->
                <polygon points="50,30 250,30 280,150 200,230 80,230 20,150" fill="#4CAF50" opacity="0.15" stroke="#4CAF50" stroke-width="3"/>
                <text x="150" y="100" text-anchor="middle" font-size="12" fill="#4CAF50" font-weight="bold">Inclusion Zone</text>
                <!-- Exclusion zone -->
                <rect x="100" y="130" width="80" height="60" rx="5" fill="#e91e63" opacity="0.2" stroke="#e91e63" stroke-width="2" stroke-dasharray="5,3"/>
                <text x="140" y="165" text-anchor="middle" font-size="10" fill="#e91e63" font-weight="bold">Exclusion</text>
                <!-- Home -->
                <circle cx="150" cy="120" r="8" fill="#667eea"/>
                <text x="150" y="115" text-anchor="middle" font-size="8" fill="white" font-weight="bold">H</text>
                <!-- Drone path -->
                <path d="M 150 120 L 200 70 L 230 130" fill="none" stroke="#764ba2" stroke-width="2" stroke-dasharray="4,2"/>
                <circle cx="230" cy="130" r="5" fill="#764ba2"/>
            </svg>
        </div>
    </div>

    <h3>Kill Switch Configuration</h3>
    <div class="warning-box">
        <strong>Emergency Kill:</strong> The kill switch (<code>CBRK_FLIGHTTERM</code>) immediately stops all motors. This should be mapped to an easily accessible RC switch. Set <code>CBRK_FLIGHTTERM = 0</code> to enable flight termination and map it to an RC channel via <code>RC_MAP_KILL_SW</code>.
    </div>

    <div class="activity-box">
        <h3>Activity 3: Configure Fail-safes in SITL</h3>
        <p><strong>Objective:</strong> Understand and configure PX4 fail-safe parameters.</p>
        <ol>
            <li>Launch PX4 SITL</li>
            <li>In the PX4 console, set: <code>param set BAT_LOW_THR 0.3</code></li>
            <li>Set: <code>param set COM_LOW_BAT_ACT 2</code> (RTL on low battery)</li>
            <li>Set: <code>param set GF_MAX_HOR_DIST 50</code> (50m geofence)</li>
            <li>Set: <code>param set GF_ACTION 3</code> (RTL on breach)</li>
            <li>Fly the drone in SITL beyond the geofence and observe the behaviour</li>
        </ol>
        <p><strong>Expected:</strong> The drone should automatically return to launch when it exceeds 50m from home.</p>
    </div>
</div>

<!-- PAGE 18: Real-world Deployment Checklist -->
<div class="page">
    <h2>Real-world Deployment Checklist</h2>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1521405924368-64c5b84bec60?w=800&h=350&fit=crop" alt="Drone prepared for flight">
        <div class="image-caption">Figure 18.1: Thorough pre-flight preparation is essential for safe autonomous flight operations</div>
    </div>

    <h3>Pre-flight Calibration</h3>
    <div class="checklist">
        <ul>
            <li>Accelerometer calibration (6-side calibration in QGC)</li>
            <li>Gyroscope calibration (leave vehicle still on flat surface)</li>
            <li>Magnetometer calibration (rotate vehicle in all axes)</li>
            <li>Level horizon calibration</li>
            <li>Radio calibration (all sticks and switches)</li>
            <li>ESC calibration (if using PWM ESCs)</li>
            <li>Battery voltage/current sensor calibration</li>
        </ul>
    </div>

    <h3>Flight Testing Progression</h3>
    <div class="diagram">
        <div class="flow-step">Phase 1: Tethered Hover Test (manual mode, restrained)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Phase 2: Free Hover (manual, low altitude, open area)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Phase 3: Position Hold (GPS-aided, test stability)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Phase 4: Simple Waypoint Mission (auto mode, few waypoints)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Phase 5: Offboard Control (ROS2, with RC override ready)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Phase 6: Full Autonomous Mission (sensors + path planning)</div>
    </div>

    <h3>Day-of-Flight Checklist</h3>
    <div class="two-column">
        <div class="checklist">
            <h4>Hardware Checks</h4>
            <ul>
                <li>Props secure, correct rotation direction</li>
                <li>Battery fully charged, voltage verified</li>
                <li>All connectors seated firmly</li>
                <li>No loose wires near props</li>
                <li>GPS antenna unobstructed, good lock</li>
                <li>Companion computer powered and booted</li>
                <li>RC transmitter charged, bound, tested</li>
                <li>Kill switch verified functional</li>
            </ul>
        </div>
        <div class="checklist">
            <h4>Software Checks</h4>
            <ul>
                <li>Correct firmware version confirmed</li>
                <li>Parameters loaded and verified</li>
                <li>Fail-safes configured and tested</li>
                <li>ROS2 nodes launching correctly</li>
                <li>DDS/MAVROS communication confirmed</li>
                <li>Geofence set for flight area</li>
                <li>Mission uploaded and reviewed</li>
                <li>Log recording enabled</li>
            </ul>
        </div>
    </div>

    <div class="warning-box">
        <strong>UK Regulations:</strong> Always comply with CAA regulations. For research flights, ensure you have the appropriate permissions (Article 16 exemption or GVC/A2CofC) and operate within the rules of the air. Maintain visual line of sight unless you hold specific BVLOS approvals.
    </div>
</div>

<!-- PAGE 19: Summary & Lab Preview -->
<div class="page">
    <h2>Summary &amp; Lab Preview</h2>

    <h3>Key Takeaways</h3>
    <div class="info-box">
        <ol>
            <li><strong>PX4</strong> uses uORB messaging internally and micro-XRCE-DDS for native ROS2 integration</li>
            <li><strong>ArduPilot</strong> uses MAVROS2 as the primary ROS2 bridge via MAVLink</li>
            <li><strong>Offboard mode</strong> requires streaming setpoints before arming and maintaining &ge;2 Hz</li>
            <li><strong>Simulation (SITL)</strong> is mandatory for all testing before real flights</li>
            <li><strong>Safety</strong>: fail-safes, geofencing, and kill switches are non-negotiable</li>
            <li><strong>Sensor fusion</strong> via ROS2 enables advanced autonomy (VIO, obstacle avoidance)</li>
        </ol>
    </div>

    <h3>Lab Preview: 7 Tasks</h3>
    <div class="activity-box">
        <h3>Activity 4: Lab Preparation</h3>
        <p><strong>Lab Tasks for Week 7:</strong></p>
        <ol>
            <li><strong>Task 1:</strong> Build and launch PX4 SITL with Gazebo and micro-XRCE-DDS agent</li>
            <li><strong>Task 2:</strong> Write a ROS2 subscriber to log vehicle attitude and position data</li>
            <li><strong>Task 3:</strong> Implement the offboard position control node from this lecture</li>
            <li><strong>Task 4:</strong> Fly a square pattern (5m sides) at 5m altitude in offboard mode</li>
            <li><strong>Task 5:</strong> Add velocity-based offboard control and fly a circle using:
                <div class="math">\[ v_x = r \cdot \omega \cos(\omega t), \quad v_y = r \cdot \omega \sin(\omega t) \]</div>
            </li>
            <li><strong>Task 6:</strong> Configure geofence (50m radius) and test fail-safe RTL behaviour</li>
            <li><strong>Task 7:</strong> Integrate a simulated depth camera and publish obstacle distance data</li>
        </ol>
    </div>

    <h3>Key Commands Reference</h3>
    <table>
        <tr><th>Command</th><th>Purpose</th></tr>
        <tr><td><code>make px4_sitl gz_x500</code></td><td>Launch PX4 SITL with Gazebo x500 model</td></tr>
        <tr><td><code>MicroXRCEAgent udp4 -p 8888</code></td><td>Start DDS agent for SITL</td></tr>
        <tr><td><code>ros2 topic list | grep fmu</code></td><td>List PX4 ROS2 topics</td></tr>
        <tr><td><code>commander arm</code></td><td>Arm vehicle (PX4 console)</td></tr>
        <tr><td><code>commander takeoff</code></td><td>Takeoff (PX4 console)</td></tr>
        <tr><td><code>commander land</code></td><td>Land (PX4 console)</td></tr>
        <tr><td><code>param set &lt;NAME&gt; &lt;VAL&gt;</code></td><td>Set PX4 parameter</td></tr>
    </table>

    <h3>Interview / Exam Questions</h3>
    <ol>
        <li>Explain the difference between micro-XRCE-DDS and MAVROS for PX4-ROS2 integration.</li>
        <li>Why must you stream offboard setpoints before arming, and what happens if the stream stops?</li>
        <li>Describe the PX4 cascaded control architecture from position to motor output.</li>
        <li>What is the role of the EKF2 module, and how does external vision data (VIO) integrate with it?</li>
        <li>List three fail-safe conditions and their recommended actions for an autonomous drone.</li>
        <li>Compare PX4 and ArduPilot: what are the strengths and trade-offs of each?</li>
    </ol>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1535378917042-10a22c95931a?w=800&h=300&fit=crop" alt="Drone technology future">
        <div class="image-caption">Figure 19.1: Next week we will explore advanced autonomous navigation and path planning</div>
    </div>
</div>

</body>
</html>
