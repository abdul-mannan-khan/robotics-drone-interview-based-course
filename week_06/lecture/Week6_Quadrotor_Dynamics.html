<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week 6: Quadrotor Dynamics &amp; Attitude Control - TC70045E</title>
    <script>
        MathJax = {
            tex: { inlineMath: [['\\(', '\\)']], displayMath: [['\\[', '\\]']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <style>
        @page { size: A4; margin: 2cm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
        .page { width: 21cm; min-height: 29.7cm; padding: 2cm; margin: 20px auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); page-break-after: always; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        h2 { color: #667eea; border-bottom: 3px solid #764ba2; padding-bottom: 10px; margin: 30px 0 20px 0; font-size: 1.8em; }
        h3 { color: #764ba2; margin: 25px 0 15px 0; font-size: 1.4em; }
        h4 { color: #667eea; margin: 20px 0 10px 0; font-size: 1.2em; }
        .info-box { background: #e8f4f8; border-left: 5px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .warning-box { background: #fff4e6; border-left: 5px solid #ff9800; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .activity-box { background: #f0f8ff; border: 3px solid #4CAF50; padding: 25px; margin: 30px 0; border-radius: 10px; }
        .activity-box h3 { color: #4CAF50; margin-top: 0; }
        .image-container { text-align: center; margin: 30px 0; }
        .image-container img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .image-caption { font-style: italic; color: #666; margin-top: 10px; font-size: 0.9em; }
        ul, ol { margin: 15px 0 15px 30px; }
        li { margin: 8px 0; }
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .two-column > * { min-width: 0; overflow: hidden; }
        .three-column { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0; }
        .three-column > * { min-width: 0; overflow: hidden; }
        .checklist { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .checklist li { list-style: none; padding: 8px 0; }
        .checklist li:before { content: "\2713 "; color: #4CAF50; font-weight: bold; margin-right: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; table-layout: fixed; word-wrap: break-word; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #667eea; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        td code { word-break: break-all; }
        .diagram { border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin: 20px 0; background: white; }
        .flow-step { background: #667eea; color: white; padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; font-weight: bold; }
        .arrow { text-align: center; font-size: 2em; color: #764ba2; margin: 5px 0; }
        .tip { background: #fffbea; border-left: 5px solid #ffd700; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .tip:before { content: "\1F4A1 TIP: "; font-weight: bold; color: #ff9800; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; word-break: break-all; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; max-width: 100%; white-space: pre-wrap; word-wrap: break-word; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.5; }
        .example-box { background: #f0fff0; border: 2px dashed #4CAF50; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .math { padding: 15px; margin: 15px 0; border-radius: 5px; overflow-x: auto; max-width: 100%; }
        .sensor-card { background: white; border: 2px solid #667eea; border-radius: 10px; padding: 20px; text-align: center; }
        .sensor-card h4 { color: #667eea; margin-bottom: 10px; }
        img { max-width: 100%; height: auto; }
        svg { max-width: 100%; height: auto; }
    </style>
</head>
<body>

<!-- PAGE 1: Title -->
<div class="page">
    <div class="header" style="padding: 50px 30px;">
        <p style="font-size: 1.1em; opacity: 0.8;">TC70045E &mdash; Robotics &amp; Drone Engineering M.Sc.</p>
        <h1 style="font-size: 2.8em; margin: 20px 0;">Quadrotor Dynamics &amp; Attitude Control</h1>
        <p style="font-size: 1.3em;">Week 6 Lecture</p>
        <p style="margin-top: 15px;">Dr. Abdul Manan Khan &mdash; University of West London</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1473968512647-3e447244af8f?w=900&h=500&fit=crop" alt="Quadrotor drone in flight against blue sky">
        <p class="image-caption">Figure 1.1 &mdash; A quadrotor UAV performing autonomous flight</p>
    </div>

    <div class="info-box">
        <h3 style="color: #667eea; margin-top: 0;">Lecture Overview</h3>
        <p>This lecture develops the full mathematical model of a quadrotor unmanned aerial vehicle (UAV) from first principles, then introduces the control architectures used to stabilize and command these platforms. We progress from coordinate frames and kinematics through Newton-Euler dynamics to cascaded PID control and state estimation.</p>
    </div>

    <div class="two-column" style="margin-top: 30px;">
        <div class="sensor-card">
            <h4>Prerequisites</h4>
            <ul style="text-align: left;">
                <li>Week 5: Kinematics &amp; Transforms</li>
                <li>Linear algebra (matrices, vectors)</li>
                <li>Basic calculus (derivatives, integrals)</li>
                <li>Classical mechanics fundamentals</li>
            </ul>
        </div>
        <div class="sensor-card">
            <h4>Tools &amp; Software</h4>
            <ul style="text-align: left;">
                <li>ROS 2 Humble</li>
                <li>Python 3 / NumPy / SciPy</li>
                <li>Gazebo Sim</li>
                <li>PX4 / ArduPilot SITL</li>
            </ul>
        </div>
    </div>
</div>

<!-- PAGE 2: Learning Objectives & Applications -->
<div class="page">
    <h2>Learning Objectives</h2>
    <ul class="checklist">
        <li>Describe the quadrotor configuration and motor layout conventions</li>
        <li>Define body, world, and camera coordinate frames and their relationships</li>
        <li>Derive the Newton-Euler equations for a rigid-body quadrotor</li>
        <li>Construct the motor mixing matrix linking rotor speeds to forces and moments</li>
        <li>Linearize the dynamics about a hover equilibrium</li>
        <li>Design cascaded PID controllers for attitude and position</li>
        <li>Implement a complementary filter for attitude estimation</li>
        <li>Simulate the 6-DOF quadrotor model numerically</li>
    </ul>

    <h2>Why Quadrotors?</h2>
    <p>Quadrotors have become the dominant rotary-wing UAV platform due to their mechanical simplicity, agility, and ability to hover. With only four fixed-pitch propellers, all motion control is achieved purely through differential motor speeds &mdash; no swashplate, no cyclic pitch, no tail rotor.</p>

    <h3>Key Application Domains</h3>
    <div class="two-column">
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1508614589041-895b88991e3e?w=400&h=260&fit=crop" alt="Drone performing aerial inspection of infrastructure">
                <p class="image-caption">Figure 2.1 &mdash; Infrastructure inspection</p>
            </div>
            <h4>Delivery &amp; Logistics</h4>
            <p>Autonomous last-mile parcel delivery, medical supply transport to remote areas, and warehouse inventory management using indoor drones.</p>
        </div>
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1527977966376-1c8408f9f108?w=400&h=260&fit=crop" alt="Agricultural drone spraying crops">
                <p class="image-caption">Figure 2.2 &mdash; Precision agriculture</p>
            </div>
            <h4>Agriculture</h4>
            <p>Crop health monitoring via multispectral imaging, precision spraying to reduce chemical usage, and automated field mapping.</p>
        </div>
    </div>
    <div class="two-column">
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1579829366248-204fe8413f31?w=400&h=260&fit=crop" alt="Search and rescue drone with thermal camera">
                <p class="image-caption">Figure 2.3 &mdash; Search and rescue operations</p>
            </div>
            <h4>Search &amp; Rescue</h4>
            <p>Thermal imaging to locate survivors, rapid area coverage in disaster zones, and delivery of emergency supplies to inaccessible locations.</p>
        </div>
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1524143986875-3b098d78b363?w=400&h=260&fit=crop" alt="Drone mapping and surveying terrain">
                <p class="image-caption">Figure 2.4 &mdash; Aerial surveying and mapping</p>
            </div>
            <h4>Inspection &amp; Surveying</h4>
            <p>Bridge and powerline inspection, 3D photogrammetry for construction sites, and environmental monitoring of wildlife habitats.</p>
        </div>
    </div>
</div>

<!-- PAGE 3: Quadrotor Configuration -->
<div class="page">
    <h2>Quadrotor Configuration</h2>
    <p>The physical layout of a quadrotor determines how motor speeds map to forces and torques. The two most common configurations are the <strong>+ (plus)</strong> and <strong>X (cross)</strong> frames, with the X-configuration being dominant in commercial and research platforms.</p>

    <h3>Frame Types</h3>
    <div class="image-container">
        <svg viewBox="0 0 800 300" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <!-- Plus config -->
            <text x="130" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#667eea">+ Configuration</text>
            <line x1="130" y1="80" x2="130" y2="240" stroke="#555" stroke-width="4"/>
            <line x1="50" y1="160" x2="210" y2="160" stroke="#555" stroke-width="4"/>
            <circle cx="130" cy="160" r="10" fill="#764ba2"/>
            <!-- Motors -->
            <circle cx="130" cy="70" r="25" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="130" y="75" text-anchor="middle" font-size="13" fill="#e74c3c" font-weight="bold">M1</text>
            <path d="M115,55 A20,20 0 0,1 145,55" fill="none" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowR)"/>
            <circle cx="130" cy="250" r="25" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="130" y="255" text-anchor="middle" font-size="13" fill="#3498db" font-weight="bold">M3</text>
            <path d="M145,265 A20,20 0 0,1 115,265" fill="none" stroke="#3498db" stroke-width="2" marker-end="url(#arrowB)"/>
            <circle cx="40" cy="160" r="25" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="40" y="165" text-anchor="middle" font-size="13" fill="#3498db" font-weight="bold">M4</text>
            <path d="M55,145 A20,20 0 0,1 55,175" fill="none" stroke="#3498db" stroke-width="2"/>
            <circle cx="220" cy="160" r="25" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="220" y="165" text-anchor="middle" font-size="13" fill="#e74c3c" font-weight="bold">M2</text>
            <path d="M205,175 A20,20 0 0,1 205,145" fill="none" stroke="#e74c3c" stroke-width="2"/>
            <text x="130" y="295" text-anchor="middle" font-size="12" fill="#666">Front = M1</text>

            <!-- X config -->
            <text x="430" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#667eea">X Configuration</text>
            <line x1="355" y1="85" x2="505" y2="235" stroke="#555" stroke-width="4"/>
            <line x1="505" y1="85" x2="355" y2="235" stroke="#555" stroke-width="4"/>
            <circle cx="430" cy="160" r="10" fill="#764ba2"/>
            <circle cx="350" cy="80" r="25" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="350" y="85" text-anchor="middle" font-size="13" fill="#e74c3c" font-weight="bold">M1</text>
            <circle cx="510" cy="80" r="25" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="510" y="85" text-anchor="middle" font-size="13" fill="#3498db" font-weight="bold">M2</text>
            <circle cx="510" cy="240" r="25" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="510" y="245" text-anchor="middle" font-size="13" fill="#e74c3c" font-weight="bold">M3</text>
            <circle cx="350" cy="240" r="25" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="350" y="245" text-anchor="middle" font-size="13" fill="#3498db" font-weight="bold">M4</text>
            <text x="430" y="55" text-anchor="middle" font-size="12" fill="#666">Front</text>
            <line x1="430" y1="60" x2="430" y2="75" stroke="#666" stroke-width="1.5" marker-end="url(#arrowG)"/>
            <text x="430" y="295" text-anchor="middle" font-size="12" fill="#666">Red = CW, Blue = CCW</text>

            <!-- H config -->
            <text x="680" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#667eea">H Configuration</text>
            <rect x="630" y="75" width="100" height="170" rx="5" fill="none" stroke="#555" stroke-width="3"/>
            <line x1="630" y1="110" x2="590" y2="110" stroke="#555" stroke-width="4"/>
            <line x1="730" y1="110" x2="770" y2="110" stroke="#555" stroke-width="4"/>
            <line x1="630" y1="200" x2="590" y2="200" stroke="#555" stroke-width="4"/>
            <line x1="730" y1="200" x2="770" y2="200" stroke="#555" stroke-width="4"/>
            <circle cx="580" cy="110" r="22" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="580" y="115" text-anchor="middle" font-size="12" fill="#e74c3c" font-weight="bold">M1</text>
            <circle cx="780" cy="110" r="22" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="780" y="115" text-anchor="middle" font-size="12" fill="#3498db" font-weight="bold">M2</text>
            <circle cx="780" cy="200" r="22" fill="none" stroke="#e74c3c" stroke-width="2.5"/>
            <text x="780" y="205" text-anchor="middle" font-size="12" fill="#e74c3c" font-weight="bold">M3</text>
            <circle cx="580" cy="200" r="22" fill="none" stroke="#3498db" stroke-width="2.5"/>
            <text x="580" y="205" text-anchor="middle" font-size="12" fill="#3498db" font-weight="bold">M4</text>
            <text x="680" y="295" text-anchor="middle" font-size="12" fill="#666">Elongated body for payload</text>

            <defs>
                <marker id="arrowR" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#e74c3c"/></marker>
                <marker id="arrowB" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#3498db"/></marker>
                <marker id="arrowG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#666"/></marker>
            </defs>
        </svg>
        <p class="image-caption">Figure 3.1 &mdash; Top-down view of the three most common quadrotor frame configurations</p>
    </div>

    <h3>Propeller Direction Convention</h3>
    <p>Adjacent motors spin in <strong>opposite directions</strong> to cancel net yaw torque during hover. Diagonal motors spin in the <strong>same direction</strong>. This is critical for yaw control: increasing speed of all CW motors while decreasing CCW motors produces a net yaw moment.</p>

    <table>
        <tr><th>Frame Type</th><th>Motor Layout</th><th>Advantages</th><th>Common Use</th></tr>
        <tr><td>X-frame</td><td>Arms at 45 degrees</td><td>Camera between front arms; symmetric roll/pitch authority</td><td>FPV racing, cinematography</td></tr>
        <tr><td>+ frame</td><td>Arms at 0/90 degrees</td><td>Simpler dynamics, one motor defines front</td><td>Research, education</td></tr>
        <tr><td>H-frame</td><td>Elongated rectangle</td><td>Large payload bay, modular</td><td>Heavy-lift, cargo drones</td></tr>
        <tr><td>Dead-cat</td><td>Wide front, narrow rear</td><td>Props out of camera FOV</td><td>Aerial photography</td></tr>
    </table>
</div>

<!-- PAGE 4: Coordinate Frames -->
<div class="page">
    <h2>Coordinate Frames</h2>
    <p>Precise definition of coordinate frames is essential for deriving correct equations of motion and ensuring interoperability with ROS 2 and flight controller firmware.</p>

    <h3>Body Frame</h3>
    <div class="two-column">
        <div>
            <p>The body frame is rigidly attached to the quadrotor centre of mass. Two conventions exist:</p>
            <ul>
                <li><strong>FRD (Front-Right-Down):</strong> Used by PX4, ArduPilot, and aerospace. X forward, Y right, Z down.</li>
                <li><strong>FLU (Front-Left-Up):</strong> Used by ROS 2 (REP-103). X forward, Y left, Z up.</li>
            </ul>
            <div class="warning-box">
                <strong>Convention Mismatch:</strong> Mixing FRD and FLU frames is one of the most common bugs in drone software. Always verify which convention your flight stack uses.
            </div>
        </div>
        <div>
            <svg viewBox="0 0 300 280" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
                <text x="150" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="#667eea">FLU Body Frame (ROS 2)</text>
                <rect x="110" y="110" width="80" height="50" rx="8" fill="#ddd" stroke="#555" stroke-width="2"/>
                <text x="150" y="140" text-anchor="middle" font-size="11" fill="#555">Drone</text>
                <!-- X axis - forward -->
                <line x1="150" y1="110" x2="150" y2="40" stroke="#e74c3c" stroke-width="3" marker-end="url(#aRed)"/>
                <text x="162" y="50" font-size="13" fill="#e74c3c" font-weight="bold">X (Front)</text>
                <!-- Y axis - left -->
                <line x1="110" y1="135" x2="40" y2="135" stroke="#27ae60" stroke-width="3" marker-end="url(#aGrn)"/>
                <text x="30" y="155" font-size="13" fill="#27ae60" font-weight="bold">Y (Left)</text>
                <!-- Z axis - up -->
                <circle cx="150" cy="135" r="8" fill="none" stroke="#3498db" stroke-width="3"/>
                <circle cx="150" cy="135" r="2" fill="#3498db"/>
                <text x="170" y="130" font-size="13" fill="#3498db" font-weight="bold">Z (Up)</text>
                <text x="170" y="145" font-size="10" fill="#3498db">(out of page)</text>
                <defs>
                    <marker id="aRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#e74c3c"/></marker>
                    <marker id="aGrn" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#27ae60"/></marker>
                </defs>
            </svg>
        </div>
    </div>

    <h3>World Frames</h3>
    <div class="two-column">
        <div class="sensor-card">
            <h4>NED (North-East-Down)</h4>
            <p>Used by PX4, ArduPilot, and most aerospace applications. X points North, Y points East, Z points Down (into Earth).</p>
            <p style="margin-top:10px;"><strong>Gravity:</strong> \( \mathbf{g} = [0, 0, +g]^T \)</p>
        </div>
        <div class="sensor-card">
            <h4>ENU (East-North-Up)</h4>
            <p>Used by ROS 2 (REP-103/REP-105). X points East, Y points North, Z points Up.</p>
            <p style="margin-top:10px;"><strong>Gravity:</strong> \( \mathbf{g} = [0, 0, -g]^T \)</p>
        </div>
    </div>

    <h3>Camera Frame</h3>
    <p>Computer vision libraries (OpenCV) typically use a frame with X-right, Y-down, Z-forward (optical axis). Transforming between camera and body frames requires a static rotation.</p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1551698618-1dfe5d97d256?w=600&h=300&fit=crop" alt="Drone with downward-facing camera for mapping">
        <p class="image-caption">Figure 4.1 &mdash; Downward-facing camera on a mapping drone; the camera frame differs from the body frame</p>
    </div>

    <div class="info-box">
        <h4 style="margin-top:0;">ROS 2 Convention Summary (REP-103)</h4>
        <ul>
            <li><strong>World frame:</strong> ENU (East-North-Up), frame id: <code>map</code> or <code>odom</code></li>
            <li><strong>Body frame:</strong> FLU (Front-Left-Up), frame id: <code>base_link</code></li>
            <li><strong>Orientation:</strong> Quaternion, with identity = level facing East</li>
            <li><strong>Angular velocity:</strong> Right-hand rule, rad/s</li>
        </ul>
    </div>
</div>

<!-- PAGE 5: Euler Angles & Rotation Matrices -->
<div class="page">
    <h2>Euler Angles &amp; Rotation Matrices</h2>
    <p>Euler angles provide an intuitive way to describe the orientation of the quadrotor body frame relative to the world frame. We use the <strong>ZYX intrinsic</strong> (or equivalently, XYZ extrinsic) rotation sequence, which is standard in aerospace.</p>

    <h3>Roll, Pitch, and Yaw</h3>
    <div class="two-column">
        <div>
            <ul>
                <li><strong>Roll (\(\phi\))</strong> &mdash; rotation about the body X-axis (front axis). Tilts the drone left/right.</li>
                <li><strong>Pitch (\(\theta\))</strong> &mdash; rotation about the body Y-axis (lateral axis). Tilts the drone forward/backward.</li>
                <li><strong>Yaw (\(\psi\))</strong> &mdash; rotation about the body Z-axis (vertical axis). Rotates the drone heading.</li>
            </ul>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1521405924368-64c5b84bec60?w=400&h=250&fit=crop" alt="Drone in banked turn showing roll angle">
                <p class="image-caption">Figure 5.1 &mdash; Visible roll angle during a banked turn</p>
            </div>
        </div>
        <div>
            <svg viewBox="0 0 300 320" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
                <text x="150" y="20" text-anchor="middle" font-size="14" font-weight="bold" fill="#667eea">Euler Angle Rotations</text>
                <!-- Roll -->
                <rect x="20" y="40" width="260" height="70" rx="8" fill="#ffeaea" stroke="#e74c3c" stroke-width="2"/>
                <text x="40" y="65" font-size="14" font-weight="bold" fill="#e74c3c">Roll (phi)</text>
                <text x="40" y="90" font-size="12" fill="#333">Rotation about X-axis by angle phi</text>
                <!-- Pitch -->
                <rect x="20" y="125" width="260" height="70" rx="8" fill="#eafff0" stroke="#27ae60" stroke-width="2"/>
                <text x="40" y="150" font-size="14" font-weight="bold" fill="#27ae60">Pitch (theta)</text>
                <text x="40" y="175" font-size="12" fill="#333">Rotation about Y-axis by angle theta</text>
                <!-- Yaw -->
                <rect x="20" y="210" width="260" height="70" rx="8" fill="#eaf0ff" stroke="#3498db" stroke-width="2"/>
                <text x="40" y="235" font-size="14" font-weight="bold" fill="#3498db">Yaw (psi)</text>
                <text x="40" y="260" font-size="12" fill="#333">Rotation about Z-axis by angle psi</text>
                <text x="150" y="305" text-anchor="middle" font-size="12" fill="#764ba2" font-weight="bold">Sequence: Yaw first, then Pitch, then Roll (ZYX)</text>
            </svg>
        </div>
    </div>

    <h3>Individual Rotation Matrices</h3>
    <div class="math">
        \[
        R_x(\phi) = \begin{bmatrix} 1 & 0 & 0 \\ 0 & \cos\phi & -\sin\phi \\ 0 & \sin\phi & \cos\phi \end{bmatrix}, \quad
        R_y(\theta) = \begin{bmatrix} \cos\theta & 0 & \sin\theta \\ 0 & 1 & 0 \\ -\sin\theta & 0 & \cos\theta \end{bmatrix}, \quad
        R_z(\psi) = \begin{bmatrix} \cos\psi & -\sin\psi & 0 \\ \sin\psi & \cos\psi & 0 \\ 0 & 0 & 1 \end{bmatrix}
        \]
    </div>

    <h3>Combined ZYX Rotation Matrix</h3>
    <p>The full rotation from body to world frame is \( R = R_z(\psi) R_y(\theta) R_x(\phi) \):</p>
    <div class="math">
        \[
        R = \begin{bmatrix}
        c\psi c\theta & c\psi s\theta s\phi - s\psi c\phi & c\psi s\theta c\phi + s\psi s\phi \\
        s\psi c\theta & s\psi s\theta s\phi + c\psi c\phi & s\psi s\theta c\phi - c\psi s\phi \\
        -s\theta & c\theta s\phi & c\theta c\phi
        \end{bmatrix}
        \]
    </div>
    <p>where \( c\alpha = \cos\alpha \) and \( s\alpha = \sin\alpha \).</p>

    <div class="warning-box">
        <strong>Gimbal Lock Warning:</strong> When \(\theta = \pm 90°\), the roll and yaw axes align, causing a loss of one degree of freedom in the Euler angle representation. This is called <strong>gimbal lock</strong>. For aggressive manoeuvres or full 3D rotation, use quaternions instead (next page).
    </div>
</div>

<!-- PAGE 6: Quaternion Representation -->
<div class="page">
    <h2>Quaternion Representation</h2>
    <p>Quaternions provide a singularity-free, compact, and computationally efficient representation of 3D rotations. They are the standard orientation representation in ROS 2 messages (<code>geometry_msgs/Quaternion</code>).</p>

    <h3>Definition</h3>
    <p>A unit quaternion \(\mathbf{q}\) is defined as:</p>
    <div class="math">
        \[
        \mathbf{q} = q_w + q_x \mathbf{i} + q_y \mathbf{j} + q_z \mathbf{k} = \begin{bmatrix} q_w \\ q_x \\ q_y \\ q_z \end{bmatrix}, \quad \|\mathbf{q}\| = 1
        \]
    </div>
    <p>where \(q_w\) is the scalar part and \((q_x, q_y, q_z)\) is the vector part. The unit constraint \(q_w^2 + q_x^2 + q_y^2 + q_z^2 = 1\) means quaternions live on the 3-sphere \(S^3\).</p>

    <h3>Quaternion from Axis-Angle</h3>
    <p>A rotation by angle \(\theta\) about unit axis \(\hat{\mathbf{u}} = (u_x, u_y, u_z)\):</p>
    <div class="math">
        \[
        \mathbf{q} = \begin{bmatrix} \cos(\theta/2) \\ u_x \sin(\theta/2) \\ u_y \sin(\theta/2) \\ u_z \sin(\theta/2) \end{bmatrix}
        \]
    </div>

    <h3>Quaternion Multiplication (Hamilton Product)</h3>
    <p>Composing two rotations \(\mathbf{q}_1\) then \(\mathbf{q}_2\):</p>
    <div class="math">
        \[
        \mathbf{q}_1 \otimes \mathbf{q}_2 = \begin{bmatrix}
        q_{1w}q_{2w} - q_{1x}q_{2x} - q_{1y}q_{2y} - q_{1z}q_{2z} \\
        q_{1w}q_{2x} + q_{1x}q_{2w} + q_{1y}q_{2z} - q_{1z}q_{2y} \\
        q_{1w}q_{2y} - q_{1x}q_{2z} + q_{1y}q_{2w} + q_{1z}q_{2x} \\
        q_{1w}q_{2z} + q_{1x}q_{2y} - q_{1y}q_{2x} + q_{1z}q_{2w}
        \end{bmatrix}
        \]
    </div>

    <h3>Rotating a Vector</h3>
    <p>To rotate vector \(\mathbf{v}\) by quaternion \(\mathbf{q}\), form the pure quaternion \(\mathbf{v}' = (0, v_x, v_y, v_z)\) and compute:</p>
    <div class="math">
        \[ \mathbf{v}_{\text{rotated}} = \mathbf{q} \otimes \mathbf{v}' \otimes \mathbf{q}^* \]
    </div>
    <p>where \(\mathbf{q}^* = (q_w, -q_x, -q_y, -q_z)\) is the conjugate.</p>

    <h3>Euler to Quaternion Conversion</h3>
    <div class="math">
        \[
        \mathbf{q} = \begin{bmatrix}
        \cos\frac{\phi}{2}\cos\frac{\theta}{2}\cos\frac{\psi}{2} + \sin\frac{\phi}{2}\sin\frac{\theta}{2}\sin\frac{\psi}{2} \\
        \sin\frac{\phi}{2}\cos\frac{\theta}{2}\cos\frac{\psi}{2} - \cos\frac{\phi}{2}\sin\frac{\theta}{2}\sin\frac{\psi}{2} \\
        \cos\frac{\phi}{2}\sin\frac{\theta}{2}\cos\frac{\psi}{2} + \sin\frac{\phi}{2}\cos\frac{\theta}{2}\sin\frac{\psi}{2} \\
        \cos\frac{\phi}{2}\cos\frac{\theta}{2}\sin\frac{\psi}{2} - \sin\frac{\phi}{2}\sin\frac{\theta}{2}\cos\frac{\psi}{2}
        \end{bmatrix}
        \]
    </div>

    <div class="two-column">
        <div class="info-box">
            <h4 style="margin-top:0;">Advantages over Euler Angles</h4>
            <ul>
                <li>No gimbal lock singularity</li>
                <li>Smooth interpolation (SLERP)</li>
                <li>4 parameters vs. 9 (rotation matrix)</li>
                <li>Numerically stable composition</li>
            </ul>
        </div>
        <div class="warning-box">
            <h4 style="margin-top:0;">Quaternion Pitfalls</h4>
            <ul>
                <li>\(\mathbf{q}\) and \(-\mathbf{q}\) represent the same rotation (double cover)</li>
                <li>Must renormalize after numerical integration</li>
                <li>Convention varies: Hamilton vs. JPL ordering</li>
            </ul>
        </div>
    </div>
</div>

<!-- PAGE 7: Newton-Euler Equations -->
<div class="page">
    <h2>Newton-Euler Equations of Motion</h2>
    <p>We model the quadrotor as a rigid body with mass \(m\) and inertia tensor \(\mathbf{I}\). The Newton-Euler formulation separates the dynamics into translational and rotational components.</p>

    <h3>Free-Body Diagram</h3>
    <div class="image-container">
        <svg viewBox="0 0 600 350" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <!-- Drone body -->
            <line x1="200" y1="160" x2="400" y2="160" stroke="#555" stroke-width="4"/>
            <line x1="300" y1="100" x2="300" y2="220" stroke="#555" stroke-width="4"/>
            <circle cx="300" cy="160" r="12" fill="#764ba2"/>
            <text x="315" y="155" font-size="11" fill="#764ba2" font-weight="bold">CoM</text>
            <!-- Thrust arrows -->
            <line x1="200" y1="160" x2="200" y2="90" stroke="#e74c3c" stroke-width="3" marker-end="url(#aUp)"/>
            <text x="180" y="80" font-size="12" fill="#e74c3c" font-weight="bold">T1</text>
            <line x1="400" y1="160" x2="400" y2="90" stroke="#e74c3c" stroke-width="3" marker-end="url(#aUp)"/>
            <text x="407" y="80" font-size="12" fill="#e74c3c" font-weight="bold">T2</text>
            <line x1="300" y1="100" x2="300" y2="30" stroke="#e74c3c" stroke-width="3" marker-end="url(#aUp)"/>
            <text x="310" y="30" font-size="12" fill="#e74c3c" font-weight="bold">T3</text>
            <line x1="300" y1="220" x2="300" y2="280" stroke="#e74c3c" stroke-width="3" stroke-dasharray="none"/>
            <text x="310" y="290" font-size="12" fill="#e74c3c" font-weight="bold">T4</text>
            <line x1="300" y1="220" x2="300" y2="285" stroke="#e74c3c" stroke-width="3"/>
            <line x1="295" y1="280" x2="300" y2="290" stroke="#e74c3c" stroke-width="3"/>
            <line x1="305" y1="280" x2="300" y2="290" stroke="#e74c3c" stroke-width="3"/>
            <!-- Gravity -->
            <line x1="300" y1="175" x2="300" y2="340" stroke="#3498db" stroke-width="3" stroke-dasharray="6,4"/>
            <text x="310" y="335" font-size="13" fill="#3498db" font-weight="bold">mg</text>
            <!-- Arm labels -->
            <text x="240" y="178" font-size="11" fill="#555">L</text>
            <line x1="205" y1="170" x2="295" y2="170" stroke="#555" stroke-width="1" stroke-dasharray="3,3"/>
            <!-- Coordinate axes at CoM -->
            <text x="450" y="100" font-size="12" fill="#667eea" font-weight="bold">Body Frame</text>
            <line x1="470" y1="120" x2="470" y2="160" stroke="#e74c3c" stroke-width="2"/>
            <text x="478" y="140" font-size="10" fill="#e74c3c">z_b</text>
            <line x1="470" y1="160" x2="520" y2="160" stroke="#27ae60" stroke-width="2"/>
            <text x="510" y="155" font-size="10" fill="#27ae60">x_b</text>
            <circle cx="470" cy="160" r="4" fill="#3498db"/>
            <text x="455" y="175" font-size="10" fill="#3498db">y_b (out)</text>
            <defs>
                <marker id="aUp" markerWidth="8" markerHeight="6" refX="4" refY="6" orient="auto"><path d="M0,6 L4,0 L8,6Z" fill="#e74c3c"/></marker>
            </defs>
        </svg>
        <p class="image-caption">Figure 7.1 &mdash; Free-body diagram of a quadrotor in + configuration showing thrust forces and gravity</p>
    </div>

    <h3>Translational Dynamics (Newton's Second Law)</h3>
    <p>In the world frame, the position \(\mathbf{p} = [x, y, z]^T\) evolves according to:</p>
    <div class="math">
        \[
        m \ddot{\mathbf{p}} = \begin{bmatrix} 0 \\ 0 \\ -mg \end{bmatrix} + R(\phi,\theta,\psi) \begin{bmatrix} 0 \\ 0 \\ T \end{bmatrix}
        \]
    </div>
    <p>where \(T = T_1 + T_2 + T_3 + T_4\) is the total thrust (always along the body Z-axis) and \(R\) is the rotation matrix from body to world.</p>

    <h3>Rotational Dynamics (Euler's Equation)</h3>
    <p>In the body frame, the angular velocity \(\boldsymbol{\omega} = [p, q, r]^T\) evolves according to:</p>
    <div class="math">
        \[
        \mathbf{I} \dot{\boldsymbol{\omega}} = \boldsymbol{\tau} - \boldsymbol{\omega} \times (\mathbf{I} \boldsymbol{\omega})
        \]
    </div>
    <p>where the inertia tensor for a symmetric quadrotor is:</p>
    <div class="math">
        \[
        \mathbf{I} = \begin{bmatrix} I_{xx} & 0 & 0 \\ 0 & I_{yy} & 0 \\ 0 & 0 & I_{zz} \end{bmatrix}
        \]
    </div>

    <p>Expanding component-wise:</p>
    <div class="math">
        \[
        \begin{aligned}
        I_{xx} \dot{p} &= \tau_x + (I_{yy} - I_{zz}) q r \\
        I_{yy} \dot{q} &= \tau_y + (I_{zz} - I_{xx}) p r \\
        I_{zz} \dot{r} &= \tau_z + (I_{xx} - I_{yy}) p q
        \end{aligned}
        \]
    </div>
</div>

<!-- PAGE 8: Forces & Moments / Motor Mixing -->
<div class="page">
    <h2>Quadrotor Forces &amp; Moments</h2>

    <h3>Aerodynamic Models</h3>
    <p>Each rotor \(i\) spinning at angular velocity \(\omega_i\) generates:</p>
    <div class="two-column">
        <div class="info-box">
            <h4 style="margin-top:0;">Thrust Force</h4>
            <div class="math">
                \[ T_i = k_T \, \omega_i^2 \]
            </div>
            <p>where \(k_T\) is the thrust coefficient (N/(rad/s)&sup2;), determined by propeller geometry, air density, and blade profile.</p>
        </div>
        <div class="info-box">
            <h4 style="margin-top:0;">Drag Torque</h4>
            <div class="math">
                \[ Q_i = k_Q \, \omega_i^2 \]
            </div>
            <p>where \(k_Q\) is the drag coefficient. The ratio \(k_Q / k_T\) is approximately constant for a given propeller.</p>
        </div>
    </div>

    <h3>Force and Moment Mapping (X-Configuration)</h3>
    <p>For an X-frame quadrotor with arm length \(L\) (centre to motor), the moment arm is \(d = L / \sqrt{2}\). The total thrust and torques are:</p>

    <div class="image-container">
        <svg viewBox="0 0 500 250" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <line x1="170" y1="55" x2="330" y2="195" stroke="#555" stroke-width="3"/>
            <line x1="330" y1="55" x2="170" y2="195" stroke="#555" stroke-width="3"/>
            <circle cx="250" cy="125" r="8" fill="#764ba2"/>
            <!-- Motor labels with directions -->
            <circle cx="165" cy="50" r="22" fill="#ffeaea" stroke="#e74c3c" stroke-width="2"/>
            <text x="165" y="55" text-anchor="middle" font-size="12" font-weight="bold" fill="#e74c3c">M1 CCW</text>
            <circle cx="335" cy="50" r="22" fill="#eaf0ff" stroke="#3498db" stroke-width="2"/>
            <text x="335" y="55" text-anchor="middle" font-size="12" font-weight="bold" fill="#3498db">M2 CW</text>
            <circle cx="335" cy="200" r="22" fill="#ffeaea" stroke="#e74c3c" stroke-width="2"/>
            <text x="335" y="205" text-anchor="middle" font-size="12" font-weight="bold" fill="#e74c3c">M3 CCW</text>
            <circle cx="165" cy="200" r="22" fill="#eaf0ff" stroke="#3498db" stroke-width="2"/>
            <text x="165" y="205" text-anchor="middle" font-size="12" font-weight="bold" fill="#3498db">M4 CW</text>
            <text x="250" y="35" text-anchor="middle" font-size="12" fill="#666">Front</text>
            <!-- d label -->
            <line x1="250" y1="125" x2="170" y2="55" stroke="#764ba2" stroke-width="1" stroke-dasharray="4,3"/>
            <text x="195" y="100" font-size="12" fill="#764ba2" font-weight="bold">L</text>
        </svg>
        <p class="image-caption">Figure 8.1 &mdash; X-configuration motor layout with rotation directions</p>
    </div>

    <h3>Motor Mixing Matrix</h3>
    <p>The relationship between squared rotor speeds and the body-frame wrench is:</p>
    <div class="math">
        \[
        \begin{bmatrix} T \\ \tau_x \\ \tau_y \\ \tau_z \end{bmatrix}
        =
        \underbrace{\begin{bmatrix}
        k_T & k_T & k_T & k_T \\
        d \, k_T & -d \, k_T & -d \, k_T & d \, k_T \\
        d \, k_T & d \, k_T & -d \, k_T & -d \, k_T \\
        -k_Q & k_Q & -k_Q & k_Q
        \end{bmatrix}}_{\mathbf{M}}
        \begin{bmatrix} \omega_1^2 \\ \omega_2^2 \\ \omega_3^2 \\ \omega_4^2 \end{bmatrix}
        \]
    </div>
    <p>where \(d = L\sin(45°) = L/\sqrt{2}\) for the X-frame. The inverse \(\mathbf{M}^{-1}\) is used by the <strong>control allocator</strong> to convert desired thrust and torques into individual motor speed commands.</p>

    <div class="tip">
        The signs in the mixing matrix depend on the motor numbering convention and rotation directions. Always verify against your flight controller's documentation (e.g., PX4 Airframe Reference).
    </div>

    <table>
        <tr><th>Control Input</th><th>Motor Speed Change</th><th>Effect</th></tr>
        <tr><td>Throttle (T up)</td><td>All increase equally</td><td>Climb / increase altitude</td></tr>
        <tr><td>Roll (\(\tau_x\))</td><td>Left pair up, right pair down</td><td>Lateral translation</td></tr>
        <tr><td>Pitch (\(\tau_y\))</td><td>Rear pair up, front pair down</td><td>Forward/backward translation</td></tr>
        <tr><td>Yaw (\(\tau_z\))</td><td>CW pair up, CCW pair down</td><td>Heading rotation</td></tr>
    </table>
</div>

<!-- PAGE 9: Full 6-DOF Dynamics -->
<div class="page">
    <h2>Full 6-DOF State-Space Model</h2>
    <p>The complete quadrotor model has <strong>12 states</strong> representing the full translational and rotational degrees of freedom.</p>

    <h3>State Vector</h3>
    <div class="math">
        \[
        \mathbf{x} = \begin{bmatrix} x & y & z & \dot{x} & \dot{y} & \dot{z} & \phi & \theta & \psi & p & q & r \end{bmatrix}^T
        \]
    </div>
    <p>where \((x,y,z)\) is position in the world frame, \((\dot{x},\dot{y},\dot{z})\) is velocity, \((\phi,\theta,\psi)\) are Euler angles, and \((p,q,r)\) are body-frame angular rates.</p>

    <h3>Complete Equations of Motion</h3>

    <h4>Kinematics (Position)</h4>
    <div class="math">
        \[ \dot{x} = v_x, \quad \dot{y} = v_y, \quad \dot{z} = v_z \]
    </div>

    <h4>Translational Dynamics</h4>
    <div class="math">
        \[
        \begin{aligned}
        m \dot{v}_x &= (\cos\phi\sin\theta\cos\psi + \sin\phi\sin\psi) \, T \\
        m \dot{v}_y &= (\cos\phi\sin\theta\sin\psi - \sin\phi\cos\psi) \, T \\
        m \dot{v}_z &= -mg + (\cos\phi\cos\theta) \, T
        \end{aligned}
        \]
    </div>

    <h4>Attitude Kinematics</h4>
    <p>The relationship between Euler angle rates and body angular rates:</p>
    <div class="math">
        \[
        \begin{bmatrix} \dot{\phi} \\ \dot{\theta} \\ \dot{\psi} \end{bmatrix}
        =
        \begin{bmatrix}
        1 & \sin\phi\tan\theta & \cos\phi\tan\theta \\
        0 & \cos\phi & -\sin\phi \\
        0 & \sin\phi\sec\theta & \cos\phi\sec\theta
        \end{bmatrix}
        \begin{bmatrix} p \\ q \\ r \end{bmatrix}
        \]
    </div>

    <h4>Rotational Dynamics</h4>
    <div class="math">
        \[
        \begin{aligned}
        \dot{p} &= \frac{1}{I_{xx}} \left[ \tau_x - (I_{zz} - I_{yy}) q r \right] \\
        \dot{q} &= \frac{1}{I_{yy}} \left[ \tau_y - (I_{xx} - I_{zz}) p r \right] \\
        \dot{r} &= \frac{1}{I_{zz}} \left[ \tau_z - (I_{yy} - I_{xx}) p q \right]
        \end{aligned}
        \]
    </div>

    <div class="info-box">
        <h4 style="margin-top:0;">Gyroscopic Effects (Propeller Angular Momentum)</h4>
        <p>An additional coupling term arises from the spinning propellers. If \(J_r\) is the rotor moment of inertia and \(\Omega_r = -\omega_1 + \omega_2 - \omega_3 + \omega_4\) is the net rotor speed, then gyroscopic torques \(J_r \Omega_r \times \boldsymbol{\omega}\) should be added. For small quadrotors these are often negligible, but they matter for large propellers.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1506947411487-a56738571f73?w=600&h=300&fit=crop" alt="Quadrotor drone hovering stably demonstrating 6-DOF control">
        <p class="image-caption">Figure 9.1 &mdash; Stable hover requires balancing all 6 degrees of freedom simultaneously</p>
    </div>
</div>

<!-- PAGE 10: Linearization -->
<div class="page">
    <h2>Linearization About Hover</h2>
    <p>The nonlinear dynamics derived in previous pages are difficult to control directly. By linearizing about the <strong>hover equilibrium</strong>, we obtain a linear time-invariant (LTI) system amenable to classical control techniques.</p>

    <h3>Hover Equilibrium Point</h3>
    <div class="math">
        \[
        \mathbf{x}_0 = \mathbf{0}_{12 \times 1}, \quad T_0 = mg, \quad \tau_{x,0} = \tau_{y,0} = \tau_{z,0} = 0
        \]
    </div>
    <p>At hover: all velocities and angular rates are zero, all angles are zero, and total thrust equals weight.</p>

    <h3>Small-Angle Approximations</h3>
    <p>For small perturbations about hover (\(\phi, \theta, \psi \approx 0\)):</p>
    <div class="math">
        \[
        \sin\alpha \approx \alpha, \quad \cos\alpha \approx 1, \quad \tan\alpha \approx \alpha
        \]
    </div>

    <h3>Linearized Translational Dynamics</h3>
    <p>Substituting small-angle approximations and \(T \approx mg + \delta T\):</p>
    <div class="math">
        \[
        \begin{aligned}
        m \ddot{x} &\approx mg \, \theta + \delta T \cdot \psi \approx mg\,\theta \quad \text{(for small } \psi\text{)} \\
        m \ddot{y} &\approx -mg \, \phi \\
        m \ddot{z} &\approx -mg + mg + \delta T = \delta T
        \end{aligned}
        \]
    </div>

    <h3>Linearized Rotational Dynamics</h3>
    <p>Since cross-coupling terms \(qr, pr, pq\) are second-order small:</p>
    <div class="math">
        \[
        I_{xx}\ddot{\phi} = \tau_x, \quad I_{yy}\ddot{\theta} = \tau_y, \quad I_{zz}\ddot{\psi} = \tau_z
        \]
    </div>

    <h3>Decoupled State-Space Form</h3>
    <p>The linearized system decouples into independent subsystems. For example, the roll-lateral subsystem:</p>
    <div class="math">
        \[
        \frac{d}{dt}\begin{bmatrix} y \\ \dot{y} \\ \phi \\ p \end{bmatrix}
        =
        \underbrace{\begin{bmatrix} 0 & 1 & 0 & 0 \\ 0 & 0 & -g & 0 \\ 0 & 0 & 0 & 1 \\ 0 & 0 & 0 & 0 \end{bmatrix}}_{\mathbf{A}}
        \begin{bmatrix} y \\ \dot{y} \\ \phi \\ p \end{bmatrix}
        +
        \underbrace{\begin{bmatrix} 0 \\ 0 \\ 0 \\ 1/I_{xx} \end{bmatrix}}_{\mathbf{B}}
        \tau_x
        \]
    </div>

    <div class="info-box">
        <h4 style="margin-top:0;">Why Linearize?</h4>
        <ul>
            <li><strong>Controllability analysis:</strong> The pair \((\mathbf{A}, \mathbf{B})\) is controllable, confirming we can stabilize the system.</li>
            <li><strong>PID and LQR design:</strong> Linear control theory provides systematic tuning methods.</li>
            <li><strong>Stability proofs:</strong> Eigenvalue analysis gives rigorous stability guarantees near hover.</li>
            <li><strong>Limitation:</strong> Valid only for small perturbations. Aggressive flight requires nonlinear control.</li>
        </ul>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1557800636-894a64c1696f?w=600&h=280&fit=crop" alt="Drone hovering at low altitude demonstrating stable hover point">
        <p class="image-caption">Figure 10.1 &mdash; Hover is the natural equilibrium point used for linearization</p>
    </div>
</div>

<!-- PAGE 11: PID Attitude Control -->
<div class="page">
    <h2>PID Attitude Control</h2>
    <p>The most widely used control architecture for quadrotors is a <strong>cascaded PID</strong> structure with an inner rate loop and an outer angle loop.</p>

    <h3>PID Control Law</h3>
    <div class="math">
        \[
        u(t) = K_p \, e(t) + K_i \int_0^t e(\tau) \, d\tau + K_d \, \frac{de(t)}{dt}
        \]
    </div>
    <p>where \(e(t) = r(t) - y(t)\) is the tracking error between the reference \(r\) and the measured output \(y\).</p>

    <h3>Cascaded Architecture</h3>
    <div class="diagram">
        <svg viewBox="0 0 700 180" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <!-- Angle reference -->
            <text x="10" y="75" font-size="12" fill="#333">Angle Ref</text>
            <rect x="90" y="50" width="110" height="50" rx="8" fill="#667eea" stroke="none"/>
            <text x="145" y="80" text-anchor="middle" font-size="12" fill="white" font-weight="bold">Angle PID</text>
            <line x1="200" y1="75" x2="240" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrBlk)"/>
            <text x="220" y="65" font-size="10" fill="#764ba2">Rate Ref</text>
            <rect x="240" y="50" width="110" height="50" rx="8" fill="#764ba2" stroke="none"/>
            <text x="295" y="80" text-anchor="middle" font-size="12" fill="white" font-weight="bold">Rate PID</text>
            <line x1="350" y1="75" x2="390" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrBlk)"/>
            <text x="370" y="65" font-size="10" fill="#555">Torque</text>
            <rect x="390" y="50" width="100" height="50" rx="8" fill="#e67e22" stroke="none"/>
            <text x="440" y="80" text-anchor="middle" font-size="12" fill="white" font-weight="bold">Mixer</text>
            <line x1="490" y1="75" x2="530" y2="75" stroke="#333" stroke-width="2" marker-end="url(#arrBlk)"/>
            <rect x="530" y="50" width="90" height="50" rx="8" fill="#27ae60" stroke="none"/>
            <text x="575" y="80" text-anchor="middle" font-size="12" fill="white" font-weight="bold">Motors</text>
            <!-- Feedback -->
            <line x1="575" y1="100" x2="575" y2="150" stroke="#333" stroke-width="1.5"/>
            <line x1="575" y1="150" x2="145" y2="150" stroke="#333" stroke-width="1.5"/>
            <line x1="145" y1="150" x2="145" y2="100" stroke="#333" stroke-width="1.5" marker-end="url(#arrBlk)"/>
            <text x="360" y="165" text-anchor="middle" font-size="11" fill="#555">IMU Feedback (gyro + accelerometer)</text>
            <rect x="290" y="130" width="80" height="30" rx="5" fill="#f39c12" stroke="none"/>
            <text x="330" y="150" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Estimator</text>
            <defs>
                <marker id="arrBlk" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#333"/></marker>
            </defs>
        </svg>
        <p class="image-caption">Figure 11.1 &mdash; Cascaded PID attitude control block diagram</p>
    </div>

    <h3>Why Cascade?</h3>
    <ul>
        <li>The <strong>inner rate loop</strong> (fast, ~250-1000 Hz) rejects disturbances and stabilizes angular rates.</li>
        <li>The <strong>outer angle loop</strong> (slower, ~50-250 Hz) provides tracking of desired angles.</li>
        <li>Cascading allows independent tuning: tune the inner loop first, then the outer loop.</li>
    </ul>

    <h3>Typical PID Gains</h3>
    <table>
        <tr><th>Loop</th><th>Axis</th><th>K_p</th><th>K_i</th><th>K_d</th><th>Rate (Hz)</th></tr>
        <tr><td>Rate (inner)</td><td>Roll/Pitch</td><td>0.15</td><td>0.05</td><td>0.003</td><td>500</td></tr>
        <tr><td>Rate (inner)</td><td>Yaw</td><td>0.20</td><td>0.10</td><td>0.000</td><td>500</td></tr>
        <tr><td>Angle (outer)</td><td>Roll/Pitch</td><td>6.0</td><td>0.0</td><td>0.0</td><td>250</td></tr>
        <tr><td>Angle (outer)</td><td>Yaw</td><td>4.0</td><td>0.5</td><td>0.0</td><td>250</td></tr>
    </table>
    <p><em>Note: These are representative values for a 250 mm racing quad. Actual gains depend on mass, inertia, and motor response.</em></p>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=600&h=280&fit=crop" alt="FPV racing drone demonstrating agile attitude control">
        <p class="image-caption">Figure 11.2 &mdash; FPV racing drones demand aggressive PID tuning for rapid attitude changes</p>
    </div>
</div>

<!-- PAGE 12: PID Tuning -->
<div class="page">
    <h2>PID Tuning for Quadrotors</h2>

    <h3>Systematic Tuning Approach</h3>
    <div class="diagram">
        <div class="flow-step">Step 1: Set K_i = K_d = 0. Increase K_p until oscillation begins.</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Step 2: Reduce K_p to ~60% of oscillation value. Add K_d to dampen overshoot.</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Step 3: Add small K_i to eliminate steady-state error. Watch for wind-up.</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Step 4: Tune inner rate loop FIRST, then outer angle loop.</div>
    </div>

    <h3>Ziegler-Nichols Method</h3>
    <p>Find the ultimate gain \(K_u\) (where sustained oscillation occurs) and the ultimate period \(T_u\), then:</p>
    <table>
        <tr><th>Controller</th><th>\(K_p\)</th><th>\(K_i\)</th><th>\(K_d\)</th></tr>
        <tr><td>P only</td><td>\(0.5 K_u\)</td><td>0</td><td>0</td></tr>
        <tr><td>PI</td><td>\(0.45 K_u\)</td><td>\(0.54 K_u / T_u\)</td><td>0</td></tr>
        <tr><td>PID</td><td>\(0.6 K_u\)</td><td>\(1.2 K_u / T_u\)</td><td>\(0.075 K_u T_u\)</td></tr>
    </table>

    <h3>Anti-Windup</h3>
    <p>When actuators saturate, the integrator continues accumulating error, causing <strong>integrator windup</strong>. Mitigation strategies:</p>
    <ul>
        <li><strong>Clamping:</strong> Stop integration when output is saturated.</li>
        <li><strong>Back-calculation:</strong> Feed back the saturation error to reduce the integrator.</li>
        <li><strong>Integral limits:</strong> Clamp the integral term to a maximum value.</li>
    </ul>

    <div class="warning-box">
        <strong>Safety First:</strong> Always tune in simulation before flying. Start with very low gains. Secure the quadrotor (e.g., test stand) for initial real-world tuning. Have a kill switch ready.
    </div>

    <div class="activity-box">
        <h3>Activity 1: PID Tuning in Simulation</h3>
        <p><strong>Objective:</strong> Tune a cascaded PID controller for a simulated quadrotor to achieve stable hover.</p>
        <ol>
            <li>Launch the provided Python quadrotor simulator with default (zero) gains.</li>
            <li>Tune the roll/pitch rate PID (inner loop) to achieve critically damped step response.</li>
            <li>Tune the roll/pitch angle PID (outer loop) with rise time &lt; 0.3 s and overshoot &lt; 10%.</li>
            <li>Record your final gains and step response plots.</li>
            <li>Introduce a 5 m/s wind disturbance. Does your controller reject it? Adjust K_i if needed.</li>
        </ol>
        <p><strong>Deliverable:</strong> Screenshot of stable hover with plotted angle response and final gain table.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1535378917042-10a22c95931a?w=600&h=280&fit=crop" alt="Drone on test stand for PID tuning">
        <p class="image-caption">Figure 12.1 &mdash; Using a test stand for safe real-world PID tuning</p>
    </div>
</div>

<!-- PAGE 13: Altitude & Position Control -->
<div class="page">
    <h2>Altitude &amp; Position Control</h2>
    <p>Hovering at a desired location requires <strong>outer-loop position control</strong> that generates attitude references for the inner attitude controller. This creates a full <strong>cascaded hierarchy</strong>.</p>

    <h3>Full Cascaded Control Architecture</h3>
    <div class="image-container">
        <svg viewBox="0 0 750 280" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <!-- Position loop -->
            <rect x="10" y="30" width="100" height="45" rx="6" fill="#9b59b6"/>
            <text x="60" y="58" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Position PID</text>
            <text x="60" y="20" text-anchor="middle" font-size="10" fill="#764ba2">x,y,z ref</text>
            <line x1="110" y1="52" x2="140" y2="52" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>

            <!-- Velocity loop -->
            <rect x="140" y="30" width="100" height="45" rx="6" fill="#8e44ad"/>
            <text x="190" y="58" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Velocity PID</text>
            <line x1="240" y1="52" x2="270" y2="52" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>

            <!-- Attitude setpoint generation -->
            <rect x="270" y="20" width="110" height="65" rx="6" fill="#e74c3c"/>
            <text x="325" y="48" text-anchor="middle" font-size="9" fill="white" font-weight="bold">Desired Accel</text>
            <text x="325" y="62" text-anchor="middle" font-size="9" fill="white" font-weight="bold">to Attitude</text>
            <line x1="380" y1="52" x2="410" y2="52" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>

            <!-- Angle loop -->
            <rect x="410" y="30" width="90" height="45" rx="6" fill="#667eea"/>
            <text x="455" y="58" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Angle PID</text>
            <line x1="500" y1="52" x2="530" y2="52" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>

            <!-- Rate loop -->
            <rect x="530" y="30" width="90" height="45" rx="6" fill="#2c3e50"/>
            <text x="575" y="58" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Rate PID</text>
            <line x1="620" y1="52" x2="650" y2="52" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>

            <!-- Mixer & Motors -->
            <rect x="650" y="30" width="80" height="45" rx="6" fill="#27ae60"/>
            <text x="690" y="58" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Mixer</text>

            <!-- Frequency labels -->
            <text x="60" y="95" text-anchor="middle" font-size="9" fill="#999">~10 Hz</text>
            <text x="190" y="95" text-anchor="middle" font-size="9" fill="#999">~50 Hz</text>
            <text x="455" y="95" text-anchor="middle" font-size="9" fill="#999">~250 Hz</text>
            <text x="575" y="95" text-anchor="middle" font-size="9" fill="#999">~500 Hz</text>

            <!-- Altitude separate -->
            <rect x="10" y="140" width="730" height="120" rx="8" fill="#f8f9fa" stroke="#667eea" stroke-width="1.5"/>
            <text x="375" y="165" text-anchor="middle" font-size="13" font-weight="bold" fill="#667eea">Altitude Control (Decoupled)</text>
            <rect x="30" y="185" width="100" height="40" rx="6" fill="#f39c12"/>
            <text x="80" y="210" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Alt PID</text>
            <text x="80" y="178" text-anchor="middle" font-size="9" fill="#333">z_ref</text>
            <line x1="130" y1="205" x2="170" y2="205" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>
            <rect x="170" y="185" width="120" height="40" rx="6" fill="#e67e22"/>
            <text x="230" y="210" text-anchor="middle" font-size="10" fill="white" font-weight="bold">Climb Rate PID</text>
            <line x1="290" y1="205" x2="330" y2="205" stroke="#333" stroke-width="2" marker-end="url(#arrBlk2)"/>
            <text x="360" y="210" font-size="11" fill="#333">delta T &rarr; Mixer</text>

            <defs>
                <marker id="arrBlk2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#333"/></marker>
            </defs>
        </svg>
        <p class="image-caption">Figure 13.1 &mdash; Full cascaded control architecture from position to motor commands</p>
    </div>

    <h3>Desired Acceleration to Attitude Conversion</h3>
    <p>The velocity/position controller outputs a desired acceleration \(\mathbf{a}_d = [a_x, a_y, a_z]^T\). We convert this to attitude references:</p>
    <div class="math">
        \[
        \begin{aligned}
        T &= m \sqrt{a_x^2 + a_y^2 + (a_z + g)^2} \\
        \phi_d &= \arcsin\left(\frac{m(a_x \sin\psi - a_y \cos\psi)}{T}\right) \\
        \theta_d &= \arctan\left(\frac{a_x \cos\psi + a_y \sin\psi}{a_z + g}\right)
        \end{aligned}
        \]
    </div>
    <p><strong>where:</strong></p>
    <ul>
        <li>\( T \) — total thrust command</li>
        <li>\( \phi_d, \theta_d \) — desired roll and pitch angles</li>
        <li>\( a_x, a_y, a_z \) — desired accelerations from the position/velocity controller</li>
        <li>\( \psi \) — current yaw angle</li>
        <li>\( m \) — quadrotor mass</li>
        <li>\( g \) — gravitational acceleration</li>
    </ul>

    <div class="activity-box">
        <h3>Activity 2: Position Hold Controller</h3>
        <p><strong>Objective:</strong> Extend your attitude controller with an outer position loop.</p>
        <ol>
            <li>Implement a P controller for position that outputs desired velocity.</li>
            <li>Add a PD controller for velocity that outputs desired acceleration.</li>
            <li>Convert desired acceleration to attitude reference and thrust.</li>
            <li>Test waypoint tracking: fly a 2 m square at 1 m altitude.</li>
        </ol>
        <p><strong>Deliverable:</strong> 3D trajectory plot showing commanded vs. actual path.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1487887235947-a955ef187fcc?w=600&h=280&fit=crop" alt="Drone autonomously following a waypoint path">
        <p class="image-caption">Figure 13.2 &mdash; Autonomous waypoint navigation requires precise position control</p>
    </div>
</div>

<!-- PAGE 14: State Estimation -->
<div class="page">
    <h2>State Estimation for Attitude Control</h2>
    <p>Raw sensor data from the IMU (accelerometer + gyroscope) must be fused to obtain a reliable attitude estimate. The gyroscope provides fast but drifting angular rate data; the accelerometer provides a noisy but drift-free gravity reference.</p>

    <h3>Complementary Filter</h3>
    <p>The simplest and most intuitive sensor fusion approach:</p>
    <div class="math">
        \[
        \hat{\phi}_{k} = \alpha \left( \hat{\phi}_{k-1} + \dot{\phi}_{\text{gyro}} \cdot \Delta t \right) + (1 - \alpha) \, \phi_{\text{accel}}
        \]
    </div>
    <p>where \(\alpha \in [0.95, 0.99]\) is the filter coefficient. High \(\alpha\) trusts the gyroscope more (less noise, more drift); low \(\alpha\) trusts the accelerometer more.</p>

    <div class="image-container">
        <svg viewBox="0 0 650 200" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
            <text x="50" y="40" font-size="12" font-weight="bold" fill="#333">Gyroscope</text>
            <rect x="10" y="50" width="100" height="35" rx="5" fill="#667eea"/>
            <text x="60" y="73" text-anchor="middle" font-size="10" fill="white">Integrate</text>
            <line x1="110" y1="67" x2="160" y2="67" stroke="#333" stroke-width="2" marker-end="url(#arrBlk3)"/>
            <rect x="160" y="50" width="80" height="35" rx="5" fill="#764ba2"/>
            <text x="200" y="73" text-anchor="middle" font-size="10" fill="white">x alpha</text>
            <line x1="240" y1="67" x2="310" y2="100" stroke="#333" stroke-width="2"/>

            <text x="50" y="130" font-size="12" font-weight="bold" fill="#333">Accelerometer</text>
            <rect x="10" y="140" width="100" height="35" rx="5" fill="#e74c3c"/>
            <text x="60" y="163" text-anchor="middle" font-size="10" fill="white">atan2</text>
            <line x1="110" y1="157" x2="160" y2="157" stroke="#333" stroke-width="2" marker-end="url(#arrBlk3)"/>
            <rect x="160" y="140" width="80" height="35" rx="5" fill="#e67e22"/>
            <text x="200" y="163" text-anchor="middle" font-size="10" fill="white">x (1-alpha)</text>
            <line x1="240" y1="157" x2="310" y2="120" stroke="#333" stroke-width="2"/>

            <circle cx="320" cy="110" r="15" fill="#27ae60"/>
            <text x="320" y="115" text-anchor="middle" font-size="16" fill="white" font-weight="bold">+</text>
            <line x1="335" y1="110" x2="420" y2="110" stroke="#333" stroke-width="2" marker-end="url(#arrBlk3)"/>
            <rect x="420" y="92" width="120" height="35" rx="5" fill="#2c3e50"/>
            <text x="480" y="115" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Attitude Est.</text>
            <defs>
                <marker id="arrBlk3" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6Z" fill="#333"/></marker>
            </defs>
        </svg>
        <p class="image-caption">Figure 14.1 &mdash; Complementary filter block diagram</p>
    </div>

    <h3>Madgwick and Mahony Filters</h3>
    <div class="two-column">
        <div class="sensor-card">
            <h4>Madgwick Filter</h4>
            <p>Uses gradient descent optimization to find the quaternion that aligns the accelerometer (and optionally magnetometer) measurements with the expected gravity/magnetic field vectors. Very efficient &mdash; ~270 operations per update.</p>
        </div>
        <div class="sensor-card">
            <h4>Mahony Filter</h4>
            <p>Uses a proportional-integral observer on SO(3). Computes the cross product between measured and expected gravity direction as an error signal, then applies a PI correction to the gyroscope integration.</p>
        </div>
    </div>

    <div class="info-box">
        <h4 style="margin-top:0;">In ROS 2</h4>
        <p>The <code>imu_complementary_filter</code> and <code>imu_filter_madgwick</code> packages provide ready-to-use attitude estimation nodes. They subscribe to <code>sensor_msgs/Imu</code> and publish fused orientation as a quaternion.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&h=280&fit=crop" alt="IMU sensor board with accelerometer and gyroscope chips">
        <p class="image-caption">Figure 14.2 &mdash; A MEMS IMU chip combining 3-axis accelerometer, gyroscope, and often magnetometer</p>
    </div>
</div>

<!-- PAGE 15: Motor Dynamics & Actuator Limits -->
<div class="page">
    <h2>Motor Dynamics &amp; Actuator Limits</h2>
    <p>The assumption of instantaneous thrust response is unrealistic. Brushless DC motors have finite response times that must be modelled for accurate simulation and controller design.</p>

    <h3>First-Order Motor Model</h3>
    <p>The motor speed \(\omega_i\) responds to a commanded speed \(\omega_i^{\text{cmd}}\) as a first-order system:</p>
    <div class="math">
        \[
        \dot{\omega}_i = \frac{1}{\tau_m} \left( \omega_i^{\text{cmd}} - \omega_i \right)
        \]
    </div>
    <p>where \(\tau_m\) is the motor time constant (typically 20-50 ms for small drones, 50-150 ms for larger ones).</p>

    <h3>PWM to Thrust Mapping</h3>
    <div class="two-column">
        <div>
            <p>Flight controllers output PWM signals (typically 1000-2000 &micro;s) to Electronic Speed Controllers (ESCs). The mapping from PWM to thrust is generally nonlinear:</p>
            <div class="math">
                \[ T = a \cdot \text{PWM}^2 + b \cdot \text{PWM} + c \]
            </div>
            <p>This quadratic (or higher-order polynomial) is determined through thrust-stand calibration. Many flight stacks apply a <strong>linearization lookup table</strong> so the pilot/controller sees a linear throttle response.</p>
        </div>
        <div>
            <svg viewBox="0 0 300 250" style="width:100%;height:auto;" xmlns="http://www.w3.org/2000/svg">
                <text x="150" y="20" text-anchor="middle" font-size="13" font-weight="bold" fill="#667eea">Thrust vs PWM</text>
                <!-- Axes -->
                <line x1="50" y1="220" x2="280" y2="220" stroke="#333" stroke-width="2"/>
                <line x1="50" y1="220" x2="50" y2="30" stroke="#333" stroke-width="2"/>
                <text x="165" y="245" text-anchor="middle" font-size="11" fill="#333">PWM (us)</text>
                <text x="25" y="125" text-anchor="middle" font-size="11" fill="#333" transform="rotate(-90,25,125)">Thrust (N)</text>
                <!-- Curve -->
                <path d="M50,220 Q100,215 140,195 Q180,170 210,130 Q240,80 270,35" fill="none" stroke="#e74c3c" stroke-width="3"/>
                <!-- Linear reference -->
                <line x1="50" y1="220" x2="270" y2="35" stroke="#3498db" stroke-width="1.5" stroke-dasharray="6,4"/>
                <text x="200" y="180" font-size="10" fill="#e74c3c">Actual (nonlinear)</text>
                <text x="100" y="100" font-size="10" fill="#3498db">Ideal (linear)</text>
                <!-- Axis ticks -->
                <text x="50" y="235" font-size="9" fill="#666">1000</text>
                <text x="160" y="235" font-size="9" fill="#666">1500</text>
                <text x="265" y="235" font-size="9" fill="#666">2000</text>
            </svg>
        </div>
    </div>

    <h3>Actuator Saturation</h3>
    <p>Motor speeds are bounded: \(\omega_{\min} \leq \omega_i \leq \omega_{\max}\). When the controller demands more than available, the <strong>mixer</strong> must prioritize:</p>
    <div class="info-box">
        <h4 style="margin-top:0;">Saturation Handling Strategies</h4>
        <ul>
            <li><strong>Clipping:</strong> Simply clamp each motor. Distorts the desired torque ratios.</li>
            <li><strong>Scaling:</strong> Scale all motor commands proportionally to keep within limits while preserving torque direction.</li>
            <li><strong>Priority:</strong> Prioritize attitude control over thrust (safer: maintain stability even if altitude drops).</li>
        </ul>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=600&h=280&fit=crop" alt="Brushless motor and ESC for drone propulsion">
        <p class="image-caption">Figure 15.1 &mdash; Brushless motor, ESC, and propeller form the actuator subsystem</p>
    </div>

    <div class="activity-box">
        <h3>Activity 3: Motor Response Characterization</h3>
        <p><strong>Objective:</strong> Measure and model the motor/propeller system.</p>
        <ol>
            <li>In the provided simulation, command a step change from 50% to 80% throttle.</li>
            <li>Log the actual motor speed over time. Fit a first-order model to extract \(\tau_m\).</li>
            <li>Vary the step size. Does \(\tau_m\) change? (It may due to nonlinearities.)</li>
            <li>Simulate your PID controller with and without the motor model. Compare performance.</li>
        </ol>
    </div>
</div>

<!-- PAGE 16: Simulation -->
<div class="page">
    <h2>Numerical Simulation</h2>
    <p>Before deploying controllers on real hardware, we simulate the full 6-DOF dynamics numerically. A proper simulation loop integrates the equations of motion at each time step.</p>

    <h3>Runge-Kutta 4th Order (RK4) Integration</h3>
    <p>For a system \(\dot{\mathbf{x}} = f(\mathbf{x}, \mathbf{u})\) with time step \(h\):</p>
    <div class="math">
        \[
        \begin{aligned}
        \mathbf{k}_1 &= f(\mathbf{x}_n, \mathbf{u}_n) \\
        \mathbf{k}_2 &= f(\mathbf{x}_n + \tfrac{h}{2}\mathbf{k}_1, \mathbf{u}_n) \\
        \mathbf{k}_3 &= f(\mathbf{x}_n + \tfrac{h}{2}\mathbf{k}_2, \mathbf{u}_n) \\
        \mathbf{k}_4 &= f(\mathbf{x}_n + h\mathbf{k}_3, \mathbf{u}_n) \\
        \mathbf{x}_{n+1} &= \mathbf{x}_n + \tfrac{h}{6}(\mathbf{k}_1 + 2\mathbf{k}_2 + 2\mathbf{k}_3 + \mathbf{k}_4)
        \end{aligned}
        \]
    </div>
    <p><strong>where:</strong></p>
    <ul>
        <li>\( \mathbf{x}_n \) — state vector at time step \(n\)</li>
        <li>\( \mathbf{u}_n \) — control input at time step \(n\)</li>
        <li>\( h \) — integration time step</li>
        <li>\( \mathbf{k}_1, \ldots, \mathbf{k}_4 \) — intermediate slope estimates</li>
        <li>\( f(\mathbf{x}, \mathbf{u}) \) — system dynamics function (returns \(\dot{\mathbf{x}}\))</li>
    </ul>

    <h3>Simulation Loop Architecture</h3>
    <div class="diagram">
        <div class="flow-step">Initialize state x, set gains, define dt</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Read sensors (add noise to true state)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Run state estimator (complementary filter)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Compute control outputs (cascaded PID)</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Apply mixing matrix, clamp motor speeds</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Integrate dynamics (RK4) to get next state</div>
        <div class="arrow">&darr;</div>
        <div class="flow-step">Log data, repeat until t_end</div>
    </div>

    <h3>Python Simulation Example</h3>
    <pre>
import numpy as np

def quadrotor_derivatives(state, u, params):
    """Compute state derivatives for 6-DOF quadrotor."""
    x, y, z, vx, vy, vz, phi, theta, psi, p, q, r = state
    T, tau_x, tau_y, tau_z = u
    m, g, Ixx, Iyy, Izz = (params['m'], params['g'],
        params['Ixx'], params['Iyy'], params['Izz'])

    # Rotation matrix elements (body Z to world)
    cphi, sphi = np.cos(phi), np.sin(phi)
    cth, sth = np.cos(theta), np.sin(theta)
    cpsi, spsi = np.cos(psi), np.sin(psi)

    # Translational dynamics
    ax = (cphi*sth*cpsi + sphi*spsi) * T / m
    ay = (cphi*sth*spsi - sphi*cpsi) * T / m
    az = -g + (cphi*cth) * T / m

    # Attitude kinematics
    dphi = p + (sphi*sth/cth)*q + (cphi*sth/cth)*r
    dtheta = cphi*q - sphi*r
    dpsi = (sphi/cth)*q + (cphi/cth)*r

    # Rotational dynamics
    dp = (tau_x - (Izz - Iyy)*q*r) / Ixx
    dq = (tau_y - (Ixx - Izz)*p*r) / Iyy
    dr = (tau_z - (Iyy - Ixx)*p*q) / Izz

    return np.array([vx, vy, vz, ax, ay, az,
                     dphi, dtheta, dpsi, dp, dq, dr])

def rk4_step(state, u, params, dt):
    """Single RK4 integration step."""
    k1 = quadrotor_derivatives(state, u, params)
    k2 = quadrotor_derivatives(state + 0.5*dt*k1, u, params)
    k3 = quadrotor_derivatives(state + 0.5*dt*k2, u, params)
    k4 = quadrotor_derivatives(state + dt*k3, u, params)
    return state + (dt/6.0)*(k1 + 2*k2 + 2*k3 + k4)
    </pre>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1555949963-aa79dcee981c?w=600&h=250&fit=crop" alt="Code and simulation environment on a computer screen">
        <p class="image-caption">Figure 16.1 &mdash; Simulation-first development: validate controllers before real flight</p>
    </div>
</div>

<!-- PAGE 17: Common Platforms -->
<div class="page">
    <h2>Common Quadrotor Platforms &amp; Flight Controllers</h2>

    <h3>Research and Commercial Platforms</h3>
    <div class="two-column">
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1579829366248-204fe8413f31?w=400&h=250&fit=crop" alt="DJI Matrice series enterprise drone">
                <p class="image-caption">Figure 17.1 &mdash; Enterprise-grade drone platform</p>
            </div>
        </div>
        <div>
            <div class="image-container">
                <img src="https://images.unsplash.com/photo-1473968512647-3e447244af8f?w=400&h=250&fit=crop" alt="Custom-built research quadrotor">
                <p class="image-caption">Figure 17.2 &mdash; Custom research quadrotor build</p>
            </div>
        </div>
    </div>

    <table>
        <tr><th>Platform</th><th>Type</th><th>Weight</th><th>Flight Time</th><th>Use Case</th></tr>
        <tr><td>DJI Matrice 300</td><td>Commercial</td><td>6.3 kg</td><td>55 min</td><td>Inspection, mapping</td></tr>
        <tr><td>Holybro X500 V2</td><td>Dev kit</td><td>1.1 kg</td><td>18 min</td><td>PX4 development</td></tr>
        <tr><td>Crazyflie 2.1</td><td>Nano</td><td>27 g</td><td>7 min</td><td>Indoor research, swarms</td></tr>
        <tr><td>Custom 450</td><td>DIY</td><td>~1.5 kg</td><td>15-25 min</td><td>Education, custom payloads</td></tr>
        <tr><td>Intel Aero RTF</td><td>Dev kit</td><td>1.5 kg</td><td>18 min</td><td>RealSense integration</td></tr>
    </table>

    <h3>Flight Controller Hardware</h3>
    <div class="three-column">
        <div class="sensor-card">
            <h4>Pixhawk 6X</h4>
            <p>Triple-redundant IMU, STM32H7 processor, CAN bus. Runs PX4 or ArduPilot. Industry standard for research.</p>
        </div>
        <div class="sensor-card">
            <h4>CubePilot Cube Orange+</h4>
            <p>Vibration-isolated IMUs, heated sensors, modular carrier boards. Premium reliability.</p>
        </div>
        <div class="sensor-card">
            <h4>BetaFlight F7</h4>
            <p>High-rate gyro sampling (8 kHz), optimized for FPV racing. Runs BetaFlight firmware.</p>
        </div>
    </div>

    <h3>Flight Software Stacks</h3>
    <div class="two-column">
        <div class="info-box">
            <h4 style="margin-top:0;">PX4 Autopilot</h4>
            <ul>
                <li>Open-source, BSD licensed</li>
                <li>Native ROS 2 interface via <code>px4_ros_com</code></li>
                <li>uORB middleware, EKF2 estimator</li>
                <li>Used by Auterion, many research labs</li>
            </ul>
        </div>
        <div class="info-box">
            <h4 style="margin-top:0;">ArduPilot</h4>
            <ul>
                <li>Open-source, GPLv3</li>
                <li>MAVLink + MAVROS for ROS 2</li>
                <li>Supports copter, plane, rover, sub</li>
                <li>Large community, extensive documentation</li>
            </ul>
        </div>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1517420704952-d9f39e95b43e?w=600&h=250&fit=crop" alt="Drone electronics and flight controller components">
        <p class="image-caption">Figure 17.3 &mdash; Flight controller, ESCs, GPS, and telemetry modules form the avionics stack</p>
    </div>
</div>

<!-- PAGE 18: Safety & Regulations -->
<div class="page">
    <h2>Safety &amp; Regulations</h2>

    <h3>UK CAA Regulations</h3>
    <div class="warning-box">
        <h4 style="margin-top:0;">Key UK Rules (as of 2025)</h4>
        <ul>
            <li><strong>Registration:</strong> All drones 250 g+ must be registered with the CAA. Operator ID displayed on drone.</li>
            <li><strong>Flyer ID:</strong> Pass a theory test for drones with cameras or 250 g+.</li>
            <li><strong>Open Category:</strong> A1/A2/A3 subcategories based on weight and proximity to people.</li>
            <li><strong>Maximum altitude:</strong> 120 m (400 ft) above ground level.</li>
            <li><strong>Flight Restriction Zones (FRZs):</strong> No flying near airports without permission.</li>
            <li><strong>Visual Line of Sight (VLOS):</strong> Required unless specific BVLOS authorization obtained.</li>
        </ul>
    </div>

    <h3>EASA European Regulations</h3>
    <div class="info-box">
        <p>The European Union Aviation Safety Agency (EASA) defines three categories: <strong>Open</strong> (low risk, no authorization), <strong>Specific</strong> (medium risk, requires operational authorization), and <strong>Certified</strong> (high risk, requires type certification). UK regulations are aligned but diverging post-Brexit.</p>
    </div>

    <h3>Fail-Safe Mechanisms</h3>
    <table>
        <tr><th>Fail-Safe</th><th>Trigger</th><th>Action</th></tr>
        <tr><td>Low Battery</td><td>Voltage below threshold</td><td>Return to launch (RTL) or land</td></tr>
        <tr><td>RC Signal Loss</td><td>No RC input for N seconds</td><td>Configurable: hover, RTL, or land</td></tr>
        <tr><td>GPS Loss</td><td>HDOP > threshold or fix lost</td><td>Switch to altitude hold / land</td></tr>
        <tr><td>Geofence Breach</td><td>Position exceeds boundary</td><td>RTL, land, or warning</td></tr>
        <tr><td>Motor Failure</td><td>ESC error / desync detected</td><td>Emergency land (if possible)</td></tr>
        <tr><td>Data Link Loss</td><td>No GCS heartbeat</td><td>Continue mission / RTL</td></tr>
    </table>

    <div class="warning-box">
        <strong>Always Perform Pre-Flight Checks:</strong>
        <ul>
            <li>Battery fully charged and secured; check voltage under load</li>
            <li>Propellers undamaged, correctly mounted (CW/CCW), secured with lock nuts</li>
            <li>GPS fix acquired (minimum 8 satellites, HDOP &lt; 2.0)</li>
            <li>Compass calibrated if operating at new location</li>
            <li>Fail-safes configured and tested</li>
            <li>Kill switch functional and easily accessible</li>
            <li>Weather: wind &lt; 15 km/h for small drones; no rain</li>
        </ul>
    </div>

    <div class="activity-box">
        <h3>Activity 4: Pre-Flight Checklist &amp; Risk Assessment</h3>
        <p><strong>Objective:</strong> Develop a comprehensive pre-flight checklist and risk assessment for a university campus test flight.</p>
        <ol>
            <li>Identify a suitable outdoor test area on campus. Note nearby buildings, people, and airspace restrictions.</li>
            <li>Create a pre-flight checklist covering hardware, software, environmental, and regulatory items.</li>
            <li>Write a brief risk assessment identifying at least 5 hazards and their mitigations.</li>
            <li>Define emergency procedures for motor failure, flyaway, and low battery.</li>
        </ol>
        <p><strong>Deliverable:</strong> Completed checklist document and risk assessment table.</p>
    </div>

    <div class="image-container">
        <img src="https://images.unsplash.com/photo-1533309907656-7b1c2ee56ddf?w=600&h=280&fit=crop" alt="Drone pilot performing pre-flight safety checks">
        <p class="image-caption">Figure 18.1 &mdash; Thorough pre-flight inspection is essential for safe drone operations</p>
    </div>
</div>

<!-- PAGE 19: Summary & Lab Preview -->
<div class="page">
    <h2>Week 6 Summary</h2>

    <div class="info-box">
        <h3 style="color: #667eea; margin-top: 0;">Key Concepts Covered</h3>
        <ul>
            <li>Quadrotor frame configurations (+, X, H) and motor direction conventions</li>
            <li>Body (FRD/FLU), world (NED/ENU), and camera coordinate frames</li>
            <li>Euler angles (ZYX) and quaternion representations for attitude</li>
            <li>Newton-Euler equations: translational (\(F=ma\)) and rotational (\(\tau = I\dot\omega + \omega \times I\omega\))</li>
            <li>Motor mixing matrix: wrench = M * [omega_i^2]</li>
            <li>Linearization about hover and small-angle approximation</li>
            <li>Cascaded PID control: position - velocity - attitude - rate</li>
            <li>Complementary, Madgwick, and Mahony filters for state estimation</li>
            <li>Motor dynamics, actuator saturation, and priority-based mixing</li>
            <li>Safety regulations (UK CAA, EASA) and fail-safe mechanisms</li>
        </ul>
    </div>

    <h3>Key Equations Reference Card</h3>
    <div class="diagram">
        <div class="two-column">
            <div>
                <h4>Thrust &amp; Torque</h4>
                <div class="math">\[ T_i = k_T \omega_i^2, \quad Q_i = k_Q \omega_i^2 \]</div>
                <h4>Translational Dynamics</h4>
                <div class="math">\[ m\ddot{\mathbf{p}} = -mg\hat{z} + R \cdot T\hat{z}_b \]</div>
                <h4>PID Controller</h4>
                <div class="math">\[ u = K_p e + K_i \int e \, dt + K_d \dot{e} \]</div>
            </div>
            <div>
                <h4>Rotational Dynamics</h4>
                <div class="math">\[ I\dot\omega = \tau - \omega \times I\omega \]</div>
                <h4>Complementary Filter</h4>
                <div class="math">\[ \hat\phi = \alpha(\hat\phi + \dot\phi_{g} \Delta t) + (1-\alpha)\phi_a \]</div>
                <h4>Motor Model</h4>
                <div class="math">\[ \dot\omega_i = (\omega_i^{cmd} - \omega_i)/\tau_m \]</div>
            </div>
        </div>
    </div>

    <h3>Lab Preview: Week 6 Lab (7 Tasks)</h3>
    <div class="checklist">
        <ul>
            <li>Task 1: Implement the motor mixing matrix for an X-frame quadrotor</li>
            <li>Task 2: Code the full 6-DOF dynamics function in Python</li>
            <li>Task 3: Simulate open-loop hover (set thrust = mg, observe instability)</li>
            <li>Task 4: Implement PID rate controller for roll, pitch, and yaw</li>
            <li>Task 5: Add outer-loop angle PID and achieve stable hover</li>
            <li>Task 6: Implement altitude hold controller</li>
            <li>Task 7: Add position control and fly a square waypoint mission</li>
        </ul>
    </div>

    <h3>Interview-Style Questions</h3>
    <ol>
        <li><strong>Q:</strong> Why do adjacent quadrotor motors spin in opposite directions?<br>
            <em>A: To cancel net yaw torque during hover. Differential speed of CW vs. CCW pairs enables yaw control.</em></li>
        <li><strong>Q:</strong> What is gimbal lock and how do quaternions avoid it?<br>
            <em>A: At pitch = +/-90 degrees, roll and yaw axes align, losing a DOF. Quaternions use 4 parameters with no singularity.</em></li>
        <li><strong>Q:</strong> Why is the inner rate loop tuned before the outer angle loop?<br>
            <em>A: The inner loop must be fast and stable first; the outer loop sees it as a "plant" and is designed around its closed-loop response.</em></li>
        <li><strong>Q:</strong> Why does a quadrotor need to tilt to translate horizontally?<br>
            <em>A: Thrust is fixed along the body Z-axis. Tilting redirects a component of thrust horizontally while maintaining vertical lift.</em></li>
        <li><strong>Q:</strong> What happens if integrator wind-up occurs in a PID controller?<br>
            <em>A: Accumulated integral error causes large overshoot and slow recovery when the setpoint changes or saturation ends.</em></li>
    </ol>

    <div class="header" style="margin-top: 30px; padding: 20px;">
        <p style="font-size: 1.1em;">Next Week: ROS 2 Integration with PX4 &amp; Autonomous Navigation</p>
        <p style="opacity: 0.8;">Bridging simulation to real-world flight</p>
    </div>
</div>

</body>
</html>
